<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details • Liyog</title>
    <meta name="description" content="Explore product details, reviews, and offers on Liyog.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌿</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            --liyog-green: #28A428;
            --liyog-green-light: #34bf49;
            --liyog-green-dark: #228B22;
            --liyog-deep-green: #006400;
            --liyog-gold: #ffd700;
            --liyog-orange: #ff7a00;
            --font-stack: 'Inter', sans-serif;
        }
        body { 
            font-family: var(--font-stack); 
            background-color: #f8fafc;
            color: #1e293b; 
        }
        .shimmer::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, 
                rgba(255, 255, 255, 0) 0%, 
                rgba(255, 255, 255, 0.1) 20%, 
                rgba(255, 255, 255, 0.4) 60%, 
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 1.8s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Enhanced thumbnail active state */
        .thumb-active {
            outline: 3px solid var(--liyog-green);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(40, 164, 40, 0.3);
            transform: scale(1.05);
            transition: all 0.2s ease-out;
        }
        .tab-btn-active {
            color: var(--liyog-green-dark);
            font-weight: 700;
            border-color: var(--liyog-green);
        }
        .like-icon-filled {
            color: #ef4444; /* red-500 */
        }
        .responsive-iframe-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .responsive-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Styles for the innovative reviews section */
        .star-rating-input input[type="radio"] { display: none; }
        .star-rating-input label {
            cursor: pointer;
            font-size: 0;
            color: #e5e7eb;
            transition: color 0.2s ease-in-out;
            padding: 2px;
        }
        .star-rating-input label svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label { color: var(--liyog-gold); }
        .star-rating-input input[type="radio"]:checked ~ label { color: var(--liyog-gold); }
        .star-rating-input input[type="radio"]:checked + label { color: var(--liyog-gold); }
        .star-rating-input {
            direction: rtl;
            display: inline-flex;
        }
        .star-rating-input > label:hover,
        .star-rating-input > label:hover ~ label,
        .star-rating-input > input.selected ~ label,
        .star-rating-input > input:checked ~ label { color: var(--liyog-gold); }
        .star-rating-input label:hover svg,
        .star-rating-input label:hover ~ label svg,
        .star-rating-input input[type="radio"]:checked ~ label svg { fill: var(--liyog-gold); }
        .star-rating-input label:before {
            content: "\2605";
            font-size: 1.5rem;
            margin-left: 2px;
            visibility: hidden;
        }
        .star-rating-input label svg { visibility: visible; }

        /* Glittering effect for helpful count - Enhanced for visibility */
        .glittering-number {
            position: relative;
            display: inline-block;
            overflow: hidden;
            font-weight: bold; /* Make it bolder */
            color: var(--liyog-gold); /* Default color for better visibility */
        }
        .glittering-active {
            animation: glitter 1s ease-out forwards; /* Shorter, more punchy glitter */
        }
        @keyframes glitter {
            0% { transform: scale(1); opacity: 1; text-shadow: 0 0 5px var(--liyog-gold); }
            50% { transform: scale(1.2); opacity: 0.8; text-shadow: 0 0 15px var(--liyog-gold), 0 0 25px rgba(255,215,0,0.5); }
            100% { transform: scale(1); opacity: 1; text-shadow: none; }
        }

        /* Bar chart for ratings distribution */
        .rating-bar {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .rating-fill {
            height: 100%;
            background-color: var(--liyog-green-light);
            border-radius: 5px;
            transition: width 0.3s ease-out;
        }
        .rating-bar-value {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: transparent;
            width: 100%;
            cursor: pointer;
        }
        .rating-bar-value:hover .rating-fill { background-color: var(--liyog-green-dark); }
        .rating-bar-wrapper.active .rating-fill { background-color: var(--liyog-deep-green); }
        
        /* Dynamic Avatar */
        .avatar-initials {
            background-color: var(--liyog-green-light);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-radius: 9999px;
        }

        /* Skeleton Loader Enhancements */
        .skeleton-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .skeleton-media-item {
            width: 80px;
            height: 80px;
            background-color: #e2e8f0; /* gray-200 */
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .skeleton-main-media {
            aspect-square w-full bg-gray-200 rounded-lg h-full relative overflow-hidden;
        }

        /* Chart text color for visibility */
        #ratings-distribution-chart .text-gray-200 {
            color: #d1d5db; /* A lighter gray for better contrast on dark green */
        }
        #ratings-distribution-chart .text-gray-800 {
            color: #f8fafc; /* White/very light for numbers on bars */
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); /* Add slight shadow for readability */
        }
        
        /* Added for review form error styling */
        .input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }

        /* Modal Styles (basic for now, can be enhanced with Tailwind) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }

/* Media Gallery Arrows */
        .media-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .media-arrow:hover { opacity: 1; }
        .media-arrow.left { left: 0.5rem; }
        .media-arrow.right { right: 0.5rem; }
        .media-arrow svg { width: 1.5rem; height: 1.5rem; }

        
        /* Two-row thumbnails */
        #thumbnails-wrapper.two-rows {
            display: grid;
            grid-auto-flow: column; /* Allows horizontal scrolling with variable columns */
            grid-template-rows: repeat(2, minmax(0, 1fr)); /* Two rows */
            grid-auto-columns: 80px; /* Each thumbnail takes 80px width */
            gap: 0.75rem; /* gap-3 */
            overflow-x: auto;
            padding-bottom: 0.5rem; /* pb-2 */
            scroll-snap-type: x mandatory; /* Optional: for smoother scrolling */
            scroll-padding: 0.5rem;
        }
        #thumbnails-wrapper.two-rows .thumbnail-btn {
            scroll-snap-align: start;
            margin-bottom: 0; /* Remove default margin-bottom from flex */
        }

/* Ensure gallery section is a positioned container so absolutely positioned arrows sit over it */
#media-gallery {
  position: relative; /* <-- essential for gallery arrows to be positioned over gallery */
}

/* Make global gallery arrow visuals consistent and tappable */
#gallery-prev, #gallery-next {
  z-index: 40; /* ensure above most elements */
  pointer-events: auto;
  transition: transform 0.18s ease, opacity 0.25s ease;
  opacity: 0.9;
  backdrop-filter: blur(4px);
}

/* subtle hover/idle micro-animation */
#gallery-prev:hover, #gallery-next:hover {
  transform: translateY(-50%) scale(1.06);
  opacity: 1;
}

/* Make sure arrows are nicely sized and easy to tap on mobile */
#gallery-prev, #gallery-next {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 9999px;
}

/* Optional: fade out arrows when not needed (controlled by JS too) */
#gallery-prev.opacity-0, #gallery-next.opacity-0 {
  opacity: 0;
  pointer-events: none;
}

/* >>> ADD FOR PRODUCT GALLERY IMPROVEMENTS <<< */

/* ensure main media covers area elegantly without distortion */
#main-media-viewer img,
#main-media-viewer video,
#main-media-viewer iframe {
  width: 100%;
  height: 100%;
  object-fit: contain; /* preserve aspect ratio and avoid distortion */
}



/* video play overlay for thumbnails */
.thumbnail-btn { position: relative; }
.thumbnail-btn .video-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.32);
  opacity: 0;
  transition: opacity .18s ease;
  border-radius: 0.5rem;
}
.thumbnail-btn:hover .video-overlay,
.thumbnail-btn.active .video-overlay {
  opacity: 1;
}

/* make arrows more tappable on mobile */
.media-arrow { width: 44px; height: 44px; padding: 0.4rem; }

/* small improvement for very long product names */
#product-name {
  word-break: break-word;
  overflow-wrap: anywhere;
  hyphens: auto;
}

/* Gallery Item Counter Overlay */
#media-counter {
  z-index: 15;
}


/* --- NEW: Instruction icon motion --- */
@keyframes bounce-left-right {
  0%, 100% { transform: translateX(0); }
  50% { transform: translateX(4px); }
}
.animate-bounce-left-right {
  animation: bounce-left-right 2s infinite ease-in-out;
}


/* --- FIX: Prevent page scroll during swipe --- */
.media-gallery {
  display: flex;
  overflow-x: auto;
  overscroll-behavior-x: contain; /* isolate swipe motion */
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}
body, html {
  overscroll-behavior-y: contain; /* Prevent page bounce/scroll during swipe */
}
#main-media-viewer {
  touch-action: pan-y; /* Allow vertical scrolls only, block unintended X drags */
overscroll-behavior: contain;
}

/* --- MULTILAYER VIDEO ICON STYLE --- */
@keyframes border-glow {
  0%, 100% {
    box-shadow:
      0 0 8px #00ff88,
      0 0 16px #00aaff,
      0 0 24px #ffaa00,
      0 0 32px #00ff88;
  }
  50% {
    box-shadow:
      0 0 16px #ffaa00,
      0 0 32px #00ff88,
      0 0 48px #00aaff,
      0 0 64px #ffaa00;
  }
}
.animate-border-glow {
  animation: border-glow 3s infinite alternate ease-in-out;
}

/* --- CLICK FIRE / PREMIUM GLOW EFFECT --- */
@keyframes video-btn-fire {
  0% {
    box-shadow:
      0 0 5px rgba(255, 0, 0, 0.6),
      0 0 10px rgba(255, 165, 0, 0.6),
      0 0 15px rgba(255, 255, 0, 0.6);
  }
  50% {
    box-shadow:
      0 0 15px rgba(255, 0, 0, 0.9),
      0 0 30px rgba(255, 165, 0, 0.9),
      0 0 45px rgba(255, 255, 0, 0.9),
      0 0 60px rgba(255, 255, 255, 1);
  }
  100% {
    box-shadow:
      0 0 5px rgba(255, 0, 0, 0.6),
      0 0 10px rgba(255, 165, 0, 0.6),
      0 0 20px rgba(255, 255, 0, 0.6);
  }
}

.video-btn-fire {
  animation: video-btn-fire 1.5s ease-out;
}

/* === VIDEO FULLSCREEN MODE STYLES === */
.video-fullscreen-active {
  position: fixed !important;
  inset: 0;
  width: 100vw !important;
  height: 100vh !important;
  background-color: black;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.video-fullscreen-active video {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Hide scrollbars and isolate fullscreen mode */
body:has(.video-fullscreen-active) {
  overflow: hidden;
}

</style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        liyog: {
                            green: 'var(--liyog-green)',
                            'green-light': 'var(--liyog-green-light)',
                            'green-dark': 'var(--liyog-green-dark)',
                            'deep-green': 'var(--liyog-deep-green)',
                            gold: 'var(--liyog-gold)',
                            orange: 'var(--liyog-orange)',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>

<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="products.html" class="text-gray-600 hover:text-liyog-green transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </a>
                <a href="/" class="text-2xl font-extrabold text-liyog-green">Liyog</a>
                <a href="/cart/" class="relative text-gray-600 hover:text-liyog-green transition-colors">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count" class="absolute -top-1 -right-2 bg-liyog-orange text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                </a>
            </div>
        </nav>
    </header>

    <main id="main-content" class="max-w-screen-xl mx-auto py-6 sm:py-10 px-4 sm:px-6 lg:px-8">
        <div id="skeleton-loader">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                <div class="relative overflow-hidden">
                    <div class="aspect-square w-full bg-gray-200 rounded-lg shimmer"></div>
                    <div class="skeleton-media-grid">
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer hidden sm:block"></div>
                        <div class="skeleton-media-item shimmer hidden lg:block"></div>
                        <div class="skeleton-media-item shimmer hidden sm:block"></div>
                        <div class="skeleton-media-item shimmer hidden lg:block"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                    <div class="h-10 bg-gray-200 rounded w-full shimmer"></div>
                    <div class="h-10 bg-gray-200 rounded w-5/6 shimmer"></div>
                    <div class="flex items-center gap-4">
                        <div class="h-5 bg-gray-200 rounded w-1/3 shimmer"></div>
                        <div class="h-5 bg-gray-200 rounded w-1/4 shimmer"></div>
                    </div>
                    <div class="flex gap-3 mt-4 hide-scrollbar overflow-x-auto pb-2">
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-20 shimmer"></div>
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-24 shimmer"></div>
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-16 shimmer"></div>
                    </div>
                    <div class="my-6 bg-gray-100 p-4 rounded-lg border h-24 shimmer"></div>
                    <div class="h-14 bg-gray-200 rounded-lg w-full shimmer"></div>
                    <div class="h-14 bg-gray-200 rounded-lg w-full shimmer"></div>
                    <div class="flex items-center gap-4 mt-6">
                        <div class="h-8 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-8 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-8 bg-gray-200 rounded w-20 ml-auto shimmer"></div>
                    </div>
                </div>
            </div>
            <div class="mt-16 bg-white p-6 rounded-lg border">
                <div class="border-b border-gray-200 pb-4 mb-4">
                    <div class="-mb-px flex space-x-8">
                        <div class="h-6 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-6 bg-gray-200 rounded w-24 shimmer"></div>
                    </div>
                </div>
                <div class="py-6 space-y-3">
                    <div class="h-4 bg-gray-200 rounded w-full shimmer"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6 shimmer"></div>
                    <div class="h-4 bg-gray-200 rounded w-full shimmer"></div>
                    <div class="h-4 bg-gray-200 rounded w-4/5 shimmer"></div>
                </div>
            </div>
            <div class="mt-16">
                <div class="h-8 bg-gray-200 rounded w-1/3 mb-6 shimmer"></div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden md:block"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden lg:block"></div>
                </div>
            </div>
             <div class="mt-16">
                <div class="h-8 bg-gray-200 rounded w-1/3 mb-6 shimmer"></div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden md:block"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden lg:block"></div>
                </div>
            </div>
        </div>

        <div id="product-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16">
                <section id="media-gallery" class="w-full">

<!-- --- NEW: Navigation Arrows --- -->
<button id="gallery-prev" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white p-2 rounded-full z-20 transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
</button>
<button id="gallery-next" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white p-2 rounded-full z-20 transition">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
</button>

                    <div id="main-media-viewer" class="relative w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border mb-4 shadow-lg">
                        <button id="media-prev" class="media-arrow left-0.5 transform -translate-y-1/2 rounded-full p-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <button id="media-next" class="media-arrow right-0.5 transform -translate-y-1/2 rounded-full p-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                        </button>
                    </div>
                    <div id="thumbnails-container" class="w-full hide-scrollbar overflow-x-auto">
                        <div id="thumbnails-wrapper" class="flex gap-3 pb-2">
                        </div>
                    </div>
<!-- --- NEW: Instructional message --- -->
<div class="text-center mt-2 text-xs text-gray-500 flex items-center justify-center gap-1 select-none animate-pulse">

  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-liyog-green animate-bounce-left-right" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7"/></svg>
  Scroll / Swipe left & right to view media or use arrows
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-liyog-green animate-bounce-left-right" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7-7 7"/></svg>
</div>
          </section>
                
                <section id="product-details" class="flex flex-col">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                        <div>
                            <div id="product-category" class="text-sm font-semibold text-liyog-green mb-1"></div>
                            <h1 id="product-name" class="text-3xl lg:text-4xl font-extrabold text-gray-900 leading-tight"></h1>
                        </div>
                        <!-- ADD: product created / updated timestamps -->
<div id="product-dates" class="product-timestamps text-gray-500 text-sm mt-2" aria-live="polite"></div>

                        
                        <div id="stock-badge" class="mt-2 sm:mt-0 text-xs font-bold px-3 py-1.5 rounded-full whitespace-nowrap self-start"></div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-3 text-sm">
                        <div id="star-rating" class="flex items-center gap-1"></div>
                        <a href="#reviews-section-start" class="font-bold text-gray-800 hover:text-liyog-green-dark hover:underline transition-colors" aria-label="View all reviews"><span id="avg-rating">0.0</span> (<span id="total-reviews">0</span> Reviews)</a>
                        <span class="text-gray-300 hidden sm:block">|</span>
                        <div class="flex items-center gap-1.5 mt-2 sm:mt-0">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span id="total-orders" class="font-semibold text-gray-600">0</span> <span class="text-gray-500">sold</span>
                        </div>
                    </div>

                    <div id="tags-container" class="mt-4 flex items-center gap-2 overflow-x-auto hide-scrollbar pb-2">
                    </div>

                    <div class="my-6 bg-gray-50 p-4 rounded-lg border shadow-sm">
                        <div class="flex items-baseline gap-3 flex-wrap">
                            <span id="final-price" class="text-3xl sm:text-4xl font-extrabold text-liyog-green-dark"></span>
                            <span id="original-price" class="text-base sm:text-xl line-through text-gray-400"></span>
                            <span id="discount-percent" class="text-sm font-semibold text-red-600 ml-2" style="display: none;"></span>
                        </div>
                        <div class="flex items-center justify-between mt-2 text-sm text-gray-700 font-semibold">
                            <div id="carton-info">
                                <span id="carton-quantity"></span> <span id="carton-price"></span>
                            </div>
                            <div id="lxc-banner" class="text-amber-700">
                                Earn <span id="liyogx-coins">0</span> LiyogX Coins (worth ₦<span id="liyogx-value">0.00</span>)
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                        <span class="text-gray-500">Added by:</span>
                        <div id="added-by-user" class="flex items-center gap-1.5">
                            <div id="added-by-avatar" class="w-6 h-6 rounded-full overflow-hidden bg-gray-200 flex-shrink-0 flex items-center justify-center text-xs font-bold text-white"></div>
                            <span id="added-by-name" class="font-semibold text-gray-800"></span>
                        </div>
                    </div>

                    <div class="mt-auto pt-6 border-t space-y-4">
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
                            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden flex-shrink-0">
                                <button id="qty-decrement" class="px-4 py-3 text-lg font-bold hover:bg-gray-100 transition-colors rounded-l-lg" aria-label="Decrease quantity">−</button>
                                <input id="quantity-input" type="number" value="1" min="1" class="w-16 text-center py-3 border-l border-r border-gray-300 font-bold text-lg focus:outline-none focus:ring-1 focus:ring-liyog-green" aria-label="Product quantity">
                                <button id="qty-increment" class="px-4 py-3 text-lg font-bold hover:bg-gray-100 transition-colors rounded-r-lg" aria-label="Increase quantity">+</button>
                            </div>
                            <button id="add-to-cart-btn" class="flex-1 text-center font-bold text-lg text-white bg-liyog-green hover:bg-liyog-green-dark rounded-lg py-3 transition-colors shadow-md" aria-label="Add to cart">Add to Cart</button>
                        </div>
                        <button id="order-now-btn" class="w-full text-center font-bold text-lg text-white bg-liyog-orange hover:bg-orange-600 rounded-lg py-3 transition-colors shadow-md" aria-label="Order now">Order Now</button>
                    </div>

                    <div class="mt-6 flex items-center justify-between text-sm">
                        <div class="flex items-center gap-4">
                             <button id="like-btn" class="flex items-center gap-2 text-gray-600 hover:text-red-500 transition-colors group" aria-label="Like product">
                                <svg id="like-icon" class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                                <span id="total-likes" class="font-semibold">0</span>
                            </button>
                            <button id="share-btn" class="flex items-center gap-2 text-gray-600 hover:text-liyog-green transition-colors group" aria-label="Share product">
                                <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                                <span>Share</span>
                            </button>
                             <button id="copy-url-btn" class="flex items-center gap-2 text-gray-600 hover:text-liyog-green transition-colors group" aria-label="Copy product URL">
                                <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.79 4.79a4.5 4.5 0 01-6.364-6.364l1.242-1.242m5.011-5.01a4.5 4.5 0 017.006 3.96m-5.01 5.01a4.5 4.5 0 00-7.006-3.96l-1.242 1.242"></path></svg>
                                <span>Copy URL</span>
                            </button>
                        </div>
                        <div class="text-gray-500">
                            Views: <span id="total-views" class="font-semibold text-gray-700">0</span>
                        </div>
                    </div>
                </section>
            </div>

            <section id="tabs-section" class="mt-16 bg-white p-6 rounded-lg border shadow-sm">
                 <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8" aria-label="Tabs">
                        <button data-tab="description" class="tab-btn tab-btn-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm sm:text-base" aria-controls="tab-content-description" role="tab" aria-selected="true">Description</button>
                        <button data-tab="reviews" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm sm:text-base" aria-controls="tab-content-reviews" role="tab" aria-selected="false">Reviews</button>
                    </nav>
                </div>
                <div class="py-6">
                    <div id="tab-content-description" class="tab-content prose max-w-none text-gray-600 text-sm sm:text-base leading-relaxed" role="tabpanel" aria-labelledby="description-tab"></div>
                    <div id="tab-content-reviews" class="tab-content hidden" role="tabpanel" aria-labelledby="reviews-tab">
                        <a id="reviews-section-start" class="sr-only" tabindex="-1">Reviews Section Anchor</a>
                        <div id="reviews-dashboard" class="mb-8 p-4 sm:p-6 bg-liyog-deep-green text-white rounded-lg shadow-inner">
                            <h3 class="text-2xl font-bold mb-4 text-center">Customer Reviews</h3>
                            <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                                <div class="flex items-center gap-2 text-3xl font-extrabold flex-shrink-0">
                                    <span id="overall-avg-rating">0.0</span> / 5
                                    <div id="overall-star-rating" class="flex items-center" role="img" aria-label="Overall average rating"></div>
                                </div>
                                <div class="text-sm text-gray-200 text-center md:text-left">Based on <span id="overall-total-reviews-count">0</span> reviews</div>
                            </div>

                            <div id="ratings-distribution-chart" class="space-y-3" role="group" aria-label="Rating distribution chart">
                            </div>
                            <div class="flex flex-wrap gap-2 mt-6 justify-center">
                                <button data-rating-filter="0" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-liyog-green text-white hover:bg-liyog-green-dark transition-colors active" aria-pressed="true">All Reviews</button>
                                <button data-rating-filter="5" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">5 Stars</button>
                                <button data-rating-filter="4" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">4 Stars</button>
                                <button data-rating-filter="3" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">3 Stars</button>
                                <button data-rating-filter="2" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">2 Stars</button>
                                <button data-rating-filter="1" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">1 Star</button>
                            </div>
                        </div>

                        <div id="login-to-review-message" class="mb-8 p-4 sm:p-6 bg-white rounded-lg shadow-md border text-center text-gray-700 font-semibold" style="display: none;">
                            <p class="mb-4">Log in to share your review and help other shoppers!</p>
                            <a href="/login.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                                Log In
                            </a>
                        </div>

                        <div id="add-review-form-section" class="mb-8 p-4 sm:p-6 bg-white rounded-lg shadow-md border" style="display: none;">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Add Your Review</h3>
                            <form id="review-form" class="space-y-4" aria-label="Review submission form">
                                <div class="flex items-center gap-3">
                                    <div id="user-avatar-review-form" class="w-10 h-10 rounded-full overflow-hidden bg-liyog-green-light flex-shrink-0 flex items-center justify-center text-white text-lg font-bold" aria-hidden="true">
                                    </div>
                                    <span id="current-user-name-review-form" class="font-semibold text-gray-800"></span>
                                </div>
                                
                                <div>
                                    <label for="review-rating-5" class="block text-sm font-medium text-gray-700 mb-2">Your Rating: <span class="text-red-500">*</span></label>
                                    <div id="review-rating-input" class="star-rating-input flex justify-end" role="radiogroup" aria-required="true" aria-label="Your product rating">
                                    </div>
                                    <input type="hidden" name="rating" id="selected-rating" value="0" required aria-hidden="true">
                                    <p id="rating-error" class="error-message" style="display:none;">Please select a star rating.</p>
                                </div>
                                <div>
                                    <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2">Your Comment: <span class="text-red-500">*</span></label>
                                    <textarea id="review-comment" name="comment" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-liyog-green focus:ring-liyog-green sm:text-sm p-3" placeholder="Share your thoughts about this product..." required minlength="10" maxlength="500" aria-describedby="comment-error"></textarea>
                                    <p id="comment-error" class="error-message" style="display:none;">Comment must be between 10 and 500 characters.</p>
                                </div>
                                <button type="submit" id="submit-review-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-liyog-green hover:bg-liyog-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-liyog-green">Submit Review</button>
                            </form>
                        </div>
                        
                        <div id="reviews-list" class="space-y-6 pt-4" aria-live="polite" aria-atomic="true">
                            <p class="text-center text-gray-500 py-4" id="no-reviews-message" style="display: none;">No reviews yet. Be the first to share your experience!</p>
                             <div id="review-skeleton-loader" class="space-y-6" style="display: none;">
                                <div class="flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                                    <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                                    <div class="flex-1 space-y-2">
                                        <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                                        <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                                    </div>
                                </div>
                                <div class="flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                                    <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                                    <div class="flex-1 space-y-2">
                                        <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                                        <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="load-more-reviews-container" class="text-center mt-8 hidden">
                            <button id="load-more-reviews-btn" class="px-6 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors" aria-label="Load more reviews">Load More</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="related-products-section" class="mt-16 hidden">
                <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 mb-6">Related Products</h2>
                <div id="related-products-carousel" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </section>
            
            <section id="you-may-like-section" class="mt-16">
                <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 mb-6">You May Also Like</h2>
                <div id="you-may-like-carousel" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </section>
        </div>
    </main>

    <footer class="bg-white/80 backdrop-blur-lg mt-16 py-8 border-t">
        <div class="text-center text-sm text-gray-500">
            © <span id="footer-year"></span> Liyog. All Rights Reserved.
        </div>
    </footer>
    
    <div id="mobile-sticky-footer" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t p-3 flex items-center gap-3 z-40 shadow-2xl">
        <button id="mobile-add-to-cart-btn" class="flex-1 text-center font-bold text-liyog-green bg-green-100 hover:bg-green-200 rounded-lg py-3 transition-colors">Add to Cart</button>
        <button id="mobile-order-now-btn" class="flex-1 text-center font-bold text-white bg-liyog-orange hover:bg-orange-600 rounded-lg py-3 transition-colors">Order Now</button>
    </div>

    <div id="edit-review-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-review-title">
        <div class="modal-content">
            <h3 id="edit-review-title" class="text-xl font-bold text-gray-900 mb-4">Edit Your Review</h3>
            <form id="edit-review-form" class="space-y-4">
                <div>
                    <label for="edit-review-rating-5" class="block text-sm font-medium text-gray-700 mb-2">Your Rating:</label>
                    <div id="edit-review-rating-input" class="star-rating-input flex justify-end" role="radiogroup" aria-label="Edit product rating">
                    </div>
                    <input type="hidden" name="rating" id="edit-selected-rating" value="0" aria-hidden="true">
                    <p id="edit-rating-error" class="error-message" style="display:none;">Please select a star rating.</p>
                </div>
                <div>
                    <label for="edit-review-comment" class="block text-sm font-medium text-gray-700 mb-2">Your Comment:</label>
                    <textarea id="edit-review-comment" name="comment" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-liyog-green focus:ring-liyog-green sm:text-sm p-3" placeholder="Share your thoughts about this product..." required minlength="10" maxlength="500"></textarea>
                    <p id="edit-comment-error" class="error-message" style="display:none;">Comment must be between 10 and 500 characters.</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-review-btn" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">Cancel</button>
                    <button type="submit" id="save-edit-review-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-liyog-green hover:bg-liyog-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-liyog-green">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

<script type="module">
    window.addEventListener('error', e => {
  alert('Error: ' + e.message);
  console.error(e);
});
// ===================================================================
// CONFIG & INITIALIZATION
// ===================================================================
const SUPABASE_URL = "https://snwwlewjriuqrodpjhry.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNud3dsZXdqcml1cXJvZHBqaHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDY3MDAsImV4cCI6MjA2ODE4MjcwMH0.WxOmEHxLcEHmMKFjsgrzcb22mPs-sJwW_G3GOuXX2c8";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// ===================================================================
// CONSTANTS (NEW)
// ===================================================================
const REVIEW_MIN_LENGTH = 10;
const REVIEW_MAX_LENGTH = 500;
const TOAST_DURATION = 3000; // milliseconds

// ===================================================================
// STATE MANAGEMENT
// ===================================================================
let state = {
    product: null,
    currentUser: null,
    settings: { lxc_rate: 10 },
    reviews: [], // Stores all fetched reviews for the current product, unfiltered
    reviewsPage: 1,
    reviewsPerPage: 5,
    hasMoreReviews: true,
    isLiked: false,
    
    reviewsData: { // Processed review data for dashboard
        ratingCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        totalReviews: 0,
        avgRating: 0.0,
    },
    currentRatingFilter: 0, // 0 for all reviews, 1-5 for specific star ratings
    
    // NEW: Review like tracking for current user
    userLikedReviews: new Set(), // Stores review_ids that the current user has liked
    
    // Media Gallery State
    currentMediaIndex: 0,
    mediaItems: [],
};


// ===================================================================
// DOM ELEMENT SELECTORS
// ===================================================================
const DOMElements = {
    loader: document.getElementById('skeleton-loader'),
    content: document.getElementById('product-content'),
    mainMediaViewer: document.getElementById('main-media-viewer'),
    thumbnailsWrapper: document.getElementById('thumbnails-wrapper'),
    productCategory: document.getElementById('product-category'),
    productName: document.getElementById('product-name'),
    productDates: document.getElementById('product-dates'),
stockBadge: document.getElementById('stock-badge'),
    starRating: document.getElementById('star-rating'),
    avgRating: document.getElementById('avg-rating'),
    totalReviews: document.getElementById('total-reviews'),
    totalOrders: document.getElementById('total-orders'),
    tagsContainer: document.getElementById('tags-container'),
    finalPrice: document.getElementById('final-price'),
    originalPrice: document.getElementById('original-price'),
    discountPercent: document.getElementById('discount-percent'), // NEW
    cartonInfo: document.getElementById('carton-info'), // NEW
    cartonQuantity: document.getElementById('carton-quantity'), // NEW
    cartonPrice: document.getElementById('carton-price'), // NEW
    lxcBanner: document.getElementById('lxc-banner'),
    liyogxCoins: document.getElementById('liyogx-coins'),
    liyogxValue: document.getElementById('liyogx-value'),
    addedByUser: document.getElementById('added-by-user'), // NEW
    addedByAvatar: document.getElementById('added-by-avatar'), // NEW
    addedByName: document.getElementById('added-by-name'), // NEW
    quantityInput: document.getElementById('quantity-input'),
    qtyDecrement: document.getElementById('qty-decrement'),
    qtyIncrement: document.getElementById('qty-increment'),
    addToCartBtn: document.getElementById('add-to-cart-btn'),
    orderNowBtn: document.getElementById('order-now-btn'),
    likeBtn: document.getElementById('like-btn'),
    likeIcon: document.getElementById('like-icon'),
    totalLikes: document.getElementById('total-likes'),
    shareBtn: document.getElementById('share-btn'),
    copyUrlBtn: document.getElementById('copy-url-btn'), // NEW
    totalViews: document.getElementById('total-views'),
    // Tabs
    tabButtons: document.querySelectorAll('.tab-btn'),
    tabContents: document.querySelectorAll('.tab-content'),
    descriptionContent: document.getElementById('tab-content-description'),
    reviewsContent: document.getElementById('tab-content-reviews'),
    // Reviews Section
    reviewsDashboard: document.getElementById('reviews-dashboard'),
    overallAvgRating: document.getElementById('overall-avg-rating'),
    overallStarRating: document.getElementById('overall-star-rating'),
    overallTotalReviewsCount: document.getElementById('overall-total-reviews-count'),
    ratingsDistributionChart: document.getElementById('ratings-distribution-chart'),
    filterRatingBtns: document.querySelectorAll('.filter-rating-btn'),
    
    loginToReviewMessage: document.getElementById('login-to-review-message'), // NEW
    addReviewFormSection: document.getElementById('add-review-form-section'),
    reviewForm: document.getElementById('review-form'),
    userAvatarReviewForm: document.getElementById('user-avatar-review-form'),
    currentUserNameReviewForm: document.getElementById('current-user-name-review-form'),
    reviewRatingInput: document.getElementById('review-rating-input'),
    selectedRatingInput: document.getElementById('selected-rating'),
    reviewCommentInput: document.getElementById('review-comment'),
    submitReviewBtn: document.getElementById('submit-review-btn'),
    ratingError: document.getElementById('rating-error'), // NEW
    commentError: document.getElementById('comment-error'), // NEW

    reviewsList: document.getElementById('reviews-list'),
    noReviewsMessage: document.getElementById('no-reviews-message'),
    loadMoreReviewsContainer: document.getElementById('load-more-reviews-container'),
    loadMoreReviewsBtn: document.getElementById('load-more-reviews-btn'),

    // NEW Modal Elements
    allReviewsModal: document.getElementById('all-reviews-modal'),
    allReviewsModalContent: document.getElementById('all-reviews-modal-content'),
    modalReviewsList: document.getElementById('modal-reviews-list'),
    modalReviewSkeletonLoader: document.getElementById('modal-review-skeleton-loader'),
    modalNoReviewsMessage: document.getElementById('modal-no-reviews-message'),
    modalEndOfReviewsMessage: document.getElementById('modal-end-of-reviews-message'),
    modalOverallAvgRating: document.getElementById('modal-overall-avg-rating'),
    modalOverallStarRating: document.getElementById('modal-overall-star-rating'),
    modalOverallTotalReviewsCount: document.getElementById('modal-overall-total-reviews-count'),
    modalRatingsDistributionChart: document.getElementById('modal-ratings-distribution-chart'),
    modalReviewsListWrapper: document.getElementById('modal-reviews-list-wrapper'), // For scroll event
    
    reviewSkeletonLoader: document.getElementById('review-skeleton-loader'), // NEW
    // Carousels
    relatedProductsSection: document.getElementById('related-products-section'),
    relatedProductsCarousel: document.getElementById('related-products-carousel'),
    youMayLikeSection: document.getElementById('you-may-like-section'),
    youMayLikeCarousel: document.getElementById('you-may-like-carousel'),
    // Mobile
    mobileAddToCartBtn: document.getElementById('mobile-add-to-cart-btn'),
    mobileOrderNowBtn: document.getElementById('mobile-order-now-btn'),
    // Media Navigation (NEW)
    mediaPrevBtn: document.getElementById('media-prev'),
    mediaNextBtn: document.getElementById('media-next'),
    // Edit Review Modal (NEW)
    editReviewModal: document.getElementById('edit-review-modal'),
    editReviewForm: document.getElementById('edit-review-form'),
    editReviewRatingInput: document.getElementById('edit-review-rating-input'),
    editSelectedRating: document.getElementById('edit-selected-rating'),
    editReviewComment: document.getElementById('edit-review-comment'),
    editRatingError: document.getElementById('edit-rating-error'),
    editCommentError: document.getElementById('edit-comment-error'),
    cancelEditReviewBtn: document.getElementById('cancel-edit-review-btn'),
    saveEditReviewBtn: document.getElementById('save-edit-review-btn'),
};


// ===================================================================
// HELPER UTILITIES
// ===================================================================

// NEW: Utility for smooth number counting
function animateValue(obj, start, end, duration) {
    if (start === end || !obj) return;
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        // Use Math.round for better appearance on small counts
        obj.textContent = (Math.round(progress * (end - start) + start)).toLocaleString(); 
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            obj.textContent = end.toLocaleString(); // Ensure final value is exact
        }
    };
    window.requestAnimationFrame(step);
}


function showToast(message, type = 'success') {
    Toastify({
        text: message,
        duration: TOAST_DURATION,
        close: true,
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center` or `right`
        stopOnFocus: true, // Prevents dismissing on hover
        style: {
            background: type === 'success' ? "var(--liyog-green)" : (type === 'error' ? "#ef4444" : "#f59e0b"),
        },
    }).showToast();
}

function normalizeYoutubeUrl(url) {
    if (!url) return null;
    let videoId;
    const embedMatch = url.match(/(?:youtube\.com\/(?:embed\/|v\/)|youtu\.be\/|youtube-nocookie\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
    if (embedMatch && embedMatch[1]) {
        videoId = embedMatch[1];
    } else {
        const urlObj = new URL(url);
        if (urlObj.hostname.includes('youtube.com') && urlObj.searchParams.has('v')) {
            videoId = urlObj.searchParams.get('v');
        } else if (urlObj.hostname.includes('youtu.be')) {
            videoId = urlObj.pathname.substring(1);
        }
    }
    // Add rel=0 to prevent related videos, modestbranding to hide YouTube logo, controls for playback.
    return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=1&showinfo=0&rel=0&loop=1&modestbranding=1` : null;
}

// >>> ADD generateVideoThumbnail(videoUrl)
// Attempts to extract a frame (at ~1.5s) from a cross-origin-friendly video resource.
// Will fail if CORS prevents reading video pixels — server-side generation is recommended for production.
async function generateVideoThumbnail(videoUrl, timeSec = 1.5, maxWidth = 640) {
    return new Promise((resolve, reject) => {
        try {
            const video = document.createElement('video');
            video.crossOrigin = 'anonymous';
            video.preload = 'metadata';
            video.muted = true;
            video.src = videoUrl;

            const onLoaded = () => {
                // Clamp time to duration
                const seekTo = Math.min(timeSec, Math.max(0, (video.duration || timeSec/2)));
                const onSeeked = () => {
                    try {
                        // canvas size proportional to video
                        const vw = video.videoWidth || maxWidth;
                        const vh = video.videoHeight || Math.round((vw / video.videoWidth) * video.videoHeight) || Math.round(vw * 9 / 16);
                        const canvas = document.createElement('canvas');
                        const ratio = Math.min(1, maxWidth / vw);
                        canvas.width = Math.round(vw * ratio);
                        canvas.height = Math.round(vh * ratio);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpeg', 0.75);
                        cleanup();
                        resolve(dataURL);
                    } catch (err) {
                        cleanup();
                        reject(err);
                    }
                };
                video.currentTime = seekTo;
                video.addEventListener('seeked', onSeeked, { once: true });
            };
            const onError = (err) => { cleanup(); reject(new Error('Video load error or CORS blocked')); };
            const cleanup = () => {
                try { video.pause(); video.removeAttribute('src'); video.load(); } catch (e) {}
            };

            video.addEventListener('loadedmetadata', onLoaded, { once: true });
            video.addEventListener('error', onError, { once: true });
        } catch (err) {
            reject(err);
        }
    });
}

// >>> REPLACE: Improved touch handlers to prevent page scroll during horizontal swipe
function setupMediaTouchHandlers() {
  const mainViewer = document.getElementById('main-media-viewer');
  if (!mainViewer) return;
  
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  const threshold = 30; // 👈 define this here

  mainViewer.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  }, { passive: true });

  mainViewer.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1) {
      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches[0].clientY;
      const dx = Math.abs(touchEndX - touchStartX);
      const dy = Math.abs(touchEndY - touchStartY);
      if (dx > dy) {
        // horizontal swipe — prevent page scroll
        e.preventDefault();
      }
    }
  }, { passive: false });

  mainViewer.addEventListener('touchend', () => {
    const deltaX = touchEndX - touchStartX;

    if (Math.abs(deltaX) > threshold) {
      if (deltaX > 0 && state.currentMediaIndex > 0) {
        // Swipe right → previous item
        syncGalleryState(state.currentMediaIndex - 1);
      } else if (deltaX < 0 && state.currentMediaIndex < state.mediaItems.length - 1) {
        // Swipe left → next item
        syncGalleryState(state.currentMediaIndex + 1);
      }
    }
  });
}


// Function to generate a dynamic avatar (initials)
function generateAvatar(name, size = 'w-10 h-10', textSize = 'text-lg') {
    const initials = (name || 'Anonymous').split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2);
    const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B'];
    const hashCode = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return hash;
    };
    const colorIndex = Math.abs(hashCode(initials)) % colors.length;
    const bgColor = colors[colorIndex];

    return `<div class="${size} ${textSize} avatar-initials" style="background-color: ${bgColor};" aria-label="${name}'s avatar">${initials}</div>`;
}

// NEW: Function to open/close the edit review modal
function toggleEditReviewModal(open, review = null) {
    if (open) {
        DOMElements.editReviewModal.classList.add('open');
        DOMElements.editReviewModal.setAttribute('aria-hidden', 'false');
        if (review) {
            DOMElements.editReviewForm.dataset.reviewId = review.id;
            DOMElements.editReviewComment.value = review.comment;
            
            // Render interactive stars for the edit form
            DOMElements.editReviewRatingInput.innerHTML = renderStarRatingHTML(review.rating, 'w-6 h-6', true, 'edit-review-rating');
            DOMElements.editSelectedRating.value = review.rating;

            // Attach change listener for the dynamically rendered radio buttons in the modal
            document.querySelectorAll('#edit-review-rating-input input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    DOMElements.editSelectedRating.value = e.target.value;
                    document.querySelectorAll('#edit-review-rating-input input[type="radio"]').forEach(r => {
                        if (r.checked) {
                            r.classList.add('selected');
                        } else {
                            r.classList.remove('selected');
                        }
                    });
                });
            });
            // Immediately apply 'selected' class based on initial rating
            const initialRadio = document.getElementById(`edit-review-rating-${review.rating}`);
            if (initialRadio) {
                initialRadio.checked = true;
                initialRadio.classList.add('selected');
            }

            // Focus the comment input for better UX
            DOMElements.editReviewComment.focus();
        }
    } else {
        DOMElements.editReviewModal.classList.remove('open');
        DOMElements.editReviewModal.setAttribute('aria-hidden', 'true');
        // Clear form and errors
        DOMElements.editReviewForm.reset();
        DOMElements.editReviewComment.classList.remove('input-error');
        DOMElements.editCommentError.style.display = 'none';
        DOMElements.editRatingError.style.display = 'none';
        DOMElements.editSelectedRating.value = '0'; // Reset hidden input
    }
}

// NEW: Filter logic specific to the modal
function applyModalReviewFilter(filterValue) {
    if (state.currentModalRatingFilter === filterValue && filterValue !== 0) {
        filterValue = 0; // Un-toggle if same filter is clicked
    }
    state.currentModalRatingFilter = filterValue;
    state.modalReviewsPage = 1;
    state.modalReviews = []; // Clear current modal list
    state.modalHasMoreReviews = true;

    // Clear and show loader
    DOMElements.modalReviewsList.innerHTML = '';
    DOMElements.modalReviewSkeletonLoader.style.display = 'block';

    // Reset scroll to top
    DOMElements.modalReviewsListWrapper.scrollTop = 0;

    fetchModalReviews();
}


// NEW: Function to toggle the Reviews Modal with animations and background lock
function toggleAllReviewsModal(show, initialFilter = 0) {
    if (!DOMElements.allReviewsModal) return;

    if (show) {
        state.isModalOpen = true;
        document.body.classList.add('overflow-hidden'); // Lock background scroll

        // Set initial modal filter, clear state, and fetch first page
        state.currentModalRatingFilter = initialFilter;
        state.modalReviews = [];
        state.modalReviewsPage = 1;
        state.modalHasMoreReviews = true;
        
        // Apply initial styles immediately to prepare for transition
        DOMElements.allReviewsModal.classList.remove('hidden', 'opacity-0');
        DOMElements.allReviewsModalContent.classList.add('translate-y-full');
        
        DOMElements.modalReviewsListWrapper.scrollTop = 0; // Reset scroll

        // Force a reflow for the transition to work
        void DOMElements.allReviewsModal.offsetHeight; 

        // Start the transition
        setTimeout(() => {
            DOMElements.allReviewsModal.classList.add('opacity-100');
            DOMElements.allReviewsModalContent.classList.remove('translate-y-full');
            // Initial fetch when modal opens
            fetchModalReviews();
// NEW: Render the dynamic review composer/login bar
    renderModalReviewComposer();
        }, 10); 

    } else {
        state.isModalOpen = false;
        document.body.classList.remove('overflow-hidden');

        // Start the closing animation
        DOMElements.allReviewsModal.classList.remove('opacity-100');
        DOMElements.allReviewsModalContent.classList.add('translate-y-full');

        // Hide elements after animation completes (300ms)
        setTimeout(() => {
            DOMElements.allReviewsModal.classList.add('hidden', 'opacity-0');
        }, 300);
    }
}

// NEW: Fetch Logic for Infinite Scrolling in the Modal
async function fetchModalReviews() {
    if (!state.modalHasMoreReviews || !state.isModalOpen || !state.product) return;
    
    DOMElements.modalReviewSkeletonLoader.style.display = 'block';
    
    const REVIEWS_PER_PAGE = 10; // Define a suitable batch size for infinite scroll
    const limit = REVIEWS_PER_PAGE; 
    const offset = (state.modalReviewsPage - 1) * limit;
    const filter = state.currentModalRatingFilter;

    /* REPLACE THIS ENTIRE TRY BLOCK IN fetchModalReviews */
try {
    let query = supabaseClient
        .from('reviews')
        .select(`
            id, rating, comment, created_at, totalreview_likes,
            user:user_id(id, name, profile_image, role)
        `);

    // 1. Filter by product ID
    query = query.eq('product_id', state.product.id);

    // 2. Add optional rating filter
    if (filter !== 0) {
        query = query.eq('rating', filter);
    }
    
        // 3. Order the results (must come before pagination)
    query = query.order('created_at', { ascending: false });

    // 4. Apply pagination using .range()
    const rangeFrom = offset;
    const rangeTo = offset + limit - 1; 
    query = query.range(rangeFrom, rangeTo); 
    
    // 5. Execute the query
    const { data, error } = await query;
    
    if (error) throw error;

    // Append new data to modalReviews
    state.modalReviews.push(...data);

    // Check for more pages
    if (data.length < limit) {
        state.modalHasMoreReviews = false;
    } else {
        state.modalReviewsPage++;
    }

    renderModalReviews();
    

        
    } catch (error) {
        console.error('Error fetching modal reviews:', error);
        showToast('Failed to load more reviews.', 'error');
    } finally {
        DOMElements.modalReviewSkeletonLoader.style.display = 'none';
    }
}



// ===================================================================
// API/DATA FETCHING FUNCTIONS
// ===================================================================

async function fetchCurrentUser() {
    try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        if (sessionError) throw sessionError;

        if (session?.user) {
            const { data: userProfile, error: profileError } = await supabaseClient
                .from('users')
                .select('id, name, email, profile_image, role, referral_code')
                .eq('id', session.user.id)
                .single();

            if (profileError && profileError.code !== 'PGRST116') console.warn("User profile not found, using session data:", profileError.message);
            
            state.currentUser = userProfile || { id: session.user.id, name: session.user.email, email: session.user.email, profile_image: null, role: 'user', referral_code: null };
            
            // NEW: Fetch user's liked reviews
            const { data: likedReviews, error: likedReviewsError } = await supabaseClient
                .from('user_review_likes') // Using the new user_review_likes table
                .select('review_id')
                .eq('user_id', state.currentUser.id);
            if (likedReviewsError) console.error("Error fetching user liked reviews:", likedReviewsError.message);
            else {
                state.userLikedReviews = new Set(likedReviews.map(like => like.review_id));
            }

        } else {
            state.currentUser = null;
        }
    } catch (error) {
        console.error("Error fetching current user:", error.message);
        showToast(`Failed to fetch user session: ${error.message}`, 'error');
        state.currentUser = null;
    }
}

// NEW: Fetch user details by ID
async function fetchUserById(userId) {
    if (!userId) return null;
    try {
        const { data, error } = await supabaseClient
            .from('users')
            .select('id, name, profile_image, role')
            .eq('id', userId)
            .single();
        if (error) {
            if (error.code !== 'PGRST116') console.error("Error fetching user by ID:", error.message);
            return null;
        }
        return data;
    } catch (error) {
        console.error("Error in fetchUserById:", error.message);
        return null;
    }
}


async function fetchProduct(slug) {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('*')
            .eq('slug', slug)
            .single();
        if (error) {
            if (error.code === 'PGRST116') {
                throw new Error('Product not found.');
            }
            throw new Error(`Failed to fetch product details: ${error.message}`);
        }
        return data;
    } catch (error) {
        console.error("Error in fetchProduct:", error.message);
        throw error;
    }
}

async function getExistingLike(productId, userId) {
    if (!userId) return null;
    try {
        const { data, error } = await supabaseClient
            .from('likes')
            .select('id')
            .eq('product_id', productId)
            .eq('user_id', userId)
            .maybeSingle();
        
        if (error) throw error;
        return data ? data.id : null;
    } catch (error) {
        if (error.code === 'PGRST116') return null;
        console.error("Error checking if product is liked:", error.message);
        return null;
    }
}


async function fetchSettings() {
    try {
        const { data, error } = await supabaseClient
            .from('site_settings')
            .select('key, value')
            .eq('key', 'lxc_rate')
            .single();

        if (error && error.code !== 'PGRST116') {
            console.warn("Error fetching site settings, using default:", error.message);
        }

        if (data) {
            state.settings.lxc_rate = parseFloat(data.value) || state.settings.lxc_rate;
        }
    } catch (error) {
        console.error("Critical error fetching site settings:", error.message);
        showToast("Failed to load site settings. Some features may not work as expected.", 'error');
    }
}


// REPLACED: Updated to fetch for the main summary view (limit 5)
async function fetchReviews(ratingFilter = state.currentRatingFilter, limit = 5) {
    if (!state.product) return [];
    
    // Only show skeleton on initial load or if the list is empty AND not in modal
    if (limit > 0 && state.reviews.length === 0) {
        DOMElements.reviewSkeletonLoader.style.display = 'block';
    }

    try {
        let query = supabaseClient
            .from('reviews')
            .select(`
                id, rating, comment, created_at, totalreview_likes,
                user:user_id(id, name, profile_image, role)
            `)
            .eq('product_id', state.product.id)
            .order('created_at', { ascending: false }) // Prioritize recent reviews
            .limit(limit);

        if (ratingFilter !== 0) {
            query = query.eq('rating', ratingFilter);
        }

        const { data, error } = await query;

        if (error) throw error;
        
        // This is only for the initial load of the main summary reviews
        state.reviews = data; 
        renderReviewsSummary(); // New call to render summary view
        return data;
        
    } catch (error) {
        console.error('Error fetching reviews:', error);
        showToast('Failed to load product reviews.', 'error');
        return [];
    } finally {
        DOMElements.reviewSkeletonLoader.style.display = 'none';
    }
}


async function fetchRelatedProducts(product) {
    try {
        const tags = (product.tags || '').split(',').map(t => t.trim()).filter(Boolean);
        let queryBuilder = supabaseClient.from('products').select('name, price, discount_price, image_urls, slug, avg_rating, total_reviews');
        queryBuilder = queryBuilder.neq('id', product.id).neq('published', false);

        let orConditions = [];
        if (product.category) {
            orConditions.push(`category.eq.${product.category}`);
        }
        if (tags.length > 0) {
            orConditions.push(`tags.cs.{${tags.map(t => `"${t}"`).join(',')}}`);
        }
        
        if (orConditions.length > 0) {
            queryBuilder = queryBuilder.or(orConditions.join(','));
        }

        const { data, error } = await queryBuilder.limit(4);

        if (error) { console.error("Error fetching related products:", error); return []; }
        return data;
    } catch (error) {
        console.error("Error in fetchRelatedProducts:", error);
        return [];
    }
}


async function fetchYouMayLikeProducts() {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('name, price, discount_price, image_urls, slug, avg_rating, total_reviews')
            .neq('published', false)
            .order('total_orders', { ascending: false, nullsFirst: false })
            .limit(8);
            
        if (error) { console.error("Error fetching 'You May Like' products:", error); return []; }
        return data;
    } catch (error) {
        console.error("Error in fetchYouMayLikeProducts:", error);
        return [];
    }
}

// ===================================================================
// NEW MODAL & INFINITE SCROLL LOGIC
// ===================================================================
// NEW: Renders reviews for the modal (Infinite Scroll View)
function renderModalReviews() {
    DOMElements.modalReviewSkeletonLoader.style.display = 'none';

    // Renders the dashboard/chart inside the modal
    // Note: We use the *product's* overall stats, but filter the *list* below.
    processReviewsData(state.modalReviews, 'modal'); 

    // Handle No Reviews
    if (state.modalReviews.length === 0) {
        DOMElements.modalReviewsList.innerHTML = '';
        DOMElements.modalNoReviewsMessage.style.display = 'block';
        DOMElements.modalEndOfReviewsMessage.style.display = 'none';
        DOMElements.modalNoReviewsMessage.textContent = state.currentModalRatingFilter === 0 
            ? 'No reviews yet for this product.' 
            : `No ${state.currentModalRatingFilter}-star reviews found.`;
        return;
    }
    
    DOMElements.modalNoReviewsMessage.style.display = 'none';
    
    // Use innerHTML only on first load/filter change, otherwise append
    if (state.modalReviewsPage === 1 && state.modalReviews.length <= 10) { 
        // Small correction to ensure the first page load replaces the list
        DOMElements.modalReviewsList.innerHTML = state.modalReviews.map(createReviewCardHTML).join('');
    } else {
        // Find the index to start appending from
        const startAppendIndex = (state.modalReviewsPage - 2) * 10;
        const reviewsToAppend = state.modalReviews.slice(startAppendIndex);

        // Only append new unique reviews to prevent duplication
        const existingReviewIds = new Set(Array.from(DOMElements.modalReviewsList.children).map(el => el.dataset.reviewId));
        const newReviewsHTML = reviewsToAppend
            .filter(r => !existingReviewIds.has(r.id))
            .map(createReviewCardHTML).join('');
            
        DOMElements.modalReviewsList.insertAdjacentHTML('beforeend', newReviewsHTML);
    }
    
    // Handle End of Reviews Message
    if (!state.modalHasMoreReviews) {
        DOMElements.modalEndOfReviewsMessage.style.display = 'block';
    } else {
        DOMElements.modalEndOfReviewsMessage.style.display = 'none';
    }

    // Re-attach listeners for dynamically rendered review cards in the modal
    attachReviewActionListeners(state.modalReviews);
}


// ===================================================================
// RENDER FUNCTIONS
// ===================================================================

function renderProductDetails() {
    const p = state.product;
    if (!p) return;

    // Header Info
    DOMElements.productCategory.textContent = p.category || 'General';
    DOMElements.productName.textContent = p.name;

// >>> ADD: render human-readable created / updated timestamps
(function renderTimestamps() {
    try {
        const created = p.created_at ? new Date(p.created_at) : null;
        const updated = p.updated_at ? new Date(p.updated_at) : null;
        if (!created) {
            DOMElements.productDates && (DOMElements.productDates.textContent = '');
            return;
        }
        // Use user's locale by default, show date + time in short format
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        const createdStr = new Intl.DateTimeFormat(undefined, options).format(created);
        let out = `Created: ${createdStr}`;
        if (updated && updated.getTime() > created.getTime()) {
            const updatedStr = new Intl.DateTimeFormat(undefined, options).format(updated);
            out += ` • Updated: ${updatedStr}`;
        }
        if (DOMElements.productDates) DOMElements.productDates.textContent = out;
    } catch (err) {
        if (DOMElements.productDates) DOMElements.productDates.textContent = '';
        console.debug('Error rendering product dates:', err);
    }
})();

    document.title = `${p.name} • Liyog`;
    
    // Stock Status
    if (p.published) {
        DOMElements.stockBadge.textContent = 'In Stock';
        DOMElements.stockBadge.className = 'text-xs font-bold px-3 py-1.5 rounded-full whitespace-nowrap bg-green-100 text-green-800';
        [DOMElements.addToCartBtn, DOMElements.orderNowBtn, DOMElements.mobileAddToCartBtn, DOMElements.mobileOrderNowBtn].forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    } else {
        DOMElements.stockBadge.textContent = 'Out of Stock';
        DOMElements.stockBadge.className = 'text-xs font-bold px-3 py-1.5 rounded-full whitespace-nowrap bg-red-100 text-red-800';
        [DOMElements.addToCartBtn, DOMElements.orderNowBtn, DOMElements.mobileAddToCartBtn, DOMElements.mobileOrderNowBtn].forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }

    // Ratings & Metrics (Product-level)
    DOMElements.starRating.innerHTML = renderStarRatingHTML(p.avg_rating);
    DOMElements.avgRating.textContent = (p.avg_rating || 0).toFixed(1);

// =========================================================
// CONSOLIDATED: Animated Reviews Count & Tab Sync (Action 1.2)
// =========================================================

const totalReviewsEl = DOMElements.overallTotalReviewsCount;
const newCount = state.product.total_reviews ?? 0;
const newAvgRating = state.product.avg_rating ?? 0;

if (totalReviewsEl) {
    const currentCount = parseInt(totalReviewsEl.dataset.currentCount || 0, 10);
    
    // 1. Update the overall rating display HTML (setting current count first for animation)
    totalReviewsEl.innerHTML = `⭐ ${newAvgRating.toFixed(1)} · <span id="animated-review-count">${currentCount.toLocaleString()}</span> Reviews`; 

    const countSpan = document.getElementById('animated-review-count');
    
    if (countSpan && currentCount !== newCount) {
        if (typeof animateValue === 'function') {
            animateValue(countSpan, currentCount, newCount, 600); // 600ms animation
        } else {
             // Fallback if animateValue is missing
             countSpan.textContent = newCount.toLocaleString();
        }
    } else if (countSpan) {
         // If count didn't change, just ensure the final value is displayed
         countSpan.textContent = newCount.toLocaleString();
    }
    
    // Store the new count for the next update comparison
    totalReviewsEl.dataset.currentCount = newCount;
}


// 2. Update the Reviews Tab Button Count
const reviewsTabButton = document.querySelector('[data-tab="reviews"]');

if (reviewsTabButton) {
    const countText = newCount.toLocaleString();
    
    const tabCountElement = reviewsTabButton.querySelector('.review-tab-count');
    
    if (tabCountElement) {
        tabCountElement.textContent = `Reviews (${countText})`;
    } else {
        const tabCountBadge = reviewsTabButton.querySelector('.tab-count-badge');
        if (tabCountBadge) {
             tabCountBadge.textContent = countText;
        }
    }
}
// =========================================================
// End of Consolidated Block


 DOMElements.totalOrders.textContent = (p.total_orders || 0).toLocaleString();
    DOMElements.totalLikes.textContent = (p.total_likes || 0).toLocaleString();
    DOMElements.totalViews.textContent = (p.total_views || 0).toLocaleString();

    // Tags
    const tags = (p.tags || '').split(',').map(t => t.trim()).filter(Boolean);
    DOMElements.tagsContainer.innerHTML = tags.map(tag => 
        `<a href="#" class="px-3 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full whitespace-nowrap hover:bg-liyog-green hover:text-white transition-colors">${tag}</a>`
    ).join('');

    // Pricing
    const finalPrice = p.discount_price ?? p.price;
    const originalPrice = p.price;
    DOMElements.finalPrice.textContent = `₦${finalPrice.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
    if (p.discount_price != null && p.discount_price < originalPrice) {
        DOMElements.originalPrice.textContent = `₦${originalPrice.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        if (p.discount_percent) {
            DOMElements.discountPercent.textContent = `${p.discount_percent}% off`;
            DOMElements.discountPercent.style.display = 'inline';
        } else {
            DOMElements.discountPercent.style.display = 'none';
        }
    } else {
        DOMElements.originalPrice.textContent = '';
        DOMElements.discountPercent.style.display = 'none';
    }
    
    // Carton Quantity and Price (NEW)
    if (p.carton_quantity && p.carton_price) {
        DOMElements.cartonQuantity.textContent = `One Bulk Unit: ${p.carton_quantity}`;
        DOMElements.cartonPrice.textContent = `(₦${p.carton_price.toLocaleString(undefined, { minimumFractionDigits: 2 })})`;
        DOMElements.cartonInfo.style.display = 'block';
    } else {
        DOMElements.cartonInfo.style.display = 'none';
    }

    // LiyogX Coins
    const lxcValue = (p.liyogx_coins || 0) * state.settings.lxc_rate;
    DOMElements.liyogxCoins.textContent = p.liyogx_coins || 0;
    DOMElements.liyogxValue.textContent = lxcValue.toLocaleString(undefined, { minimumFractionDigits: 2 });

    
    // ✅ Always visible: Added By User (Updated)
if (p.added_by) {
    fetchUserById(p.added_by).then(user => {
        if (user) {
            // Show user's name
            DOMElements.addedByName.textContent = user.name || 'Unknown User';
            
            // Show user's avatar or generated one
            if (user.profile_image) {
                DOMElements.addedByAvatar.innerHTML = `
                    <img src="${user.profile_image}" 
                         alt="${user.name}'s profile" 
                         class="w-full h-full object-cover rounded-full" 
                         loading="lazy">
                `;
            } else {
                DOMElements.addedByAvatar.innerHTML = generateAvatar(user.name, 'w-6 h-6', 'text-xs');
            }

            // Make sure it's always visible publicly
            DOMElements.addedByUser.style.display = 'flex';
            DOMElements.addedByUser.classList.remove('hidden');
        } else {
            // If no user found, still show placeholder
            DOMElements.addedByName.textContent = 'SYSTEM';
            DOMElements.addedByAvatar.innerHTML = generateAvatar('S', 'w-6 h-6', 'text-xs');
            DOMElements.addedByUser.style.display = 'flex';
            DOMElements.addedByUser.classList.remove('hidden');
        }
    }).catch(() => {
        // Handle network or fetch errors gracefully
        DOMElements.addedByName.textContent = 'Unavailable';
        DOMElements.addedByAvatar.innerHTML = generateAvatar('?', 'w-6 h-6', 'text-xs');
        DOMElements.addedByUser.style.display = 'flex';
        DOMElements.addedByUser.classList.remove('hidden');
    });
} else {
    // When there's no added_by field, show placeholder
    DOMElements.addedByName.textContent = 'System';
    DOMElements.addedByAvatar.innerHTML = generateAvatar('S', 'w-6 h-6', 'text-xs');
    DOMElements.addedByUser.style.display = 'flex';
    DOMElements.addedByUser.classList.remove('hidden');
}

    // Description
    DOMElements.descriptionContent.innerHTML = DOMPurify.sanitize(p.description_html || '<p class="text-gray-500">No detailed description available.</p>');
    
    // Set initial product like state
    if (state.isLiked) {
        DOMElements.likeIcon.classList.add('like-icon-filled');
    } else {
        DOMElements.likeIcon.classList.remove('like-icon-filled');
    }
}

// >>> REPLACE renderMediaGallery() with this improved version (supports thumbnails, video thumbs, lazy loading, swipe, keyboard) <<<

async function renderMediaGallery() {
    const p = state.product;
    if (!p) return;

    // Build media arrays: images first then videos (youtube or direct video)
    const images = Array.isArray(p.image_urls) ? p.image_urls.filter(Boolean) : [];
    const media = images.map(url => ({ type: 'image', url }));

    if (p.youtube_url) {
        const embed = normalizeYoutubeUrl(p.youtube_url);
        if (embed) media.push({ type: 'youtube', url: embed, raw: p.youtube_url });
    }
    if (p.video_url) {
        media.push({ type: 'video', url: p.video_url });
    }

    // Ensure at least one media item
    if (media.length === 0) {
        media.push({ type: 'image', url: 'https://via.placeholder.com/800x800?text=No+Media+Available' });
    }

    state.mediaItems = media;
    // If current index out of range, clamp
    if (state.currentMediaIndex >= state.mediaItems.length) state.currentMediaIndex = 0;
    if (state.currentMediaIndex < 0) state.currentMediaIndex = 0;

    // Build thumbnails HTML (images then videos)
    DOMElements.thumbnailsWrapper.innerHTML = ''; // clear
    const frag = document.createDocumentFragment();

    for (let i = 0; i < state.mediaItems.length; i++) {
        const item = state.mediaItems[i];
        const btn = document.createElement('button');
        btn.className = 'thumbnail-btn flex-shrink-0 w-20 h-20 border-2 border-transparent rounded-lg overflow-hidden cursor-pointer focus:outline-none focus:ring-2 focus:ring-liyog-green focus:ring-offset-2 transition-all duration-200';
        btn.dataset.index = i;
        btn.setAttribute('aria-label', item.type === 'image' ? `Show image ${i+1}` : `Play video ${i+1}`);

        // thumbnail source
        let thumbSrc = '';
        if (item.type === 'image') {
            thumbSrc = item.url;
            btn.innerHTML = `<img src="${thumbSrc}" alt="Thumbnail ${i+1}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-300" loading="lazy" onerror="this.onerror=null; this.src='https://via.placeholder.com/80?text=Image+Error';">`;

btn.classList.add('bg-gray-200', 'animate-pulse');
const imgEl = btn.querySelector('img');
imgEl.addEventListener('load', () => {
  btn.classList.remove('animate-pulse', 'bg-gray-200');
});
       
imgEl.addEventListener('error', () => {
  btn.classList.remove('animate-pulse', 'bg-gray-200');
  imgEl.src = 'https://via.placeholder.com/80?text=Image+Error';
});

 } else if (item.type === 'youtube') {
            // extract video id for YouTube thumbnail if possible
            const m = (item.url || '').match(/embed\/([^?]+)/);
            const vid = m && m[1] ? m[1] : null;
            thumbSrc = vid ? `https://img.youtube.com/vi/${vid}/mqdefault.jpg` : 'https://via.placeholder.com/80?text=Video';
            btn.innerHTML = `<img src="${thumbSrc}" alt="Product video thumbnail ${i+1}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-300" loading="lazy">` +
                            `<div class="video-overlay"><svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></div>`;
        } else { // direct video upload
            // try to generate a thumbnail client-side (non-blocking)
            thumbSrc = 'https://via.placeholder.com/80/006400/FFFFFF?text=🎥';
            // optimistic: create an <img> then try to replace src with generated thumbnail when available
            btn.innerHTML = `<img src="${thumbSrc}" alt="Product video thumbnail ${i+1}" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-300" loading="lazy">` +
                            `<div class="video-overlay"><svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></div>`;
            // Kick off generation but don't block rendering
            (async () => {
                try {
                    const dataUrl = await generateVideoThumbnail(item.url);
                    if (dataUrl) {
                        const imgEl = btn.querySelector('img');
                        if (imgEl) imgEl.src = dataUrl;
                    }
                } catch (err) {
                    // ignore; fallback placeholder remains
                    console.debug('video thumbnail generation failed:', err?.message || err);
                }
            })();
        }

        // Click handler
        btn.addEventListener('click', (e) => {
            const idx = Number(btn.dataset.index);
            state.currentMediaIndex = idx;
            renderMainMedia(state.currentMediaIndex, state.mediaItems);
            // update active class
            DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('thumb-active'));
            btn.classList.add('thumb-active');
            // ensure visible
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        });

        frag.appendChild(btn);
    }

    DOMElements.thumbnailsWrapper.appendChild(frag);


    // Set initial active class
    const thumbs = DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn');
    thumbs.forEach(b => b.classList.remove('thumb-active'));
    if (thumbs[state.currentMediaIndex]) thumbs[state.currentMediaIndex].classList.add('thumb-active');



// --- SMART MULTILAYER VIDEO PLAYER BUTTON (FINAL & POLISHED) ---
const hasVideo = state.mediaItems.some(it => it.type === 'youtube' || it.type === 'video');
const thumbnailsContainer = DOMElements.thumbnailsWrapper?.parentElement;

if (hasVideo && thumbnailsContainer) {
  let videoBtn = document.getElementById('gallery-video-button');

  // ✅ Create the button if not exists
  if (!videoBtn) {
    videoBtn = document.createElement('button');
    videoBtn.id = 'gallery-video-button';
    videoBtn.className = `
      relative flex items-center justify-center mx-auto mt-3 w-16 h-16 rounded-xl
      bg-black/70 shadow-[0_0_15px_rgba(0,0,0,0.6)] overflow-hidden
      border-2 border-transparent hover:scale-110 transition-transform duration-500
      z-30
    `;

    // Inner layered glow rectangles + play icon
    videoBtn.innerHTML = `
      <div class="absolute inset-0 rounded-xl animate-border-glow"></div>
      <div class="absolute inset-1 rounded-lg border-2 border-white/80"></div>
      <div class="absolute inset-2 rounded-md border-2 border-blue-400/80"></div>
      <div class="absolute inset-3 rounded border-2 border-green-400/70"></div>
      <div class="absolute inset-4 rounded-sm border-2 border-yellow-400/70"></div>
      <svg xmlns="http://www.w3.org/2000/svg"
        class="relative w-8 h-8 text-white drop-shadow-lg"
        viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
      </svg>
    `;

    thumbnailsContainer.insertAdjacentElement('afterend', videoBtn);
  }

  // ✅ Click to jump to video
  videoBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();

  // 🔥 Add premium glowing fire effect
  videoBtn.classList.add('video-btn-fire');
  setTimeout(() => {
    videoBtn.classList.remove('video-btn-fire');
  }, 1500); // glow lasts 1.5s

    const vidIndex = state.mediaItems.findIndex(it => it.type === 'youtube' || it.type === 'video');
    if (vidIndex >= 0) {
      syncGalleryState(vidIndex);
      const thumbContainer = document.getElementById('thumbnails-container');
      const activeThumb = thumbContainer?.children[vidIndex];
      if (activeThumb) {
        activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }
    // ✅ Keep button alive, let visibility logic control hiding
    setTimeout(checkVideoThumbVisibility, 800);
  });

  // --- Helper: Check if video thumbnail is visible ---
  function checkVideoThumbVisibility() {
    const thumbContainer = document.getElementById('thumbnails-container');
    const vidIndex = state.mediaItems.findIndex(it => it.type === 'youtube' || it.type === 'video');
    if (!thumbContainer || vidIndex < 0) return;
    const videoThumb = thumbContainer.children[vidIndex];
    if (!videoThumb) return;
    const rect = videoThumb.getBoundingClientRect();
    const containerRect = thumbContainer.getBoundingClientRect();
    const isVisible = rect.left >= containerRect.left && rect.right <= containerRect.right;

    // ✅ Smooth show/hide based on visibility
    if (isVisible) {
      videoBtn.style.opacity = '0';
      videoBtn.style.pointerEvents = 'none';
    } else {
      videoBtn.style.opacity = '1';
      videoBtn.style.pointerEvents = 'auto';
    }
  }

  // ✅ Listen for changes & recheck visibility
  const thumbContainer = document.getElementById('thumbnails-container');
  if (thumbContainer) {
    thumbContainer.addEventListener('scroll', checkVideoThumbVisibility, { passive: true });
  }
  window.addEventListener('resize', checkVideoThumbVisibility);
  document.addEventListener('DOMContentLoaded', checkVideoThumbVisibility);
  const observer = new MutationObserver(checkVideoThumbVisibility);
  const mainViewer = document.getElementById('main-media-viewer');
  if (mainViewer) observer.observe(mainViewer, { childList: true, subtree: true });
  setInterval(checkVideoThumbVisibility, 1500);
  checkVideoThumbVisibility();
} else {
  const vb = document.getElementById('gallery-video-button');
  if (vb) vb.classList.add('hidden');
}

    // Render the main media
    renderMainMedia(state.currentMediaIndex, state.mediaItems);

    // Setup touch/swipe handlers on main viewer for mobile
    setupMediaTouchHandlers();
// ensure arrow visibility is correct after thumbnails render
updateGalleryArrowVisibility();

// --- HIDE INSTRUCTION MESSAGE WHEN ONLY ONE OR NO MEDIA ITEM ---
const instructionMsg = document.querySelector('.text-center.mt-2.text-xs.text-gray-500');
if (instructionMsg) {
  const items = document.querySelectorAll('.thumbnail-item, .gallery-thumbnail, .media-thumbnail');
  const count = items.length || (state.mediaItems ? state.mediaItems.length : 0);

  // If no media or only one, remove it completely
  if (count <= 1) {
    instructionMsg.remove();
  }
}

// Ensure gallery prev/next arrow visibility is initialized
updateGalleryArrowVisibility();

    // keyboard navigation: left/right to navigate; Enter to toggle play/pause for video
    if (!renderMediaGallery._keyboardAttached) {
        window.addEventListener('keydown', (e) => {
            if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
            if (e.key === 'ArrowRight') {
                if (state.currentMediaIndex < state.mediaItems.length - 1) {
                    state.currentMediaIndex++;
                    renderMainMedia(state.currentMediaIndex, state.mediaItems);
                    const btn = DOMElements.thumbnailsWrapper.querySelector(`.thumbnail-btn[data-index="${state.currentMediaIndex}"]`);
                    if (btn) { DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('thumb-active')); btn.classList.add('thumb-active'); btn.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }
                }
            } else if (e.key === 'ArrowLeft') {
                if (state.currentMediaIndex > 0) {
                    state.currentMediaIndex--;
                    renderMainMedia(state.currentMediaIndex, state.mediaItems);
                    const btn = DOMElements.thumbnailsWrapper.querySelector(`.thumbnail-btn[data-index="${state.currentMediaIndex}"]`);
                    if (btn) { DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('thumb-active')); btn.classList.add('thumb-active'); btn.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }
                }
            } else if (e.key === 'Enter') {
                // toggle play/pause if main is video
                const vid = DOMElements.mainMediaViewer.querySelector('video');
                if (vid) {
                    if (vid.paused) vid.play().catch(()=>{});
                    else vid.pause();
                }
            }
        });
        renderMediaGallery._keyboardAttached = true;
    }
}


// >>> REPLACE renderMainMedia() - improved fallback, lazy loads, accessible titles <<<
function renderMainMedia(index, mediaItems) {
    const item = mediaItems[index];
    DOMElements.mainMediaViewer.innerHTML = ''; // Clear previous content

    if (!item) {
        DOMElements.mainMediaViewer.innerHTML = `<img src="https://via.placeholder.com/600?text=Error" alt="Media load error" class="w-full h-full object-contain">`;
        return;
    }

    if (item.type === 'image') {
        const img = document.createElement('img');
        img.src = item.url;
        img.alt = `${state.product?.name || 'Product'} image ${index + 1}`;
        img.className = 'w-full h-full object-contain rounded-lg transition-opacity duration-300 animate-fade-in';
        // For the main display we can use eager loading for the visible image
        img.loading = 'eager';
        img.decoding = 'async';
        DOMElements.mainMediaViewer.appendChild(img);

    } 
else if (item.type === 'video') {
        // === LIYOG PROFESSIONAL INLINE VIDEO PLAYER === //
const video = document.createElement('video');
video.src = item.url;
video.controls = false;
video.playsInline = true;
video.preload = 'metadata';
video.autoplay = false;
video.muted = false;
video.className = 'w-full h-full object-contain rounded-lg';

// ✅ Security & Protection
video.setAttribute('controlsList', 'nodownload');
video.removeAttribute('disablePictureInPicture');
video.setAttribute('oncontextmenu', 'return false;');
video.addEventListener('contextmenu', e => e.preventDefault());
video.addEventListener('touchstart', e => {
  if (e.touches.length === 1) e.preventDefault();
});

DOMElements.mainMediaViewer.appendChild(video);

// ✅ Wrap Video
const wrapper = document.createElement('div');
wrapper.className = 'relative w-full h-full flex items-center justify-center bg-black rounded-lg overflow-hidden';
video.parentElement.appendChild(wrapper);
wrapper.appendChild(video);

// === Custom Controls === //
const controls = document.createElement('div');
controls.className = `
  absolute inset-0 flex flex-col justify-between pointer-events-none z-20
`;
controls.innerHTML = `
  <!-- Top Control Bar -->
  <div id="controlBar" class="absolute top-0 left-0 right-0 flex items-center gap-2 px-3 py-2 bg-gradient-to-b from-black/80 to-transparent opacity-100 transition-opacity duration-300 pointer-events-auto">
    <button id="playPauseBtn" class="text-white hover:text-liyog-green">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z" />
      </svg>
    </button>
    <span id="currentTime" class="text-xs text-gray-300">0:00</span>
    <div id="progressBar" class="flex-1 h-1.5 bg-gray-600 rounded overflow-hidden cursor-pointer">
      <div id="progressFill" class="h-full bg-liyog-green w-0"></div>
    </div>
    <span id="totalTime" class="text-xs text-gray-300">0:00</span>
    <button id="pipBtn" class="text-white hover:text-liyog-green">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <rect x="14" y="14" width="7" height="5"></rect>
      </svg>
    </button>
    <button id="fullscreenBtn" class="text-white hover:text-liyog-green">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m0 8v3a2 2 0 0 0 2 2h3m8-16h3a2 2 0 0 1 2 2v3m0 8v3a2 2 0 0 1-2 2h-3"/>
      </svg>
    </button>
  </div>

  <!-- Center Play Button -->
  <div id="centerPlayBtn" class="absolute inset-0 flex items-center justify-center opacity-100 transition-opacity duration-300">
    <button class="bg-liyog-green/80 hover:bg-liyog-green text-white p-4 rounded-full pointer-events-auto">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
        <path d="M8 5v14l11-7z" />
      </svg>
    </button>
  </div>
`;
wrapper.appendChild(controls);

// === Control References === //
const playPauseBtn = controls.querySelector('#playPauseBtn');
const centerPlayBtn = controls.querySelector('#centerPlayBtn');
const progressBar = controls.querySelector('#progressBar');
const progressFill = controls.querySelector('#progressFill');
const currentTimeEl = controls.querySelector('#currentTime');
const totalTimeEl = controls.querySelector('#totalTime');

// === Helper Functions === //
function formatTime(sec) {
  if (!sec || isNaN(sec)) return "0:00";
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

// === Play / Pause === //
function updatePlayIcon(isPlaying) {
  const svgPath = isPlaying
    ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>'
    : '<path d="M8 5v14l11-7z"/>';
  playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor">${svgPath}</svg>`;
  centerPlayBtn.style.opacity = isPlaying ? '0' : '1';
}
function togglePlayPause() {
  if (video.paused) video.play();
  else video.pause();
}
playPauseBtn.onclick = togglePlayPause;
centerPlayBtn.onclick = togglePlayPause;
video.addEventListener('play', () => updatePlayIcon(true));
video.addEventListener('pause', () => updatePlayIcon(false));

// === Update Times & Progress === //
video.addEventListener('loadedmetadata', () => {
  totalTimeEl.textContent = formatTime(video.duration);
});
video.addEventListener('timeupdate', () => {
  currentTimeEl.textContent = formatTime(video.currentTime);
  progressFill.style.width = `${(video.currentTime / video.duration) * 100}%`;
});

// Seek on progress click
progressBar.addEventListener('click', e => {
  const rect = progressBar.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  video.currentTime = percent * video.duration;
});

// === SMART TOUCH HANDLING FOR GALLERY + VIDEO === //
let touchStartX = 0;
let touchStartY = 0;
const swipeThreshold = 30; // px to detect swipe
let lastTap = 0; // keep this to track double-taps

video.addEventListener('touchstart', (e) => {
  if (!e.touches[0]) return;
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
});

video.addEventListener('touchend', (e) => {
  if (!e.changedTouches[0]) return;

  const deltaX = e.changedTouches[0].clientX - touchStartX;
  const deltaY = e.changedTouches[0].clientY - touchStartY;

  // ✅ Allow swipe to move gallery items
  if (Math.abs(deltaX) > swipeThreshold && Math.abs(deltaY) < 50) {
    return; // Don't block — gallery will detect this swipe
  }

  // ✅ Treat as tap/double-tap ONLY (block gallery)
  e.stopPropagation();
  const now = Date.now();
  const tapGap = now - lastTap;

  if (tapGap < 300 && tapGap > 0) {
    // 🎯 Double tap detected — rewind/forward
    const rect = video.getBoundingClientRect();
    const x = e.changedTouches[0].clientX - rect.left;
    if (x < rect.width / 2) {
      video.currentTime = Math.max(0, video.currentTime - 10);
      showOverlay('back');
    } else {
      video.currentTime = Math.min(video.duration, video.currentTime + 10);
      showOverlay('forward');
    }
  } else {
    // 🎯 Single tap — play/pause
    togglePlayPause();
  }

  lastTap = now;
}, { passive: false });

// === Picture-in-Picture === //
controls.querySelector('#pipBtn').onclick = async () => {
  try {
    if (document.pictureInPictureElement)
      await document.exitPictureInPicture();
    else await video.requestPictureInPicture();
  } catch (err) {
    console.warn("PiP not supported:", err);
  }
};

// === Fullscreen === //
controls.querySelector('#fullscreenBtn').onclick = async () => {
  try {
    if (!document.fullscreenElement) {
      await wrapper.requestFullscreen();
      wrapper.classList.add('video-fullscreen-active');
    } else {
      await document.exitFullscreen();
      wrapper.classList.remove('video-fullscreen-active');
    }
  } catch (err) {
    console.warn("Fullscreen not supported:", err);
  }
};

// === Overlay Feedback === //
function showOverlay(type) {
  const overlay = document.createElement('div');
  overlay.className = 'absolute flex items-center justify-center text-white text-2xl font-bold bg-black/60 rounded-lg px-4 py-3 transition-opacity duration-500';
  overlay.style.top = '50%';
  overlay.style.left = '50%';
  overlay.style.transform = 'translate(-50%, -50%)';
  overlay.style.opacity = '1';

  // Custom icons with theme color
  const icons = {
    back: `<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-liyog-green" fill="currentColor" viewBox="0 0 24 24">
             <path d="M11 19l-7-7 7-7v14zM20 5v14h-2V5h2z"/>
           </svg>`,
    forward: `<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-liyog-green" fill="currentColor" viewBox="0 0 24 24">
                <path d="M13 5l7 7-7 7V5zM4 19V5h2v14H4z"/>
              </svg>`
  };

  overlay.innerHTML = icons[type] || '';

  wrapper.appendChild(overlay);
  setTimeout(() => (overlay.style.opacity = '0'), 400);
  setTimeout(() => overlay.remove(), 600);
}

// === Auto Hide Controls === //
let hideTimer;
function showControls() {
  const bar = controls.querySelector('#controlBar');
  bar.style.opacity = '1';
  clearTimeout(hideTimer);
  hideTimer = setTimeout(() => {
    if (!video.paused) bar.style.opacity = '0';
  }, 3000);
}
['mousemove', 'touchstart', 'click'].forEach(evt => {
  wrapper.addEventListener(evt, e => {
    e.stopPropagation(); // Prevent swipe interference
    showControls();
  });
});
video.addEventListener('pause', showControls);
video.addEventListener('play', showControls);
showControls();


    } else if (item.type === 'youtube') {
        // Embed YouTube in responsive container (use embed url already from normalizeYoutubeUrl)
        const container = document.createElement('div');
        container.className = 'responsive-iframe-container';
        const iframe = document.createElement('iframe');
        iframe.src = item.url;
        iframe.setAttribute('allow', 'autoplay; encrypted-media; gyroscope; picture-in-picture');
        iframe.setAttribute('allowfullscreen', '');
        iframe.title = `YouTube video player for ${state.product?.name || 'product'}`;
        iframe.loading = 'lazy';
        container.appendChild(iframe);
        DOMElements.mainMediaViewer.appendChild(container);
    }

    // update nav buttons
    updateMediaNavButtons();

// MEDIA COUNTER
const counterId = 'media-counter';
let counterEl = DOMElements.mainMediaViewer.querySelector(`#${counterId}`);
if (!counterEl) {
  counterEl = document.createElement('div');
  counterEl.id = counterId;
  counterEl.className = 'absolute top-2 right-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded';
  DOMElements.mainMediaViewer.appendChild(counterEl);
}
counterEl.textContent = `${index + 1} / ${mediaItems.length}`;

}

// NEW: Updates visibility of media navigation buttons
function updateMediaNavButtons() {
    const total = state.mediaItems.length;
    if (!DOMElements.mediaPrevBtn || !DOMElements.mediaNextBtn) return;

    // Show/hide based on count
    if (total <= 1) {
        DOMElements.mediaPrevBtn.classList.add('hidden');
        DOMElements.mediaNextBtn.classList.add('hidden');
        return;
    }
    DOMElements.mediaPrevBtn.classList.remove('hidden');
    DOMElements.mediaNextBtn.classList.remove('hidden');

    if (state.currentMediaIndex <= 0) {
        DOMElements.mediaPrevBtn.classList.add('hidden');
    } else {
        DOMElements.mediaPrevBtn.classList.remove('hidden');
    }

    if (state.currentMediaIndex >= total - 1) {
        DOMElements.mediaNextBtn.classList.add('hidden');
    } else {
        DOMElements.mediaNextBtn.classList.remove('hidden');
    }
}


// NEW: Reusable function to render star HTML (for display or interactive input)
function renderStarRatingHTML(rating = 0, size = 'w-4 h-4', interactive = false, inputName = 'review-rating') {
    let starsHTML = '';
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    const fullStarSVG = `<svg class="${size} text-liyog-gold" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.92-.755 1.688-1.54 1.118L10 15.347l-3.883 2.678c-.784.57-1.84-.197-1.54-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.126 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z" /></svg>`;
    const emptyStarSVG = `<svg class="${size} text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.92-.755 1.688-1.54 1.118L10 15.347l-3.883 2.678c-.784.57-1.84-.197-1.54-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.126 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z" /></svg>`;
    
    if (interactive) {
        for (let i = 5; i >= 1; i--) {
            const checked = (i === Math.round(rating) ? 'checked' : '');
            starsHTML += `
                <input type="radio" id="${inputName}-${i}" name="${inputName}" value="${i}" class="sr-only" ${checked} aria-label="${i} stars">
                <label for="${inputName}-${i}" title="${i} stars" aria-hidden="true">
                    <svg class="${size}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.92-.755 1.688-1.54 1.118L10 15.347l-3.883 2.678c-.784.57-1.84-.197-1.54-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.126 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z" /></svg>
                </label>
            `;
        }
    } else {
        for (let i = 0; i < fullStars; i++) starsHTML += fullStarSVG;
        if (halfStar) {
            const halfStarGradientId = `half_grad_${Math.random().toString(36).substr(2, 5)}`;
            starsHTML += `<svg class="${size}" viewBox="0 0 20 20" fill="url(#${halfStarGradientId})"><defs><linearGradient id="${halfStarGradientId}"><stop offset="50%" stop-color="var(--liyog-gold)"/><stop offset="50%" stop-color="#e5e7eb"/></linearGradient></defs><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.92-.755 1.688-1.54 1.118L10 15.347l-3.883 2.678c-.784.57-1.84-.197-1.54-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.126 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z" /></svg>`;
        }
        for (let i = 0; i < emptyStars; i++) starsHTML += emptyStarSVG;
    }
    
    return starsHTML;
}


// REPLACED: Reusable Reviews Dashboard Renderer
function renderReviewsDashboard(ratingCounts, totalReviews, avgRating, target = 'main') {
    const isModal = target === 'modal';

    const avgRatingEl = isModal ? DOMElements.modalOverallAvgRating : DOMElements.overallAvgRating;
    const starRatingEl = isModal ? DOMElements.modalOverallStarRating : DOMElements.overallStarRating;
    const totalReviewsEl = isModal ? DOMElements.modalOverallTotalReviewsCount : DOMElements.overallTotalReviewsCount;
    const chartEl = isModal ? DOMElements.modalRatingsDistributionChart : DOMElements.ratingsDistributionChart;
    const currentFilter = isModal ? state.currentModalRatingFilter : state.currentRatingFilter;
    const applyFilterFunc = isModal ? applyModalReviewFilter : applyReviewFilter;
    
    if (!chartEl) return;

    avgRatingEl.textContent = avgRating.toFixed(1);
    starRatingEl.innerHTML = renderStarRatingHTML(avgRating, isModal ? 'w-6 h-6' : 'w-6 h-6');
    totalReviewsEl.textContent = totalReviews.toLocaleString() + (totalReviews === 1 ? ' Review' : ' Reviews');


    chartEl.innerHTML = ''; // Clear previous chart

    for (let i = 5; i >= 1; i--) {
        const count = ratingCounts[i] || 0;
        const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
        const isActive = (currentFilter === i);

        chartEl.innerHTML += `
            <div class="flex items-center gap-3 group">
                <button data-rating-filter="${i}" class="text-sm font-semibold w-8 text-right filter-rating-btn cursor-pointer transition-colors ${isActive ? 'text-liyog-green-dark' : 'text-gray-500 hover:text-gray-700'}" aria-pressed="${isActive}">
                    ${i} <span class="hidden sm:inline">Star</span>
                </button>
                <div class="flex-1 h-3 bg-gray-200 rounded-full rating-bar-wrapper relative cursor-pointer ${isActive ? 'ring-2 ring-liyog-green-dark/50' : ''}" data-rating-filter="${i}" role="progressbar" aria-valuenow="${percentage.toFixed(0)}" aria-valuemin="0" aria-valuemax="100" aria-label="${count} reviews for ${i} stars">
                    <div class="rating-fill bg-liyog-green h-full rounded-full transition-all duration-300" style="width: ${percentage.toFixed(0)}%;"></div>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-800 mix-blend-screen hidden">${count}</span>
                </div>
                <span class="text-sm font-medium w-10 text-right text-gray-500">${count.toLocaleString()}</span>
            </div>
        `;
    }

    // Attach listeners dynamically (replaces your old DOMElements.filterRatingBtns logic)
    chartEl.querySelectorAll('[data-rating-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterValue = parseInt(btn.dataset.ratingFilter, 10);
            applyFilterFunc(filterValue);
        });
    });
}

// REPLACED: Reusable Reviews Data Processor (Part 4)
function processReviewsData(reviews, target = 'main') {
    let ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let totalRatingSum = 0;
    
    // Calculate total counts for dashboard visualization
    reviews.forEach(review => {
        if (review.rating >= 1 && review.rating <= 5) {
            ratingCounts[review.rating]++;
            totalRatingSum += review.rating;
        }
    });

    const totalReviews = reviews.length;
    const avgRating = totalReviews > 0 ? (totalRatingSum / totalReviews) : 0;
    
    if (target === 'main') {
        state.reviewsData.ratingCounts = ratingCounts;
        state.reviewsData.totalReviews = state.product.total_reviews; // Use product's total count for dashboard
        state.reviewsData.avgRating = state.product.avg_rating; // Use product's overall average
    } 

    renderReviewsDashboard(ratingCounts, state.product.total_reviews, state.product.avg_rating, target);
}


// NEW: Function to generate HTML for a single review card
function createReviewCardHTML(review) {
    const user = review.user || { name: 'Anonymous', profile_image: null, id: null, role: 'user' };
    const avatarHTML = user.profile_image 
        ? `<img src="${user.profile_image}" alt="${user.name}'s profile" class="w-full h-full object-cover rounded-full" loading="lazy">`
        : generateAvatar(user.name, 'w-12 h-12', 'text-xl');
    
    const isOwner = state.currentUser && state.currentUser.id === user.id;
    const isAdmin = state.currentUser && state.currentUser.role === 'admin';
    const isLikedByUser = state.currentUser && state.userLikedReviews.has(review.id);

    const formattedDate = new Date(review.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

    return `
        <div class="review-card flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 transition-all duration-200 hover:shadow-md" data-review-id="${review.id}" role="article" aria-labelledby="review-author-${review.id}">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full overflow-hidden bg-liyog-green-light flex-shrink-0 flex items-center justify-center text-white text-xl font-bold" aria-hidden="true">
                    ${avatarHTML}
                </div>
            </div>
            <div class="flex-1">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-y-1">
                    <p id="review-author-${review.id}" class="font-bold text-gray-900 text-base">${user.name}</p>
                    <p class="text-xs text-gray-500">${formattedDate}</p>
                </div>
                <div class="flex items-center my-1" role="img" aria-label="${review.rating} out of 5 stars">
                    ${renderStarRatingHTML(review.rating, 'w-4 h-4')}
                </div>
                <p class="text-gray-700 text-sm mt-1 leading-relaxed">${DOMPurify.sanitize(review.comment)}</p>
                
                <div class="flex items-center gap-4 mt-3">
                    <button class="flex items-center gap-1 text-gray-500 hover:text-liyog-green transition-colors review-like-btn ${isLikedByUser ? 'text-liyog-green' : ''}" data-review-id="${review.id}" aria-label="${isLikedByUser ? 'Unlike' : 'Like'} this review">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6.382 10.118A4 4 0 0110 5.5V4a2 2 0 014 0v.5c1.11 0 2.08.402 2.592 1.182a4.004 4.004 0 01.13 5.48c-.069.166-.098.32-.098.47 0 .225.072.443.21.614l.004.007a.75.75 0 01.353.642v.001l-.007.004c-.001.002-.002.003-.002.003h-2.163c-.156.02-.31.03-.464.032H13.5a6.45 6.45 0 01-1.397.712A6.5 6.5 0 0110 16.5a6.463 6.463 0 01-3.618-1.118L2 10.5z" /></svg>
                        <span class="font-semibold text-sm ${isLikedByUser ? 'text-liyog-green' : 'text-gray-700'}" data-review-likes="${review.id}">${review.totalreview_likes || 0}</span>
                        <span class="text-xs text-gray-400">Helpful</span>
                    </button>
                    ${(isOwner || isAdmin) ? `
                        <button class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors review-edit-btn" data-review-id="${review.id}" aria-label="Edit this review">Edit</button>
                        <button class="text-sm font-semibold text-red-600 hover:text-red-800 transition-colors review-delete-btn" data-review-id="${review.id}" aria-label="Delete this review">Delete</button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}


// REPLACED: Renders reviews for the main product page tab (Summary View) (Part 4)
function renderReviewsSummary() {
    DOMElements.reviewSkeletonLoader.style.display = 'none'; // Hide skeleton loader

    const reviewsToShow = state.reviews; // This already holds max 5 from fetchReviews(0, 5)
    
    // Process the product's overall stats for the dashboard display (not just the 5 reviews)
    processReviewsData(state.reviews, 'main'); 

    if (state.product.total_reviews === 0) {
        DOMElements.reviewsList.innerHTML = '';
        DOMElements.noReviewsMessage.style.display = 'block';
        DOMElements.noReviewsMessage.textContent = 'No reviews yet for this product. Be the first to share your experience!';
        DOMElements.loadMoreReviewsContainer.classList.add('hidden');
        return;
    }
    
    DOMElements.noReviewsMessage.style.display = 'none';

    // 1. Render the top 5 (or fewer) summary reviews
    DOMElements.reviewsList.innerHTML = reviewsToShow.map(createReviewCardHTML).join('');
       // 2. Handle the "View All" button / "End of Reviews" message
    if (state.product.total_reviews > 5) {
        DOMElements.loadMoreReviewsContainer.classList.remove('hidden');
        DOMElements.loadMoreReviewsContainer.innerHTML = `
            <button id="view-all-reviews-btn" 
                class="w-full py-3 px-4 font-bold text-lg rounded-lg shadow-xl 
                       bg-gray-800 text-yellow-300 hover:bg-gray-900 transition-colors">
                VIEW ALL ${state.product.total_reviews.toLocaleString()} REVIEWS AND FILTER ALONG
            </button>
            `;
        // Attach listener for the button *after* it's added to the DOM
        document.getElementById('view-all-reviews-btn').addEventListener('click', () => toggleAllReviewsModal(true));

    
    } else {
        DOMElements.loadMoreReviewsContainer.classList.remove('hidden');
        DOMElements.loadMoreReviewsContainer.innerHTML = `
            <p class="text-center text-gray-500 py-3 mt-4">— This is where the reviews for this product end — more are coming! —</p>
        `;
    }

    // Re-attach listeners for review-specific actions (like, edit, delete)
    attachReviewActionListeners(reviewsToShow);
}


function createProductCardHTML(product) {
    const finalPrice = product.discount_price ?? product.price;
    return `
        <a href="product.html?slug=${product.slug}" class="bg-white rounded-xl shadow-md hover:shadow-xl transition-shadow duration-300 group overflow-hidden border border-gray-200" aria-label="View product: ${product.name}">
            <div class="aspect-square w-full overflow-hidden">
                <img src="${product.image_urls?.[0] || 'https://via.placeholder.com/300?text=Liyog'}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy">
            </div>
            <div class="p-4">
                <h3 class="font-bold text-gray-800 line-clamp-2 text-sm">${product.name}</h3>
                <div class="flex items-center gap-2 mt-2">
                    <div class="flex" role="img" aria-label="${(product.avg_rating || 0).toFixed(1)} out of 5 stars">
                        ${renderStarRatingHTML(product.avg_rating || 0, 'w-4 h-4')}
                    </div>
                    <span class="text-xs text-gray-500">(${(product.total_reviews || 0)})</span>
                </div>
                <p class="text-base font-extrabold text-liyog-green-dark mt-2">₦${finalPrice.toLocaleString()}</p>
            </div>
        </a>
    `;
}


// ===================================================================
// EVENT HANDLERS & UI LOGIC
// ===================================================================

function applyReviewFilter(filterValue) {
    if (state.currentRatingFilter === filterValue && filterValue !== 0) {
        filterValue = 0;
    }
    state.reviewsPage = 1;
    state.reviews = []; // Clear ALL reviews when filter changes
    state.hasMoreReviews = true;
    fetchReviews(filterValue);
}

// Client-side validation for review form
function validateReviewForm(rating, comment, ratingErrorElement, commentErrorElement, commentInput) {
    let isValid = true;
    ratingErrorElement.style.display = 'none';
    commentErrorElement.style.display = 'none';
    commentInput.classList.remove('input-error');

    if (rating === 0) {
        ratingErrorElement.style.display = 'block';
        isValid = false;
    }

    if (comment.length < REVIEW_MIN_LENGTH || comment.length > REVIEW_MAX_LENGTH) {
        commentErrorElement.textContent = `Comment must be between ${REVIEW_MIN_LENGTH} and ${REVIEW_MAX_LENGTH} characters.`;
        commentErrorElement.style.display = 'block';
        commentInput.classList.add('input-error');
        isValid = false;
    }
    return isValid;
}

// Handles review form submission
async function handleReviewFormSubmit(event) {
    event.preventDefault();

    const rating = parseInt(DOMElements.selectedRatingInput.value, 10);
    const comment = DOMElements.reviewCommentInput.value.trim();

    if (!validateReviewForm(rating, comment, DOMElements.ratingError, DOMElements.commentError, DOMElements.reviewCommentInput)) {
        showToast('Please correct the errors in your review.', 'error');
        return;
    }

    DOMElements.submitReviewBtn.disabled = true;
    DOMElements.submitReviewBtn.textContent = 'Submitting...';

    try {
        const { error } = await supabaseClient
            .from('reviews')
            .insert({
                user_id: state.currentUser.id,
                product_id: state.product.id,
                rating: rating,
                comment: comment,
            });

        if (error) {
            console.error('Supabase error:', error);
            throw new Error(error.message || 'An unknown error occurred.');
        }

        showToast('Review submitted successfully!', 'success');
        // Clear form
        DOMElements.reviewForm.reset();
        DOMElements.selectedRatingInput.value = '0';
        document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(radio => {
            radio.checked = false;
            radio.classList.remove('selected');
        });

        // Trigger re-fetch of reviews
        state.reviewsPage = 1;
        state.reviews = [];
        state.hasMoreReviews = true;
        await fetchReviews(state.currentRatingFilter);

        state.product = await fetchProduct(state.product.slug);
        renderProductDetails();

    } catch (error) {
        console.error('Error submitting review:', error);
        showToast(`Failed to submit review: ${error.message}`, 'error');
    } finally {
        DOMElements.submitReviewBtn.disabled = false;
        DOMElements.submitReviewBtn.textContent = 'Submit Review';
    }
}


// Handles liking/unliking individual reviews (UPDATED)
async function handleToggleReviewLike(event) {
    if (!state.currentUser) {
        showToast("Please log in to like reviews.", 'info');
        return;
    }

    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;
    if (!reviewId) return;

    button.disabled = true;

    try {
        const isLikedByUser = state.userLikedReviews.has(reviewId);
        const likesSpan = button.querySelector(`span[data-review-likes="${reviewId}"]`);
        let currentLikes = parseInt(likesSpan.textContent, 10);

        if (isLikedByUser) {
            // Unlike: Delete from user_review_likes and decrement review_likes
            const { error: deleteError } = await supabaseClient
                .from('user_review_likes')
                .delete()
                .eq('user_id', state.currentUser.id)
                .eq('review_id', reviewId);
            if (deleteError) throw deleteError;

            const { error: rpcError } = await supabaseClient.rpc('decrement_review_like', { rid: reviewId }); // Assuming decrement RPC exists
            if (rpcError) throw rpcError;

            state.userLikedReviews.delete(reviewId);
            likesSpan.textContent = currentLikes - 1;
            button.classList.remove('text-liyog-green');
            likesSpan.classList.remove('text-liyog-green');
            button.setAttribute('aria-label', 'Like this review');
            showToast('Review unliked.', 'success');
        } else {
            // Like: Insert into user_review_likes and increment review_likes
            const { error: insertError } = await supabaseClient
                .from('user_review_likes')
                .insert({ user_id: state.currentUser.id, review_id: reviewId });
            if (insertError) throw insertError;

            const { error: rpcError } = await supabaseClient.rpc('increment_review_like', { rid: reviewId });
            if (rpcError) throw rpcError;

            state.userLikedReviews.add(reviewId);
            likesSpan.textContent = currentLikes + 1;
            button.classList.add('text-liyog-green');
            likesSpan.classList.add('text-liyog-green');
            likesSpan.classList.add('glittering-active'); // Apply glitter effect
            setTimeout(() => likesSpan.classList.remove('glittering-active'), 1000); // Remove after short period
            button.setAttribute('aria-label', 'Unlike this review');
            showToast('Review liked!', 'success');
        }

    } catch (error) {
        console.error('Error toggling review like:', error);
        showToast(`Failed to update like status: ${error.message}`, 'error');
    } finally {
        button.disabled = false;
    }
}

// Handles review editing (UPDATED with Modal)
async function handleEditReview(event) {
    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;
    
    if (!state.currentUser) {
        showToast('You must be logged in to edit reviews.', 'info');
        return;
    }
    const reviewToEdit = state.reviews.find(r => r.id === reviewId);
    if (!reviewToEdit || (state.currentUser.id !== reviewToEdit.user.id && state.currentUser.role !== 'admin')) {
        showToast('You do not have permission to edit this review.', 'error');
        return;
    }

    toggleEditReviewModal(true, reviewToEdit); // Open modal with current review data
    DOMElements.editReviewForm.onsubmit = async (e) => {
        e.preventDefault();
        DOMElements.saveEditReviewBtn.disabled = true;
        DOMElements.saveEditReviewBtn.textContent = 'Saving...';

        const newComment = DOMElements.editReviewComment.value.trim();
        const newRating = parseInt(DOMElements.editSelectedRating.value, 10);

        if (!validateReviewForm(newRating, newComment, DOMElements.editRatingError, DOMElements.editCommentError, DOMElements.editReviewComment)) {
            showToast('Please correct the errors in your updated review.', 'error');
            DOMElements.saveEditReviewBtn.disabled = false;
            DOMElements.saveEditReviewBtn.textContent = 'Save Changes';
            return;
        }

        try {
            const { error } = await supabaseClient
                .from('reviews')
                .update({ comment: newComment, rating: newRating, updated_at: new Date().toISOString() })
                .eq('id', reviewId);

            if (error) throw error;

            showToast('Review updated successfully!', 'success');
            toggleEditReviewModal(false); // Close modal

            state.reviewsPage = 1;
            state.reviews = [];
            state.hasMoreReviews = true;
            await fetchReviews(state.currentRatingFilter);

            state.product = await fetchProduct(state.product.slug);
            renderProductDetails();

        } catch (error) {
            console.error('Error updating review:', error);
            showToast(`Failed to update review: ${error.message}`, 'error');
        } finally {
            DOMElements.saveEditReviewBtn.disabled = false;
            DOMElements.saveEditReviewBtn.textContent = 'Save Changes';
        }
    };
}


// Handles review deletion
async function handleDeleteReview(event) {
    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;

    if (!state.currentUser) {
        showToast('You must be logged in to delete reviews.', 'info');
        return;
    }

    const reviewToDelete = state.reviews.find(r => r.id === reviewId);
    if (!reviewToDelete || (state.currentUser.id !== reviewToDelete.user.id && state.currentUser.role !== 'admin')) {
        showToast('You do not have permission to delete this review.', 'error');
        return;
    }

    if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('reviews')
            .delete()
            .eq('id', reviewId);

        if (error) throw error;

        showToast('Review deleted successfully!', 'success');
        state.reviewsPage = 1;
        state.reviews = [];
        state.hasMoreReviews = true;
        await fetchReviews(state.currentRatingFilter);

        state.product = await fetchProduct(state.product.slug);
        renderProductDetails();

    } catch (error) {
        console.error('Error deleting review:', error);
        showToast(`Failed to delete review: ${error.message}`, 'error');
    }
}


function setupEventHandlers() {
    DOMElements.qtyIncrement.addEventListener('click', () => {
        let currentVal = parseInt(DOMElements.quantityInput.value, 10);
        DOMElements.quantityInput.value = currentVal + 1;
    });

    DOMElements.qtyDecrement.addEventListener('click', () => {
        let currentVal = parseInt(DOMElements.quantityInput.value, 10);
        DOMElements.quantityInput.value = Math.max(1, currentVal - 1);
    });


    const handleAddToCart = () => {
        console.log('Add to cart clicked', {
            productId: state.product.id,
            quantity: DOMElements.quantityInput.value
        });
        showToast(`Added ${DOMElements.quantityInput.value} x "${state.product.name}" to cart! (Placeholder)`, 'success');
    };
    DOMElements.addToCartBtn.addEventListener('click', handleAddToCart);
    DOMElements.mobileAddToCartBtn.addEventListener('click', handleAddToCart);
    
    const handleOrderNow = () => {
        console.log('Order now clicked', {
            productId: state.product.id,
            quantity: DOMElements.quantityInput.value
        });
        showToast(`Ordering ${DOMElements.quantityInput.value} x "${state.product.name}" now! (Placeholder)`, 'success');
    };
    DOMElements.orderNowBtn.addEventListener('click', handleOrderNow);
    DOMElements.mobileOrderNowBtn.addEventListener('click', handleOrderNow);


    DOMElements.likeBtn.addEventListener('click', handleToggleLike);
    DOMElements.shareBtn.addEventListener('click', handleShare);
    DOMElements.copyUrlBtn.addEventListener('click', handleCopyUrl); // NEW


    DOMElements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            DOMElements.tabButtons.forEach(btn => {
                btn.classList.remove('tab-btn-active', 'border-liyog-green', 'text-liyog-green-dark');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                btn.setAttribute('aria-selected', 'false');
            });
            button.classList.add('tab-btn-active', 'border-liyog-green', 'text-liyog-green-dark');
            button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            button.setAttribute('aria-selected', 'true');


            DOMElements.tabContents.forEach(content => content.classList.add('hidden'));
            const targetTabContent = document.getElementById(`tab-content-${button.dataset.tab}`);
            targetTabContent.classList.remove('hidden');


            if (button.dataset.tab === 'reviews') {
                renderReviewForm();
                // Focus the relevant element in the reviews tab
                if (state.currentUser) {
                    DOMElements.reviewCommentInput.focus();
                } else {
                    DOMElements.loginToReviewMessage.querySelector('a').focus();
                }
            }
        });
    });


    // Review form event listeners
    DOMElements.reviewForm.addEventListener('submit', handleReviewFormSubmit);
    document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            DOMElements.selectedRatingInput.value = e.target.value;
            DOMElements.ratingError.style.display = 'none'; // Hide error on selection
            document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(r => {
                if (r.checked) {
                    r.classList.add('selected');
                } else {
                    r.classList.remove('selected');
                }
            });
        });
    });
    DOMElements.reviewCommentInput.addEventListener('input', () => {
        DOMElements.reviewCommentInput.classList.remove('input-error');
        DOMElements.commentError.style.display = 'none';
    });


// NEW: Infinite scroll for the modal (Add this anywhere near your other listeners)
DOMElements.modalReviewsListWrapper.addEventListener('scroll', () => {
    const listEl = DOMElements.modalReviewsListWrapper;

    // Check if user has scrolled near the bottom (100px buffer)
    if (state.isModalOpen && state.modalHasMoreReviews && 
        (listEl.scrollTop + listEl.clientHeight >= listEl.scrollHeight - 100)) {
        
        fetchModalReviews();
    }
});
    
    // Filter buttons for ratings dashboard
    DOMElements.filterRatingBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const filterValue = parseInt(btn.dataset.ratingFilter, 10);
            applyReviewFilter(filterValue);
        });
    });


    // Media navigation arrows
    DOMElements.mediaPrevBtn.addEventListener('click', () => {
        if (state.currentMediaIndex > 0) {
            state.currentMediaIndex--;
            renderMainMedia(state.currentMediaIndex, state.mediaItems);
            DOMElements.thumbnailsWrapper.children[state.currentMediaIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('thumb-active'));
            DOMElements.thumbnailsWrapper.children[state.currentMediaIndex].classList.add('thumb-active');
        }
    });
    DOMElements.mediaNextBtn.addEventListener('click', () => {
        if (state.currentMediaIndex < state.mediaItems.length - 1) {
            state.currentMediaIndex++;
            renderMainMedia(state.currentMediaIndex, state.mediaItems);
            DOMElements.thumbnailsWrapper.children[state.currentMediaIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            DOMElements.thumbnailsWrapper.querySelectorAll('.thumbnail-btn').forEach(b => b.classList.remove('thumb-active'));
            DOMElements.thumbnailsWrapper.children[state.currentMediaIndex].classList.add('thumb-active');
        }
    });


    // Edit review modal buttons
    DOMElements.cancelEditReviewBtn.addEventListener('click', () => toggleEditReviewModal(false));
    
    
    // =========================================================
    // NEW FIX: Reviews Modal Close Listeners (Action 1.2)
    // =========================================================
    const modalOverlay = document.getElementById('modal-overlay');
    const modalCloseButton = document.getElementById('modal-close-button');

    if (modalOverlay) {
        // Clicks outside the modal content
        modalOverlay.addEventListener('click', () => toggleAllReviewsModal(false));
    }
    if (modalCloseButton) {
        // Clicks the 'X' button inside the modal
        modalCloseButton.addEventListener('click', () => toggleAllReviewsModal(false));
    }
    // =========================================================    
}

// Attaches event listeners for dynamically rendered review cards

function attachReviewActionListeners() {
document.querySelectorAll('.review-like-btn').forEach(button => {
        button.removeEventListener('click', handleToggleReviewLike); // Prevent duplicates
        button.addEventListener('click', handleToggleReviewLike);
    });  document.querySelectorAll('.review-edit-btn').forEach(button => {
        button.removeEventListener('click', handleEditReview); // Prevent duplicates
        button.addEventListener('click', handleEditReview);
    });
    document.querySelectorAll('.review-delete-btn').forEach(button => {
        button.removeEventListener('click', handleDeleteReview); // Prevent duplicates
        button.addEventListener('click', handleDeleteReview);
    });
}

// Renders the review submission form based on user login status
function renderReviewForm() {
    if (state.currentUser) {
        DOMElements.addReviewFormSection.style.display = 'block';
        DOMElements.loginToReviewMessage.style.display = 'none'; // Hide login message
        DOMElements.currentUserNameReviewForm.textContent = state.currentUser.name || state.currentUser.email;
        if (state.currentUser.profile_image) {
            DOMElements.userAvatarReviewForm.innerHTML = `<img src="${state.currentUser.profile_image}" alt="${state.currentUser.name}'s profile" class="w-full h-full object-cover rounded-full" loading="lazy">`;
        } else {
            DOMElements.userAvatarReviewForm.innerHTML = generateAvatar(state.currentUser.name, 'w-10 h-10', 'text-lg');
        }
        // Render interactive stars for the form
        DOMElements.reviewRatingInput.innerHTML = renderStarRatingHTML(0, 'w-6 h-6', true, 'review-rating');
        // Attach change listener for the dynamically rendered radio buttons
        document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                DOMElements.selectedRatingInput.value = e.target.value;
                DOMElements.ratingError.style.display = 'none';
                document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(r => {
                    if (r.checked) {
                        r.classList.add('selected');
                    } else {
                        r.classList.remove('selected');
                    }
                });
            });
        });

    } else {
        DOMElements.addReviewFormSection.style.display = 'none';
        DOMElements.loginToReviewMessage.style.display = 'block'; // Show login message
    }
}

function renderModalReviewComposer() {
    const composerEl = document.getElementById('modal-review-composer');
    if (!composerEl) return;

    if (state.currentUser) {
        // User is logged in: Show the concise review form
        composerEl.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-liyog-green flex items-center justify-center text-white font-bold text-sm">${state.currentUser.display_name[0] || 'U'}</div>
                <form id="modal-review-form" class="flex-grow">
                    <input type="number" id="modal-selected-rating-input" class="hidden" value="0">
                    
                    <div class="flex items-center gap-2 mb-2">
                        <div id="modal-review-rating-input" class="flex">
                            ${Array.from({ length: 5 }, (_, i) => `
                                <input type="radio" id="modal-star-${5 - i}" name="modal-rating" value="${5 - i}" class="hidden">
                                <label for="modal-star-${5 - i}" class="text-gray-300 hover:text-yellow-400 transition-colors cursor-pointer" data-rating="${5 - i}">
                                    <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="${i < state.reviewForm.rating ? 'M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.62L12 2L9.19 8.62L2 9.24L7.46 13.97L5.82 21L12 17.27Z' : 'M12 15.4L18.18 19.3L16.54 12.5L22 8.5L15.34 7.97L12 2L8.66 7.97L2 8.5L7.46 12.5L5.82 19.3L12 15.4ZM12 13.3L10.23 14.5L10.74 12.44L9.17 11.16L11.23 11.03L12 9.1L12.77 11.03L14.83 11.16L13.26 12.44L13.77 14.5L12 13.3Z'}"/></svg>
                                </label>
                            `).join('')}
                        </div>
                        <span id="modal-rating-error" class="text-sm text-red-500 hidden">Select rating.</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="text" id="modal-review-comment-input" placeholder="Write a quick review..." 
                               class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-liyog-green focus:border-liyog-green text-sm" 
                               maxlength="500">
                        <button type="submit" id="modal-submit-review-btn" class="px-3 py-1 bg-liyog-green text-white rounded-lg font-semibold hover:bg-liyog-green-dark transition-colors text-sm">Post</button>
                    </div>
                    <span id="modal-comment-error" class="text-sm text-red-500 hidden">Comment required.</span>
                </form>
            </div>
        `;
        // Attach form listeners for the modal form
        setupModalReviewFormHandlers();

    } else {
        // Guest user: Show login/register button
        const referralQuery = state.referralCode ? `&ref=${state.referralCode}` : '';
        composerEl.innerHTML = `
            <p class="text-center text-gray-600 mb-3">Want to drop a review?</p>
            <a href="login.html?redirect=product.html?slug=${state.product.slug}${referralQuery}" 
               class="block text-center w-full py-2 px-4 bg-liyog-green text-white rounded-lg font-semibold hover:bg-liyog-green-dark transition-colors">
                Login or Register to Post a Review
            </a>
        `;
    }
}


function setupModalReviewFormHandlers() {
    const form = document.getElementById('modal-review-form');
    if (!form) return;

    // 1. Rating input handler (similar to the main form)
    document.querySelectorAll('#modal-review-rating-input label').forEach(label => {
        label.addEventListener('click', (e) => {
            const rating = parseInt(label.dataset.rating, 10);
            document.getElementById('modal-selected-rating-input').value = rating;
            document.getElementById('modal-rating-error').classList.add('hidden');
            
            // Visual update
            document.querySelectorAll('#modal-review-rating-input svg').forEach(svg => {
                const starRating = parseInt(svg.parentElement.getAttribute('for').split('-')[1], 10);
                // Simple star fill logic (assuming you have a render function or style in place)
                svg.classList.toggle('text-yellow-400', starRating <= rating);
                svg.classList.toggle('text-gray-300', starRating > rating);
            });
        });
    });

    // 2. Submission handler
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rating = parseInt(document.getElementById('modal-selected-rating-input').value, 10);
        const comment = document.getElementById('modal-review-comment-input').value.trim();

        if (rating === 0) {
            document.getElementById('modal-rating-error').classList.remove('hidden');
            return;
        }
        if (comment.length < 5) { // Simple validation
            document.getElementById('modal-comment-error').classList.remove('hidden');
            return;
        }

        // Disable button during submission
        const submitBtn = document.getElementById('modal-submit-review-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Posting...';

        try {
            await handleReviewSubmission(rating, comment); // Reuse your main submission logic
            
            // Success: Clear form and show toast
            document.getElementById('modal-review-comment-input').value = '';
            document.getElementById('modal-selected-rating-input').value = 0;
            // Clear visual rating selection here
            document.querySelectorAll('#modal-review-rating-input svg').forEach(svg => {
                svg.classList.remove('text-yellow-400');
                svg.classList.add('text-gray-300');
            });

            showToast('Review posted successfully!', 'success');
            
            // The realtime listener should handle re-fetching and re-rendering the modal list.
        } catch (error) {
            console.error("Modal review submission failed:", error);
            showToast(error.message || 'Failed to post review.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Post';
        }
    });
}


// REWRITTEN handleLike function for toggle and DB-only counter update
async function handleToggleLike() {
    DOMElements.likeBtn.disabled = true;

    if (!state.currentUser) {
        showToast("Please log in to like products.", 'info');
        DOMElements.likeBtn.disabled = false;
        return;
    }
    
    const productId = state.product.id;
    const userId = state.currentUser.id;
    
    const existingLikeId = await getExistingLike(productId, userId);
    
    let action = '';

    try {
        if (existingLikeId) {
            const { error } = await supabaseClient
                .from('likes')
                .delete()
                .eq('id', existingLikeId);
            
            if (error) throw error;
            action = 'unliked';

        } else {
            const { error } = await supabaseClient
                .from('likes')
                .insert({ user_id: userId, product_id: productId });
            
            if (error) throw error;
            action = 'liked';
        }
        
        const { data: updatedProduct, error: fetchError } = await supabaseClient
            .from('products')
            .select('total_likes')
            .eq('id', productId)
            .single();

        if (fetchError) {
             console.error("Failed to re-fetch likes count:", fetchError);
             if (action === 'liked') state.isLiked = true; else state.isLiked = false;
        } else {
            state.product.total_likes = updatedProduct.total_likes;
            state.isLiked = (action === 'liked');
        }
        
        renderProductDetails();
        showToast(`Product ${action} successfully!`, 'success');

    } catch (error) {
        console.error(`Failed to ${action} product:`, error);
        showToast(`Could not save your action: ${error.message}`, 'error');
    } finally {
        DOMElements.likeBtn.disabled = false;
    }
}


async function handleShare() {
    let referralCode = '';
    if (state.currentUser && !state.currentUser.referral_code) {
        try {
            const { data, error } = await supabaseClient
                .from('users')
                .select('referral_code')
                .eq('id', state.currentUser.id)
                .single();
            if (data && data.referral_code) {
                state.currentUser.referral_code = data.referral_code;
            } else if (error && error.code !== 'PGRST116') {
                 console.warn("Error fetching referral code:", error.message);
            }
        } catch (error) {
            console.error("Failed to fetch referral code:", error);
        }
    }
    referralCode = state.currentUser?.referral_code || '';
    
    let shareUrl = `${window.location.origin}${window.location.pathname}?slug=${state.product.slug}`;
    if (referralCode) {
        shareUrl += `&ref=${referralCode}`;
    }

    if (navigator.share) {
        navigator.share({
            title: state.product.name,
            text: `Check out this product on Liyog: ${state.product.name}`,
            url: shareUrl,
        }).catch((error) => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('Product link copied to clipboard!', 'success');
        }).catch((error) => {
            console.error('Failed to copy link:', error);
            showToast('Could not copy link to clipboard. Please copy it manually: ' + shareUrl, 'error');
        });
    }
}

// NEW: Handle Copy URL button
async function handleCopyUrl() {
    let url = `${window.location.origin}${window.location.pathname}?slug=${state.product.slug}`;
     if (state.currentUser?.referral_code) {
        url += `&ref=${state.currentUser.referral_code}`;
    }

    try {
        await navigator.clipboard.writeText(url);
        showToast('Product URL copied to clipboard!', 'success');
    } catch (error) {
        console.error('Failed to copy URL:', error);
        showToast('Could not copy URL to clipboard. Please copy it manually.', 'error');
    }
}


// ===================================================================
// REALTIME SUBSCRIPTIONS
// ===================================================================
function setupSupabaseRealtimeReviews() {
    if (!state.product) return;

    supabaseClient
        .channel(`product_reviews:${state.product.id}`)
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'reviews', filter: `product_id=eq.${state.product.id}` },
        
async (payload) => {
                console.log('Realtime change received:', payload);
                
                // Always re-fetch the product stats on insert/delete for correct counts
                if (payload.eventType === 'INSERT' || payload.eventType === 'DELETE' || payload.eventType === 'UPDATE') {
                    state.product = await fetchProduct(state.product.slug);
                    renderProductDetails();
                }
                
                // Re-fetch the current view (summary or modal)
                if(state.isModalOpen) {
                    state.modalReviewsPage = 1;
                    state.modalReviews = [];
                    state.modalHasMoreReviews = true;
                    fetchModalReviews(); // Re-fetch the filtered/paginated modal list
                } else {
                    // Re-fetch only the summary reviews for the main tab
                    await fetchReviews(state.currentRatingFilter, 5); 
                }
            }  
          )
        .subscribe();
    console.log(`Subscribed to realtime changes for product reviews: ${state.product.id}`);
}


// ===================================================================
// APPLICATION BOOTSTRAP
// ===================================================================

document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('footer-year').textContent = new Date().getFullYear();
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug');

    if (!slug) {
        DOMElements.loader.classList.add('hidden');
        document.getElementById('main-content').innerHTML = `
            <div class="text-center p-10 bg-white rounded-lg shadow-md max-w-lg mx-auto mt-10">
                <h1 class="text-3xl font-bold text-red-600 mb-4">Product Not Found</h1>
                <p class="text-gray-700 text-lg mb-6">It looks like the product you're looking for doesn't exist or the link is invalid.</p>
                <a href="products.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    Back to Shop
                </a>
            </div>
        `;
        return;
    }

    try {
        await Promise.all([
            fetchCurrentUser(),
            fetchSettings()
        ]);
        
        state.product = await fetchProduct(slug);
        
        if (state.product) {
            const { error: rpcError } = await supabaseClient
                .rpc('increment_product_views', { pid: state.product.id }); 
            if (rpcError) {
                console.error("Failed to increment product views via RPC:", rpcError);
            }
        }

        if (state.currentUser && state.product) {
            const existingLikeId = await getExistingLike(state.product.id, state.currentUser.id);
            if (existingLikeId) {
                state.isLiked = true;
            }
        }

        renderProductDetails();
        renderMediaGallery();
   
     await Promise.all([
            (async () => {
                const initialReviews = await fetchReviews(0, 5); // Fetch first 5 for summary
                // Note: renderReviewsSummary is called inside fetchReviews now
            })(),
            (async () => {
                const related = await fetchRelatedProducts(state.product);
                if (related && related.length > 0) {
                    DOMElements.relatedProductsSection.classList.remove('hidden');
                    DOMElements.relatedProductsCarousel.innerHTML = related.map(createProductCardHTML).join('');
                }
            })(),
            (async () => {
                const youMayLike = await fetchYouMayLikeProducts();
                DOMElements.youMayLikeCarousel.innerHTML = youMayLike.map(createProductCardHTML).join('');
            })()
        ]);

        setupSupabaseRealtimeReviews();

        DOMElements.loader.classList.add('hidden');
        DOMElements.content.classList.remove('hidden');

        setupEventHandlers();

    } catch (error) {
        console.error("Initialization Error:", error);
        DOMElements.loader.classList.add('hidden');
        document.getElementById('main-content').innerHTML = `
            <div class="text-center p-10 bg-white rounded-lg shadow-md max-w-lg mx-auto mt-10">
                <h1 class="text-3xl font-bold text-red-600 mb-4">Error Loading Product</h1>
                <p class="text-gray-700 text-lg mb-6">${error.message || 'An unexpected error occurred. Please try again later.'}</p>
                <a href="products.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    Back to Shop
                </a>
            </div>
        `;
        showToast(`Failed to load product: ${error.message}`, 'error');
    }
});

// --- ENHANCED: Smart Gallery Navigation Controls ---
const galleryPrevBtn = document.getElementById('gallery-prev');
const galleryNextBtn = document.getElementById('gallery-next');

function getMediaGallery() {
  // The horizontally scrollable area is the thumbnails container — use it for arrow visibility and scrolling.
  return document.getElementById('thumbnails-container') || document.getElementById('media-gallery');
}

// Hide/Show arrows based on scroll position
function updateGalleryArrowVisibility() {
  const gallery = getMediaGallery();
  if (!gallery || !galleryPrevBtn || !galleryNextBtn) return;
  const maxScrollLeft = Math.max(0, gallery.scrollWidth - gallery.clientWidth);
  const buffer = 8; // small buffer to avoid jitter
  if (gallery.scrollLeft <= buffer) {
    galleryPrevBtn.classList.add('opacity-0', 'pointer-events-none');
  } else {
    galleryPrevBtn.classList.remove('opacity-0', 'pointer-events-none');
  }
  if (gallery.scrollLeft >= maxScrollLeft - buffer) {
    galleryNextBtn.classList.add('opacity-0', 'pointer-events-none');
  } else {
    galleryNextBtn.classList.remove('opacity-0', 'pointer-events-none');
  }
}

// --- NEW FUNCTION: Keeps main viewer, thumbnails, and arrows in sync ---
function syncGalleryState(newIndex) {
  state.currentMediaIndex = newIndex;
  renderMainMedia(state.currentMediaIndex, state.mediaItems);

  const thumbContainer = document.getElementById('thumbnails-container');
  if (!thumbContainer) return;

  const thumbnails = thumbContainer.querySelectorAll('.thumbnail-btn');
  thumbnails.forEach((b) => b.classList.remove('thumb-active'));

  const activeThumb = thumbnails[state.currentMediaIndex];
  if (activeThumb) {
    activeThumb.classList.add('thumb-active');
    activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

  // Ensure arrow visibility stays correct
  updateGalleryArrowVisibility();
}


// Scroll behavior handlers
galleryPrevBtn?.addEventListener('click', () => {
  if (state.currentMediaIndex > 0) {
    syncGalleryState(state.currentMediaIndex - 1);
  }
});

galleryNextBtn?.addEventListener('click', () => {
  if (state.currentMediaIndex < state.mediaItems.length - 1) {
    syncGalleryState(state.currentMediaIndex + 1);
  }
});



// Update arrow visibility on scroll or resize
window.addEventListener('resize', updateGalleryArrowVisibility);
document.addEventListener('DOMContentLoaded', () => {
  const gallery = getMediaGallery();
  if (gallery) {
    // When thumbnails scroll horizontally, update arrow visibility
    gallery.addEventListener('scroll', updateGalleryArrowVisibility, { passive: true });
    // Initialize arrow visibility on load
    updateGalleryArrowVisibility();
  }
});

</script>
<script src="/liyogstore/global-error.js"></script>

<div id="all-reviews-modal" class="hidden fixed inset-0 z-50 transition-opacity duration-300 ease-out opacity-0" aria-modal="true" role="dialog" aria-labelledby="modal-title">

    <div id="modal-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 transition-opacity"></div>

    <div class="absolute bottom-0 w-full max-h-[90%] bg-white rounded-t-2xl shadow-2xl transition-transform duration-300 ease-out

                md:relative md:max-w-3xl md:mx-auto md:my-10 md:rounded-xl md:translate-y-0

                transform translate-y-full" id="all-reviews-modal-content">

        <div class="p-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10 rounded-t-2xl md:rounded-xl">

            <h2 id="modal-title" class="text-xl font-bold text-gray-900">All Product Reviews</h2>

            <button type="button" id="modal-close-button" class="text-gray-400 hover:text-gray-600 p-1 transition-colors" aria-label="Close reviews modal">

                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="p-4 bg-gray-50 border-b border-gray-100 sticky top-[57px] md:top-[57px] z-10">

             <div class="flex items-center gap-4 mb-4">

                <span class="text-4xl font-extrabold text-gray-900" id="modal-overall-avg-rating">0.0</span>

                <div class="flex flex-col">
                    <div class="flex" id="modal-overall-star-rating" role="img" aria-label="Overall star rating">
                        </div>
                    <span class="text-sm text-gray-500" id="modal-overall-total-reviews-count">0 Reviews</span>
                </div>
            </div>
            <div id="modal-ratings-distribution-chart" class="space-y-2">

                </div>
        </div>

        <div id="modal-reviews-list-wrapper" class="p-4 overflow-y-auto" style="max-height: calc(90vh - 200px);" role="log" aria-live="polite">
 <div id="modal-reviews-list" class="space-y-4">

                </div>

            <div id="modal-review-skeleton-loader" class="space-y-4 pt-4 hidden">

                 <div class="animate-pulse flex gap-4 p-4 bg-gray-100 rounded-lg shadow-sm"><div class="w-10 h-10 rounded-full bg-gray-300"></div><div class="flex-1 space-y-3"><div class="h-3 bg-gray-300 rounded w-1/4"></div><div class="h-3 bg-gray-300 rounded"></div><div class="h-3 bg-gray-300 rounded w-2/3"></div></div></div>

                 <div class="animate-pulse flex gap-4 p-4 bg-gray-100 rounded-lg shadow-sm"><div class="w-10 h-10 rounded-full bg-gray-300"></div><div class="flex-1 space-y-3"><div class="h-3 bg-gray-300 rounded w-1/3"></div><div class="h-3 bg-gray-300 rounded"></div><div class="h-3 bg-gray-300 rounded w-1/2"></div></div></div>

                 <div class="animate-pulse flex gap-4 p-4 bg-gray-100 rounded-lg shadow-sm"><div class="w-10 h-10 rounded-full bg-gray-300"></div><div class="flex-1 space-y-3"><div class="h-3 bg-gray-300 rounded w-1/5"></div><div class="h-3 bg-gray-300 rounded"></div><div class="h-3 bg-gray-300 rounded w-3/4"></div></div></div>

            </div>

            <div id="modal-no-reviews-message" class="hidden text-center text-gray-500 p-8">No reviews match the current filter.</div>

            <div id="modal-end-of-reviews-message" class="hidden text-center text-gray-500 p-4 font-medium">— You've reached the end of the available reviews. —</div>

        </div>

<div id="modal-review-composer" class="sticky bottom-0 bg-white p-4 border-t border-gray-100 shadow-xl z-20">

    </div>
    </div>
</div>

</body>
</html>



