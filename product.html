<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details â€¢ Liyog</title>
    <meta name="description" content="Explore product details, reviews, and offers on Liyog.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ¿</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            --liyog-green: #28A428;
            --liyog-green-light: #34bf49;
            --liyog-green-dark: #228B22;
            --liyog-deep-green: #006400;
            --liyog-gold: #ffd700;
            --liyog-orange: #ff7a00;
            --font-stack: 'Inter', sans-serif;
        }
        body { 
            font-family: var(--font-stack); 
            background-color: #f8fafc;
            color: #1e293b; 
        }
        .shimmer::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, 
                rgba(255, 255, 255, 0) 0%, 
                rgba(255, 255, 255, 0.1) 20%, 
                rgba(255, 255, 255, 0.4) 60%, 
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 1.8s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Enhanced thumbnail active state */
        .thumb-active {
            outline: 3px solid var(--liyog-green);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(40, 164, 40, 0.3);
            transform: scale(1.05);
            transition: all 0.2s ease-out;
        }
        .tab-btn-active {
            color: var(--liyog-green-dark);
            font-weight: 700;
            border-color: var(--liyog-green);
        }
        .like-icon-filled {
            color: #ef4444; /* red-500 */
        }
        .responsive-iframe-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .responsive-iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* NEW: Styles for the innovative reviews section */
        .star-rating-input input[type="radio"] { display: none; }
        .star-rating-input label {
            cursor: pointer;
            font-size: 0;
            color: #e5e7eb;
            transition: color 0.2s ease-in-out;
            padding: 2px;
        }
        .star-rating-input label svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label { color: var(--liyog-gold); }
        .star-rating-input input[type="radio"]:checked ~ label { color: var(--liyog-gold); }
        .star-rating-input input[type="radio"]:checked + label { color: var(--liyog-gold); }
        .star-rating-input {
            direction: rtl;
            display: inline-flex;
        }
        .star-rating-input > label:hover,
        .star-rating-input > label:hover ~ label,
        .star-rating-input > input.selected ~ label,
        .star-rating-input > input:checked ~ label { color: var(--liyog-gold); }
        .star-rating-input label:hover svg,
        .star-rating-input label:hover ~ label svg,
        .star-rating-input input[type="radio"]:checked ~ label svg { fill: var(--liyog-gold); }
        .star-rating-input label:before {
            content: "\2605";
            font-size: 1.5rem;
            margin-left: 2px;
            visibility: hidden;
        }
        .star-rating-input label svg { visibility: visible; }

        /* Glittering effect for helpful count - Enhanced for visibility */
        .glittering-number {
            position: relative;
            display: inline-block;
            overflow: hidden;
            font-weight: bold; /* Make it bolder */
            color: var(--liyog-gold); /* Default color for better visibility */
        }
        .glittering-active {
            animation: glitter 1s ease-out forwards; /* Shorter, more punchy glitter */
        }
        @keyframes glitter {
            0% { transform: scale(1); opacity: 1; text-shadow: 0 0 5px var(--liyog-gold); }
            50% { transform: scale(1.2); opacity: 0.8; text-shadow: 0 0 15px var(--liyog-gold), 0 0 25px rgba(255,215,0,0.5); }
            100% { transform: scale(1); opacity: 1; text-shadow: none; }
        }

        /* Bar chart for ratings distribution */
        .rating-bar {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .rating-fill {
            height: 100%;
            background-color: var(--liyog-green-light);
            border-radius: 5px;
            transition: width 0.3s ease-out;
        }
        .rating-bar-value {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            background-color: transparent;
            width: 100%;
            cursor: pointer;
        }
        .rating-bar-value:hover .rating-fill { background-color: var(--liyog-green-dark); }
        .rating-bar-wrapper.active .rating-fill { background-color: var(--liyog-deep-green); }
        
        /* Dynamic Avatar */
        .avatar-initials {
            background-color: var(--liyog-green-light);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-radius: 9999px;
        }

        /* Skeleton Loader Enhancements */
        .skeleton-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .skeleton-media-item {
            width: 80px;
            height: 80px;
            background-color: #e2e8f0; /* gray-200 */
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .skeleton-main-media {
            aspect-square w-full bg-gray-200 rounded-lg h-full relative overflow-hidden;
        }

        /* Chart text color for visibility */
        #ratings-distribution-chart .text-gray-200 {
            color: #d1d5db; /* A lighter gray for better contrast on dark green */
        }
        #ratings-distribution-chart .text-gray-800 {
            color: #f8fafc; /* White/very light for numbers on bars */
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); /* Add slight shadow for readability */
        }
        
        /* Added for review form error styling */
        .input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }

        /* Modal Styles (basic for now, can be enhanced with Tailwind) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }

        /* Media Gallery Arrows */
        .media-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .media-arrow:hover { opacity: 1; }
        .media-arrow.left { left: 0.5rem; }
        .media-arrow.right { right: 0.5rem; }
        .media-arrow svg { width: 1.5rem; height: 1.5rem; }

        /* Two-row thumbnails */
        #thumbnails-wrapper.two-rows {
            display: grid;
            grid-auto-flow: column; /* Allows horizontal scrolling with variable columns */
            grid-template-rows: repeat(2, minmax(0, 1fr)); /* Two rows */
            grid-auto-columns: 80px; /* Each thumbnail takes 80px width */
            gap: 0.75rem; /* gap-3 */
            overflow-x: auto;
            padding-bottom: 0.5rem; /* pb-2 */
            scroll-snap-type: x mandatory; /* Optional: for smoother scrolling */
            scroll-padding: 0.5rem;
        }
        #thumbnails-wrapper.two-rows .thumbnail-btn {
            scroll-snap-align: start;
            margin-bottom: 0; /* Remove default margin-bottom from flex */
        }

        /* Review like bubbles animation */
        .like-bubble, .dislike-bubble {
            position: absolute;
            animation: floatAndFade 1.5s ease-out forwards;
            pointer-events: none;
            font-size: 1.5rem;
            opacity: 0;
            transform: translate(-50%, 0) scale(0.5);
        }
        .like-bubble { color: hotpink; }
        .dislike-bubble { color: gray; }

        @keyframes floatAndFade {
            0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -20px) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -60px) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -80px) scale(0.8); }
        }

        /* Bottom Sheet / Full Reviews Modal */
        .bottom-sheet-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: flex-end; /* Align to bottom for mobile */
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .bottom-sheet-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet-content {
            background-color: white;
            width: 100%;
            max-height: 90%; /* Limit height for mobile */
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(100%); /* Start off-screen */
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* For inner scrolling */
        }
        .bottom-sheet-modal.open .bottom-sheet-content {
            transform: translateY(0);
        }

        /* Desktop specific styles for the bottom sheet */
        @media (min-width: 1024px) { /* Adjust breakpoint as needed, e.g., lg */
            .bottom-sheet-modal {
                align-items: center; /* Center vertically for desktop */
            }
            .bottom-sheet-content {
                max-width: 768px; /* max-w-2xl */
                max-height: 80%;
                border-radius: 0.75rem; /* rounded-lg */
                transform: translateY(-20px); /* Slightly off-center for entrance animation */
            }
            .bottom-sheet-modal.open .bottom-sheet-content {
                transform: translateY(0);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        liyog: {
                            green: 'var(--liyog-green)',
                            'green-light': 'var(--liyog-green-light)',
                            'green-dark': 'var(--liyog-green-dark)',
                            'deep-green': 'var(--liyog-deep-green)',
                            gold: 'var(--liyog-gold)',
                            orange: 'var(--liyog-orange)',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-in-up': 'slideInUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20%)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                    },
                },
            },
        }
    </script>
</head>

<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-50">
        <nav class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="products.html" class="text-gray-600 hover:text-liyog-green transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </a>
                <a href="/" class="text-2xl font-extrabold text-liyog-green">Liyog</a>
                <a href="/cart/" class="relative text-gray-600 hover:text-liyog-green transition-colors">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count" class="absolute -top-1 -right-2 bg-liyog-orange text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                </a>
            </div>
        </nav>
    </header>

    <main id="main-content" class="max-w-screen-xl mx-auto py-6 sm:py-10 px-4 sm:px-6 lg:px-8">
        <div id="skeleton-loader">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                <div class="relative overflow-hidden">
                    <div class="aspect-square w-full bg-gray-200 rounded-lg shimmer"></div>
                    <div class="skeleton-media-grid">
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer"></div>
                        <div class="skeleton-media-item shimmer hidden sm:block"></div>
                        <div class="skeleton-media-item shimmer hidden lg:block"></div>
                        <div class="skeleton-media-item shimmer hidden sm:block"></div>
                        <div class="skeleton-media-item shimmer hidden lg:block"></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                    <div class="h-10 bg-gray-200 rounded w-full shimmer"></div>
                    <div class="h-10 bg-gray-200 rounded w-5/6 shimmer"></div>
                    <div class="flex items-center gap-4">
                        <div class="h-5 bg-gray-200 rounded w-1/3 shimmer"></div>
                        <div class="h-5 bg-gray-200 rounded w-1/4 shimmer"></div>
                    </div>
                    <div class="flex gap-3 mt-4 hide-scrollbar overflow-x-auto pb-2">
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-20 shimmer"></div>
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-24 shimmer"></div>
                        <div class="px-3 py-1 bg-gray-200 rounded-full w-16 shimmer"></div>
                    </div>
                    <div class="my-6 bg-gray-100 p-4 rounded-lg border h-24 shimmer"></div>
                    <div class="h-14 bg-gray-200 rounded-lg w-full shimmer"></div>
                    <div class="h-14 bg-gray-200 rounded-lg w-full shimmer"></div>
                    <div class="flex items-center gap-4 mt-6">
                        <div class="h-8 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-8 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-8 bg-gray-200 rounded w-20 ml-auto shimmer"></div>
                    </div>
                </div>
            </div>
            <div class="mt-16 bg-white p-6 rounded-lg border">
                <div class="border-b border-gray-200 pb-4 mb-4">
                    <div class="-mb-px flex space-x-8">
                        <div class="h-6 bg-gray-200 rounded w-24 shimmer"></div>
                        <div class="h-6 bg-gray-200 rounded w-24 shimmer"></div>
                    </div>
                </div>
                <div class="py-6 space-y-3">
                    <div class="h-4 bg-gray-200 rounded w-full shimmer"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6 shimmer"></div>
                    <div class="h-4 bg-gray-200 rounded w-full"></div>
                    <div class="h-4 bg-gray-200 rounded w-4/5"></div>
                </div>
            </div>
            <div class="mt-16">
                <div class="h-8 bg-gray-200 rounded w-1/3 mb-6 shimmer"></div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden md:block"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden lg:block"></div>
                </div>
            </div>
             <div class="mt-16">
                <div class="h-8 bg-gray-200 rounded w-1/3 mb-6 shimmer"></div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden md:block"></div>
                    <div class="bg-white rounded-xl shadow-md overflow-hidden border h-64 shimmer hidden lg:block"></div>
                </div>
            </div>
        </div>

        <div id="product-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16">
                <section id="media-gallery" class="w-full">
                    <div id="main-media-viewer" class="relative w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border mb-4 shadow-lg">
                        <button id="media-prev" class="media-arrow left-0.5 transform -translate-y-1/2 rounded-full p-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <button id="media-next" class="media-arrow right-0.5 transform -translate-y-1/2 rounded-full p-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                        </button>
                        </div>
                    <div id="thumbnails-container" class="w-full hide-scrollbar overflow-x-auto">
                        <div id="thumbnails-wrapper" class="flex gap-3 pb-2">
                        </div>
                    </div>
                </section>
                
                <section id="product-details" class="flex flex-col">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                        <div>
                            <div id="product-category" class="text-sm font-semibold text-liyog-green mb-1"></div>
                            <h1 id="product-name" class="text-3xl lg:text-4xl font-extrabold text-gray-900 leading-tight"></h1>
                        </div>
                        <div id="stock-badge" class="mt-2 sm:mt-0 text-xs font-bold px-3 py-1.5 rounded-full whitespace-nowrap self-start"></div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-3 text-sm">
                        <div id="star-rating" class="flex items-center gap-1"></div>
                        <a href="#reviews-section-start" class="font-bold text-gray-800 hover:text-liyog-green-dark hover:underline transition-colors" aria-label="View all reviews"><span id="avg-rating">0.0</span> (<span id="total-reviews">0</span> Reviews)</a>
                        <span class="text-gray-300 hidden sm:block">|</span>
                        <div class="flex items-center gap-1.5 mt-2 sm:mt-0">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span id="total-orders" class="font-semibold text-gray-600">0</span> <span class="text-gray-500">sold</span>
                        </div>
                    </div>

                    <div id="tags-container" class="mt-4 flex items-center gap-2 overflow-x-auto hide-scrollbar pb-2">
                    </div>

                    <div class="my-6 bg-gray-50 p-4 rounded-lg border shadow-sm">
                        <div class="flex items-baseline gap-3 flex-wrap">
                            <span id="final-price" class="text-3xl sm:text-4xl font-extrabold text-liyog-green-dark"></span>
                            <span id="original-price" class="text-base sm:text-xl line-through text-gray-400"></span>
                            <span id="discount-percent" class="text-sm font-semibold text-red-600 ml-2" style="display: none;"></span>
                        </div>
                        <div class="flex items-center justify-between mt-2 text-sm text-gray-700 font-semibold">
                            <div id="carton-info">
                                <span id="carton-quantity"></span> <span id="carton-price"></span>
                            </div>
                            <div id="lxc-banner" class="text-amber-700">
                                Earn <span id="liyogx-coins">0</span> LiyogX Coins (worth â‚¦<span id="liyogx-value">0.00</span>)
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                        <span class="text-gray-500">Added by:</span>
                        <div id="added-by-user" class="flex items-center gap-1.5">
                            <div id="added-by-avatar" class="w-6 h-6 rounded-full overflow-hidden bg-gray-200 flex-shrink-0 flex items-center justify-center text-xs font-bold text-white"></div>
                            <span id="added-by-name" class="font-semibold text-gray-800"></span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mt-2 mb-4 border-t pt-4">
                        <p id="product-created-at"><span class="font-medium text-gray-600">Created:</span> <span id="created-date"></span></p>
                        <p id="product-updated-at" style="display: none;"><span class="font-medium text-gray-600">Last Updated:</span> <span id="updated-date"></span></p>
                    </div>

                    <div class="mt-auto pt-6 border-t space-y-4">
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
                            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden flex-shrink-0">
                                <button id="qty-decrement" class="px-4 py-3 text-lg font-bold hover:bg-gray-100 transition-colors rounded-l-lg" aria-label="Decrease quantity">âˆ’</button>
                                <input id="quantity-input" type="number" value="1" min="1" class="w-16 text-center py-3 border-l border-r border-gray-300 font-bold text-lg focus:outline-none focus:ring-1 focus:ring-liyog-green" aria-label="Product quantity">
                                <button id="qty-increment" class="px-4 py-3 text-lg font-bold hover:bg-gray-100 transition-colors rounded-r-lg" aria-label="Increase quantity">+</button>
                            </div>
                            <button id="add-to-cart-btn" class="flex-1 text-center font-bold text-lg text-white bg-liyog-green hover:bg-liyog-green-dark rounded-lg py-3 transition-colors shadow-md" aria-label="Add to cart">Add to Cart</button>
                        </div>
                        <button id="order-now-btn" class="w-full text-center font-bold text-lg text-white bg-liyog-orange hover:bg-orange-600 rounded-lg py-3 transition-colors shadow-md" aria-label="Order now">Order Now</button>
                    </div>

                    <div class="mt-6 flex items-center justify-between text-sm">
                        <div class="flex items-center gap-4">
                             <button id="like-btn" class="flex items-center gap-2 text-gray-600 hover:text-red-500 transition-colors group" aria-label="Like product">
                                <svg id="like-icon" class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg>
                                <span id="total-likes" class="font-semibold">0</span>
                            </button>
                            <button id="share-btn" class="flex items-center gap-2 text-gray-600 hover:text-liyog-green transition-colors group" aria-label="Share product">
                                <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                                <span>Share</span>
                            </button>
                             <button id="copy-url-btn" class="flex items-center gap-2 text-gray-600 hover:text-liyog-green transition-colors group" aria-label="Copy product URL">
                                <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.79 4.79a4.5 4.5 0 01-6.364-6.364l1.242-1.242m5.011-5.01a4.5 4.5 0 017.006 3.96m-5.01 5.01a4.5 4.5 0 00-7.006-3.96l-1.242 1.242"></path></svg>
                                <span>Copy URL</span>
                            </button>
                        </div>
                        <div class="text-gray-500">
                            Views: <span id="total-views" class="font-semibold text-gray-700">0</span>
                        </div>
                    </div>
                </section>
            </div>

            <section id="tabs-section" class="mt-16 bg-white p-6 rounded-lg border shadow-sm">
                 <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-4 sm:space-x-8" aria-label="Tabs">
                        <button data-tab="description" class="tab-btn tab-btn-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm sm:text-base" aria-controls="tab-content-description" role="tab" aria-selected="true">Description</button>
                        <button data-tab="reviews" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm sm:text-base" aria-controls="tab-content-reviews" role="tab" aria-selected="false">Reviews</button>
                    </nav>
                </div>
                <div class="py-6">
                    <div id="tab-content-description" class="tab-content prose max-w-none text-gray-600 text-sm sm:text-base leading-relaxed" role="tabpanel" aria-labelledby="description-tab"></div>
                    <div id="tab-content-reviews" class="tab-content hidden" role="tabpanel" aria-labelledby="reviews-tab">
                        <a id="reviews-section-start" class="sr-only" tabindex="-1">Reviews Section Anchor</a>
                        <div id="reviews-dashboard" class="mb-8 p-4 sm:p-6 bg-liyog-deep-green text-white rounded-lg shadow-inner">
                            <h3 class="text-2xl font-bold mb-4 text-center">Customer Reviews</h3>
                            <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                                <div class="flex items-center gap-2 text-3xl font-extrabold flex-shrink-0">
                                    <span id="overall-avg-rating">0.0</span> / 5
                                    <div id="overall-star-rating" class="flex items-center" role="img" aria-label="Overall average rating"></div>
                                </div>
                                <div class="text-sm text-gray-200 text-center md:text-left">Based on <span id="overall-total-reviews-count" class="animate-pulse-on-update">0</span> reviews</div>
                            </div>

                            <div id="ratings-distribution-chart" class="space-y-3" role="group" aria-label="Rating distribution chart">
                                </div>
                            <div class="flex flex-wrap gap-2 mt-6 justify-center">
                                <button data-rating-filter="0" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-liyog-green text-white hover:bg-liyog-green-dark transition-colors active" aria-pressed="true">All Reviews</button>
                                <button data-rating-filter="5" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">5 Stars</button>
                                <button data-rating-filter="4" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">4 Stars</button>
                                <button data-rating-filter="3" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">3 Stars</button>
                                <button data-rating-filter="2" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">2 Stars</button>
                                <button data-rating-filter="1" class="filter-rating-btn px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">1 Star</button>
                            </div>
                        </div>

                        <div id="login-to-review-message" class="mb-8 p-4 sm:p-6 bg-white rounded-lg shadow-md border text-center text-gray-700 font-semibold" style="display: none;">
                            <p class="mb-4">Log in to share your review and help other shoppers!</p>
                            <a href="/login.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                                Log In
                            </a>
                        </div>

                        <div id="add-review-form-section" class="mb-8 p-4 sm:p-6 bg-white rounded-lg shadow-md border" style="display: none;">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Add Your Review</h3>
                            <form id="review-form" class="space-y-4" aria-label="Review submission form">
                                <div class="flex items-center gap-3">
                                    <div id="user-avatar-review-form" class="w-10 h-10 rounded-full overflow-hidden bg-liyog-green-light flex-shrink-0 flex items-center justify-center text-white text-lg font-bold" aria-hidden="true">
                                    </div>
                                    <span id="current-user-name-review-form" class="font-semibold text-gray-800"></span>
                                </div>
                                
                                <div>
                                    <label for="review-rating-5" class="block text-sm font-medium text-gray-700 mb-2">Your Rating: <span class="text-red-500">*</span></label>
                                    <div id="review-rating-input" class="star-rating-input flex justify-end" role="radiogroup" aria-required="true" aria-label="Your product rating">
                                    </div>
                                    <input type="hidden" name="rating" id="selected-rating" value="0" required aria-hidden="true">
                                    <p id="rating-error" class="error-message" style="display:none;">Please select a star rating.</p>
                                </div>
                                <div>
                                    <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2">Your Comment: <span class="text-red-500">*</span></label>
                                    <textarea id="review-comment" name="comment" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-liyog-green focus:ring-liyog-green sm:text-sm p-3" placeholder="Share your thoughts about this product..." required minlength="10" maxlength="500" aria-describedby="comment-error"></textarea>
                                    <p id="comment-error" class="error-message" style="display:none;">Comment must be between 10 and 500 characters.</p>
                                </div>
                                <button type="submit" id="submit-review-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-liyog-green hover:bg-liyog-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-liyog-green">Submit Review</button>
                            </form>
                        </div>
                        
                        <div id="reviews-list-container" class="space-y-6 pt-4">
                            <p class="text-center text-gray-500 py-4" id="no-reviews-message" style="display: none;">No reviews yet. Be the first to share your experience!</p>
                             <div id="review-skeleton-loader" class="space-y-6" style="display: none;">
                                <div class="flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                                    <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                                    <div class="flex-1 space-y-2">
                                        <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                                        <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                                    </div>
                                </div>
                                <div class="flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                                    <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                                    <div class="flex-1 space-y-2">
                                        <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                                        <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                                        <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="reviews-list" class="space-y-6" aria-live="polite" aria-atomic="true">
                                </div>
                        </div>

                        <div id="initial-load-more-reviews-container" class="text-center mt-8 hidden">
                            <button id="view-all-reviews-btn" class="px-6 py-3 border border-gray-300 rounded-lg font-bold text-liyog-green-dark bg-gray-50 hover:bg-gray-100 transition-colors shadow-sm" aria-label="View all reviews and filter">VIEW ALL REVIEWS AND FILTER ALONG</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="related-products-section" class="mt-16 hidden">
                <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 mb-6">Related Products</h2>
                <div id="related-products-carousel" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </section>
            
            <section id="you-may-like-section" class="mt-16">
                <h2 class="text-xl sm:text-2xl font-extrabold text-gray-900 mb-6">You May Also Like</h2>
                <div id="you-may-like-carousel" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </section>
        </div>
    </main>

    <footer class="bg-white/80 backdrop-blur-lg mt-16 py-8 border-t">
        <div class="text-center text-sm text-gray-500">
            Â© <span id="footer-year"></span> Liyog. All Rights Reserved.
        </div>
    </footer>
    
    <div id="mobile-sticky-footer" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t p-3 flex items-center gap-3 z-40 shadow-2xl">
        <button id="mobile-add-to-cart-btn" class="flex-1 text-center font-bold text-liyog-green bg-green-100 hover:bg-green-200 rounded-lg py-3 transition-colors">Add to Cart</button>
        <button id="mobile-order-now-btn" class="flex-1 text-center font-bold text-white bg-liyog-orange hover:bg-orange-600 rounded-lg py-3 transition-colors">Order Now</button>
    </div>

    <div id="edit-review-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-review-title">
        <div class="modal-content">
            <h3 id="edit-review-title" class="text-xl font-bold text-gray-900 mb-4">Edit Your Review</h3>
            <form id="edit-review-form" class="space-y-4">
                <div>
                    <label for="edit-review-rating-5" class="block text-sm font-medium text-gray-700 mb-2">Your Rating:</label>
                    <div id="edit-review-rating-input" class="star-rating-input flex justify-end" role="radiogroup" aria-label="Edit product rating">
                    </div>
                    <input type="hidden" name="rating" id="edit-selected-rating" value="0" aria-hidden="true">
                    <p id="edit-rating-error" class="error-message" style="display:none;">Please select a star rating.</p>
                </div>
                <div>
                    <label for="edit-review-comment" class="block text-sm font-medium text-gray-700 mb-2">Your Comment:</label>
                    <textarea id="edit-review-comment" name="comment" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-liyog-green focus:ring-liyog-green sm:text-sm p-3" placeholder="Share your thoughts about this product..." required minlength="10" maxlength="500"></textarea>
                    <p id="edit-comment-error" class="error-message" style="display:none;">Comment must be between 10 and 500 characters.</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-review-btn" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">Cancel</button>
                    <button type="submit" id="save-edit-review-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-liyog-green hover:bg-liyog-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-liyog-green">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="full-reviews-modal" class="bottom-sheet-modal" role="dialog" aria-modal="true" aria-labelledby="full-reviews-modal-title">
        <div class="bottom-sheet-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h3 id="full-reviews-modal-title" class="text-lg font-bold text-gray-900">All Customer Reviews</h3>
                <button id="close-full-reviews-btn" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition-colors" aria-label="Close reviews modal">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 sm:p-6 bg-liyog-deep-green text-white flex-shrink-0">
                <div class="flex flex-col md:flex-row items-center justify-between mb-4 gap-4">
                    <div class="flex items-center gap-2 text-2xl font-extrabold flex-shrink-0">
                        <span id="full-modal-overall-avg-rating">0.0</span> / 5
                        <div id="full-modal-overall-star-rating" class="flex items-center" role="img" aria-label="Overall average rating"></div>
                    </div>
                    <div class="text-sm text-gray-200 text-center md:text-left">Based on <span id="full-modal-overall-total-reviews-count" class="animate-pulse-on-update">0</span> reviews</div>
                </div>
                <div id="full-modal-ratings-distribution-chart" class="space-y-2">
                    </div>
                <div class="flex flex-wrap gap-2 mt-4 justify-center">
                    <button data-rating-filter="0" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-liyog-green text-white hover:bg-liyog-green-dark transition-colors active" aria-pressed="true">All Reviews</button>
                    <button data-rating-filter="5" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">5 Stars</button>
                    <button data-rating-filter="4" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">4 Stars</button>
                    <button data-rating-filter="3" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">3 Stars</button>
                    <button data-rating-filter="2" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">2 Stars</button>
                    <button data-rating-filter="1" class="filter-rating-btn-modal px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-white hover:bg-gray-600 transition-colors" aria-pressed="false">1 Star</button>
                </div>
            </div>
            
            <div id="full-reviews-list-scroll-area" class="flex-1 overflow-y-auto p-4 sm:p-6 pb-20">
                <div id="full-reviews-list" class="space-y-6" aria-live="polite" aria-atomic="true">
                    </div>
                <div id="full-reviews-load-more-container" class="text-center mt-8 hidden">
                    <button id="full-reviews-load-more-btn" class="px-6 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors" aria-label="Load more reviews">Load More</button>
                </div>
                <p class="text-center text-gray-500 py-4" id="full-reviews-no-more-message" style="display: none;">This is where the reviews for this product end â€” more are coming!</p>
                <p class="text-center text-gray-500 py-4" id="full-reviews-no-results-message" style="display: none;">No reviews match the current filter.</p>
            </div>
        </div>
    </div>


<script type="module">
// ===================================================================
// CONFIG & INITIALIZATION
// ===================================================================
const SUPABASE_URL = "https://snwwlewjriuqrodpjhry.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNud3dsZXdqcml1cXJvZHBqaHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDY3MDAsImV4cCI6MjA2ODE4MjcwMH0.WxOmEHxLcEHmMKFjsgrzcb22mPs-sJwW_G3GOuXX2c8";

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// ===================================================================
// CONSTANTS
// ===================================================================
const REVIEW_MIN_LENGTH = 10;
const REVIEW_MAX_LENGTH = 500;
const TOAST_DURATION = 3000;
const INITIAL_REVIEWS_COUNT = 5; // How many reviews to show on the product page initially

// ===================================================================
// STATE MANAGEMENT
// ===================================================================
let state = {
    product: null,
    currentUser: null,
    settings: { lxc_rate: 10 },
    isLiked: false,
    
    // UPDATED: Review state management for both initial page and modal
    initialReviews: [], // Stores the first 5 reviews for the main page
    modalReviews: [], // Stores all reviews for the bottom sheet modal
    modalReviewsPage: 1,
    modalReviewsPerPage: 10, // Fetch more reviews at a time in the modal
    hasMoreModalReviews: true,
    isFetchingModalReviews: false,

    reviewsData: { // Processed review data for dashboard/chart
        ratingCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        totalReviews: 0,
        avgRating: 0.0,
    },
    currentRatingFilter: 0, // 0 for all, 1-5 for specific stars
    
    userLikedReviews: new Set(), // Stores review_ids liked by the current user
    
    // Media Gallery State
    currentMediaIndex: 0,
    mediaItems: [],
};


// ===================================================================
// DOM ELEMENT SELECTORS
// ===================================================================
const DOMElements = {
    loader: document.getElementById('skeleton-loader'),
    content: document.getElementById('product-content'),
    mainMediaViewer: document.getElementById('main-media-viewer'),
    thumbnailsWrapper: document.getElementById('thumbnails-wrapper'),
    productCategory: document.getElementById('product-category'),
    productName: document.getElementById('product-name'),
    stockBadge: document.getElementById('stock-badge'),
    starRating: document.getElementById('star-rating'),
    avgRating: document.getElementById('avg-rating'),
    totalReviews: document.getElementById('total-reviews'),
    totalOrders: document.getElementById('total-orders'),
    tagsContainer: document.getElementById('tags-container'),
    finalPrice: document.getElementById('final-price'),
    originalPrice: document.getElementById('original-price'),
    discountPercent: document.getElementById('discount-percent'),
    cartonInfo: document.getElementById('carton-info'),
    cartonQuantity: document.getElementById('carton-quantity'),
    cartonPrice: document.getElementById('carton-price'),
    lxcBanner: document.getElementById('lxc-banner'),
    liyogxCoins: document.getElementById('liyogx-coins'),
    liyogxValue: document.getElementById('liyogx-value'),
    addedByUser: document.getElementById('added-by-user'),
    addedByAvatar: document.getElementById('added-by-avatar'),
    addedByName: document.getElementById('added-by-name'),
    // NEW: Product date elements
    productCreatedAt: document.getElementById('product-created-at'),
    createdDate: document.getElementById('created-date'),
    productUpdatedAt: document.getElementById('product-updated-at'),
    updatedDate: document.getElementById('updated-date'),
    quantityInput: document.getElementById('quantity-input'),
    qtyDecrement: document.getElementById('qty-decrement'),
    qtyIncrement: document.getElementById('qty-increment'),
    addToCartBtn: document.getElementById('add-to-cart-btn'),
    orderNowBtn: document.getElementById('order-now-btn'),
    likeBtn: document.getElementById('like-btn'),
    likeIcon: document.getElementById('like-icon'),
    totalLikes: document.getElementById('total-likes'),
    shareBtn: document.getElementById('share-btn'),
    copyUrlBtn: document.getElementById('copy-url-btn'),
    totalViews: document.getElementById('total-views'),
    // Tabs
    tabButtons: document.querySelectorAll('.tab-btn'),
    tabContents: document.querySelectorAll('.tab-content'),
    descriptionContent: document.getElementById('tab-content-description'),
    reviewsContent: document.getElementById('tab-content-reviews'),
    // Reviews Section (Initial Page)
    reviewsDashboard: document.getElementById('reviews-dashboard'),
    overallAvgRating: document.getElementById('overall-avg-rating'),
    overallStarRating: document.getElementById('overall-star-rating'),
    overallTotalReviewsCount: document.getElementById('overall-total-reviews-count'),
    ratingsDistributionChart: document.getElementById('ratings-distribution-chart'),
    filterRatingBtns: document.querySelectorAll('.filter-rating-btn'),
    loginToReviewMessage: document.getElementById('login-to-review-message'),
    addReviewFormSection: document.getElementById('add-review-form-section'),
    reviewForm: document.getElementById('review-form'),
    userAvatarReviewForm: document.getElementById('user-avatar-review-form'),
    currentUserNameReviewForm: document.getElementById('current-user-name-review-form'),
    reviewRatingInput: document.getElementById('review-rating-input'),
    selectedRatingInput: document.getElementById('selected-rating'),
    reviewCommentInput: document.getElementById('review-comment'),
    submitReviewBtn: document.getElementById('submit-review-btn'),
    ratingError: document.getElementById('rating-error'),
    commentError: document.getElementById('comment-error'),
    reviewsList: document.getElementById('reviews-list'),
    noReviewsMessage: document.getElementById('no-reviews-message'),
    initialLoadMoreContainer: document.getElementById('initial-load-more-reviews-container'),
    viewAllReviewsBtn: document.getElementById('view-all-reviews-btn'),
    reviewSkeletonLoader: document.getElementById('review-skeleton-loader'),
    // Carousels
    relatedProductsSection: document.getElementById('related-products-section'),
    relatedProductsCarousel: document.getElementById('related-products-carousel'),
    youMayLikeSection: document.getElementById('you-may-like-section'),
    youMayLikeCarousel: document.getElementById('you-may-like-carousel'),
    // Mobile
    mobileAddToCartBtn: document.getElementById('mobile-add-to-cart-btn'),
    mobileOrderNowBtn: document.getElementById('mobile-order-now-btn'),
    // Media Navigation
    mediaPrevBtn: document.getElementById('media-prev'),
    mediaNextBtn: document.getElementById('media-next'),
    // Edit Review Modal
    editReviewModal: document.getElementById('edit-review-modal'),
    editReviewForm: document.getElementById('edit-review-form'),
    editReviewRatingInput: document.getElementById('edit-review-rating-input'),
    editSelectedRating: document.getElementById('edit-selected-rating'),
    editReviewComment: document.getElementById('edit-review-comment'),
    editRatingError: document.getElementById('edit-rating-error'),
    editCommentError: document.getElementById('edit-comment-error'),
    cancelEditReviewBtn: document.getElementById('cancel-edit-review-btn'),
    saveEditReviewBtn: document.getElementById('save-edit-review-btn'),
    // NEW: Full Reviews Modal / Bottom Sheet
    fullReviewsModal: document.getElementById('full-reviews-modal'),
    closeFullReviewsBtn: document.getElementById('close-full-reviews-btn'),
    fullModalAvgRating: document.getElementById('full-modal-overall-avg-rating'),
    fullModalStarRating: document.getElementById('full-modal-overall-star-rating'),
    fullModalTotalReviews: document.getElementById('full-modal-overall-total-reviews-count'),
    fullModalRatingsChart: document.getElementById('full-modal-ratings-distribution-chart'),
    fullModalFilterBtns: document.querySelectorAll('.filter-rating-btn-modal'),
    fullReviewsListScrollArea: document.getElementById('full-reviews-list-scroll-area'),
    fullReviewsList: document.getElementById('full-reviews-list'),
    fullReviewsLoadMoreContainer: document.getElementById('full-reviews-load-more-container'),
    fullReviewsLoadMoreBtn: document.getElementById('full-reviews-load-more-btn'),
    fullReviewsNoMoreMessage: document.getElementById('full-reviews-no-more-message'),
    fullReviewsNoResultsMessage: document.getElementById('full-reviews-no-results-message'),
};


// ===================================================================
// HELPER UTILITIES & ANIMATIONS
// ===================================================================

function showToast(message, type = 'success') {
    Toastify({
        text: message,
        duration: TOAST_DURATION,
        close: true,
        gravity: "top",
        position: "right",
        stopOnFocus: true,
        style: {
            background: type === 'success' ? "var(--liyog-green)" : (type === 'error' ? "#ef4444" : "#f59e0b"),
        },
    }).showToast();
}

// NEW: Anonymizes a user's name for non-logged-in visitors
function anonymizeName(name) {
    if (!name || name.length <= 4) {
        return name ? `${name.substring(0, 1)}***` : 'A***';
    }
    const firstChar = name.charAt(0);
    const lastChar = name.charAt(name.length - 1);
    const middle = '*'.repeat(Math.min(8, name.length - 2));
    return `${firstChar}${middle}${lastChar}`;
}

// NEW: Formats date and time in a human-readable way
function formatHumanReadableDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
        day: 'numeric', month: 'long', year: 'numeric'
    });
}

function normalizeYoutubeUrl(url) {
    if (!url) return null;
    let videoId;
    // This regex is more robust for various YouTube URL formats
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    videoId = match ? match[1] : null;
    // Using modern embed options
    return videoId ? `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=0&controls=1&showinfo=0&rel=0&modestbranding=1` : null;
}

function generateAvatar(name, size = 'w-10 h-10', textSize = 'text-lg') {
    const initials = (name || 'A').split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2);
    const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B'];
    const hashCode = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return hash;
    };
    const colorIndex = Math.abs(hashCode(initials)) % colors.length;
    const bgColor = colors[colorIndex];

    return `<div class="${size} ${textSize} avatar-initials" style="background-color: ${bgColor};" aria-label="${name}'s avatar">${initials}</div>`;
}

// NEW: Function to open/close the edit review modal
function toggleEditReviewModal(open, review = null) {
    if (open) {
        DOMElements.editReviewModal.classList.add('open');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        DOMElements.editReviewModal.setAttribute('aria-hidden', 'false');
        if (review) {
            DOMElements.editReviewForm.dataset.reviewId = review.id;
            DOMElements.editReviewComment.value = review.comment;
            
            DOMElements.editReviewRatingInput.innerHTML = renderStarRatingHTML(review.rating, 'w-6 h-6', true, 'edit-review-rating');
            DOMElements.editSelectedRating.value = review.rating;

            document.querySelectorAll('#edit-review-rating-input input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    DOMElements.editSelectedRating.value = e.target.value;
                    document.querySelectorAll('#edit-review-rating-input input[type="radio"]').forEach(r => {
                        if (r.checked) {
                            r.classList.add('selected');
                        } else {
                            r.classList.remove('selected');
                        }
                    });
                });
            });
            const initialRadio = document.getElementById(`edit-review-rating-${review.rating}`);
            if (initialRadio) {
                initialRadio.checked = true;
                initialRadio.classList.add('selected');
            }
            DOMElements.editReviewComment.focus();
        }
    } else {
        DOMElements.editReviewModal.classList.remove('open');
        document.body.style.overflow = ''; // Restore background scrolling
        DOMElements.editReviewModal.setAttribute('aria-hidden', 'true');
        DOMElements.editReviewForm.reset();
        DOMElements.editReviewComment.classList.remove('input-error');
        DOMElements.editCommentError.style.display = 'none';
        DOMElements.editRatingError.style.display = 'none';
        DOMElements.editSelectedRating.value = '0';
    }
}


// NEW: Animation for counting numbers up/down
function animateCount(element, start, end, duration = 500) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// NEW: Animation for like/dislike bubbles
function spawnBubble(button, type = 'like') {
    const icon = type === 'like' ? 'ðŸ’•' : 'ðŸ‘Ž';
    const className = type === 'like' ? 'like-bubble' : 'dislike-bubble';
    
    // Create a burst of bubbles
    for (let i = 0; i < 5; i++) { 
        const bubble = document.createElement('span');
        bubble.innerHTML = icon;
        bubble.className = className;
        bubble.style.left = `${Math.random() * 100}%`;
        bubble.style.animationDelay = `${Math.random() * 0.3}s`;
        button.appendChild(bubble);

        setTimeout(() => bubble.remove(), 1500);
    }
}


// ===================================================================
// API/DATA FETCHING FUNCTIONS
// ===================================================================

async function fetchCurrentUser() {
    try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        if (sessionError) throw sessionError;

        if (session?.user) {
            const { data: userProfile, error: profileError } = await supabaseClient
                .from('users')
                .select('id, name, email, profile_image, role, referral_code')
                .eq('id', session.user.id)
                .single();

            if (profileError && profileError.code !== 'PGRST116') console.warn("User profile not found:", profileError.message);
            
            state.currentUser = userProfile || { id: session.user.id, name: session.user.email, email: session.user.email, profile_image: null, role: 'user', referral_code: null };
            
            const { data: likedReviews, error: likedReviewsError } = await supabaseClient
                .from('user_review_likes')
                .select('review_id')
                .eq('user_id', state.currentUser.id);

            if (likedReviewsError) console.error("Error fetching user liked reviews:", likedReviewsError.message);
            else state.userLikedReviews = new Set(likedReviews.map(like => like.review_id));

        } else {
            state.currentUser = null;
        }
    } catch (error) {
        console.error("Error fetching current user:", error.message);
        showToast(`Failed to fetch user session: ${error.message}`, 'error');
        state.currentUser = null;
    }
}

async function fetchUserById(userId) {
    if (!userId) return null;
    try {
        const { data, error } = await supabaseClient
            .from('users')
            .select('id, name, profile_image, role')
            .eq('id', userId)
            .single();
        if (error) {
            if (error.code !== 'PGRST116') console.error("Error fetching user by ID:", error.message);
            return null;
        }
        return data;
    } catch (error) {
        console.error("Error in fetchUserById:", error.message);
        return null;
    }
}


async function fetchProduct(slug) {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('*')
            .eq('slug', slug)
            .single();
        if (error) {
            if (error.code === 'PGRST116') {
                throw new Error('Product not found.');
            }
            throw new Error(`Failed to fetch product details: ${error.message}`);
        }
        return data;
    } catch (error) {
        console.error("Error in fetchProduct:", error.message);
        throw error;
    }
}

async function getExistingLike(productId, userId) {
    if (!userId) return null;
    try {
        const { data, error } = await supabaseClient
            .from('likes')
            .select('id')
            .eq('product_id', productId)
            .eq('user_id', userId)
            .maybeSingle();
        
        if (error) throw error;
        return data ? data.id : null;
    } catch (error) {
        if (error.code === 'PGRST116') return null;
        console.error("Error checking if product is liked:", error.message);
        return null;
    }
}


async function fetchSettings() {
    try {
        const { data, error } = await supabaseClient
            .from('site_settings')
            .select('key, value')
            .eq('key', 'lxc_rate')
            .single();

        if (error && error.code !== 'PGRST116') {
            console.warn("Error fetching site settings, using default:", error.message);
        }

        if (data) {
            state.settings.lxc_rate = parseFloat(data.value) || state.settings.lxc_rate;
        }
    } catch (error) {
        console.error("Critical error fetching site settings:", error.message);
        showToast("Failed to load site settings. Some features may not work as expected.", 'error');
    }
}

// UPDATED: Fetches reviews for the initial page load (first 5)
async function fetchInitialReviews() {
    if (!state.product) return;

    DOMElements.reviewSkeletonLoader.style.display = 'block';
    DOMElements.reviewsList.innerHTML = '';
    DOMElements.noReviewsMessage.style.display = 'none';

    try {
        const { data, error } = await supabaseClient
            .from('reviews')
            .select(`*, user:users(id, name, profile_image, role)`)
            .eq('product_id', state.product.id)
            .order('created_at', { ascending: false })
            .limit(INITIAL_REVIEWS_COUNT);
        
        if (error) throw error;
        
        state.initialReviews = data;
        processReviewsData(state.initialReviews, DOMElements.overallAvgRating, DOMElements.overallStarRating, DOMElements.overallTotalReviewsCount, DOMElements.ratingsDistributionChart, DOMElements.filterRatingBtns);
        renderInitialReviews();

    } catch(err) {
        console.error("Error fetching initial reviews:", err);
        showToast('Could not load reviews.', 'error');
        DOMElements.reviewsList.innerHTML = `<p class="text-center text-red-500 py-4">Error loading reviews.</p>`;
    } finally {
        DOMElements.reviewSkeletonLoader.style.display = 'none';
    }
}

// NEW: Fetches reviews for the modal with infinite scroll and filters
async function fetchModalReviews(isNewFilter = false) {
    if (!state.product || state.isFetchingModalReviews) return;

    state.isFetchingModalReviews = true;
    DOMElements.fullReviewsNoMoreMessage.style.display = 'none';
    DOMElements.fullReviewsNoResultsMessage.style.display = 'none';

    if (isNewFilter) {
        state.modalReviews = [];
        state.modalReviewsPage = 1;
        state.hasMoreModalReviews = true;
        DOMElements.fullReviewsList.innerHTML = ''; // Clear list for new filter
        // Show skeleton loader in modal if it's a new filter search
        DOMElements.fullReviewsList.innerHTML = `
            <div class="review-card flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-4 bg-gray-200 rounded w-full"></div>
                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
            <div class="review-card flex gap-4 p-4 bg-white rounded-lg shadow-sm border border-gray-100 shimmer">
                <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-4 bg-gray-200 rounded w-full"></div>
                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
        `;
    }

    if (!state.hasMoreModalReviews) {
        DOMElements.fullReviewsList.innerHTML = ''; // Clear skeletons if no more data
        if (state.modalReviews.length === 0) {
            DOMElements.fullReviewsNoResultsMessage.style.display = 'block';
        } else {
             DOMElements.fullReviewsNoMoreMessage.style.display = 'block';
        }
        state.isFetchingModalReviews = false;
        return;
    }
    
    DOMElements.fullReviewsLoadMoreContainer.classList.remove('hidden'); // Ensure button is visible while fetching
    DOMElements.fullReviewsLoadMoreBtn.disabled = true;
    DOMElements.fullReviewsLoadMoreBtn.textContent = 'Loading...';

    const from = (state.modalReviewsPage - 1) * state.modalReviewsPerPage;
    const to = from + state.modalReviewsPerPage - 1;

    try {
        let query = supabaseClient
            .from('reviews')
            .select(`*, user:users(id, name, profile_image, role)`)
            .eq('product_id', state.product.id);
        
        if (state.currentRatingFilter > 0) {
            query = query.eq('rating', state.currentRatingFilter);
        }

        const { data, error } = await query
            .order('created_at', { ascending: false })
            .range(from, to);
            
        if (error) { 
            console.error("Error fetching modal reviews:", error);
            showToast('Failed to load reviews in modal. Please try again.', 'error');
            DOMElements.fullReviewsLoadMoreBtn.textContent = 'Failed to load reviews';
            DOMElements.fullReviewsList.innerHTML = `<p class="text-center text-red-500 py-4">Error loading reviews.</p>`;
            return; 
        }

        // Clear skeleton loader before rendering actual reviews if this is the first batch
        if (isNewFilter && data.length > 0) {
            DOMElements.fullReviewsList.innerHTML = ''; 
        } else if (isNewFilter && data.length === 0) {
             DOMElements.fullReviewsList.innerHTML = ''; 
        }

        state.modalReviews.push(...data); // Append new reviews

        if (data.length < state.modalReviewsPerPage) {
            state.hasMoreModalReviews = false;
            DOMElements.fullReviewsLoadMoreContainer.classList.add('hidden');
            DOMElements.fullReviewsNoMoreMessage.style.display = 'block';
        } else {
            DOMElements.fullReviewsLoadMoreContainer.classList.remove('hidden');
            state.modalReviewsPage++;
        }
        
        renderModalReviews(data); // Render ONLY the newly fetched reviews
        DOMElements.fullReviewsLoadMoreBtn.textContent = 'Load More';

        // Update dashboard stats in modal with ALL current modalReviews
        processReviewsData(state.modalReviews, DOMElements.fullModalAvgRating, DOMElements.fullModalStarRating, DOMElements.fullModalTotalReviews, DOMElements.fullModalRatingsChart, DOMElements.fullModalFilterBtns);


    } catch (error) {
        console.error("Error in fetchModalReviews:", error);
        showToast('Error loading reviews in modal. Please check your connection.', 'error');
        DOMElements.fullReviewsLoadMoreBtn.textContent = 'Error loading reviews';
        if (state.modalReviews.length === 0) DOMElements.fullReviewsNoResultsMessage.style.display = 'block';
    } finally {
        DOMElements.fullReviewsLoadMoreBtn.disabled = false;
        state.isFetchingModalReviews = false;
    }
}


async function fetchRelatedProducts(product) {
    try {
        const tags = (product.tags || '').split(',').map(t => t.trim()).filter(Boolean);
        let queryBuilder = supabaseClient.from('products').select('name, price, discount_price, image_urls, slug, avg_rating, total_reviews');
        queryBuilder = queryBuilder.neq('id', product.id).eq('published', true);

        let orConditions = [];
        if (product.category) {
            orConditions.push(`category.eq.${product.category}`);
        }
        if (tags.length > 0) {
            orConditions.push(`tags.cs.{${tags.map(t => `"${t}"`).join(',')}}`);
        }
        
        if (orConditions.length > 0) {
            queryBuilder = queryBuilder.or(orConditions.join(','));
        }

        const { data, error } = await queryBuilder.limit(4);

        if (error) { console.error("Error fetching related products:", error); return []; }
        return data;
    } catch (error) {
        console.error("Error in fetchRelatedProducts:", error);
        return [];
    }
}


async function fetchYouMayLikeProducts() {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('name, price, discount_price, image_urls, slug, avg_rating, total_reviews')
            .eq('published', true)
            .order('total_orders', { ascending: false, nullsFirst: false })
            .limit(8);
            
        if (error) { console.error("Error fetching 'You May Like' products:", error); return []; }
        return data;
    } catch (error) {
        console.error("Error in fetchYouMayLikeProducts:", error);
        return [];
    }
}


// ===================================================================
// RENDER FUNCTIONS (Continued from Part 2)
// ===================================================================

// NEW: Reusable function to render star HTML (for display or interactive input)
function renderStarRatingHTML(rating = 0, size = 'w-4 h-4', interactive = false, inputName = 'review-rating') {
    let starsHTML = '';
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    // SVG path for a star, optimized for rendering
    const starPath = "M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.92-.755 1.688-1.54 1.118L10 15.347l-3.883 2.678c-.784.57-1.84-.197-1.54-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.126 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z";

    if (interactive) {
        for (let i = 5; i >= 1; i--) {
            // Stars are generated in reverse order for RTL display, but with correct value order
            const checked = (i === Math.round(rating) ? 'checked' : '');
            starsHTML += `
                <input type="radio" id="${inputName}-${i}" name="${inputName}" value="${i}" class="sr-only" ${checked} aria-label="${i} stars">
                <label for="${inputName}-${i}" title="${i} stars" aria-hidden="true">
                    <svg class="${size}" fill="currentColor" viewBox="0 0 20 20"><path d="${starPath}" /></svg>
                </label>
            `;
        }
    } else {
        const fullStarSVG = `<svg class="${size} text-liyog-gold" fill="currentColor" viewBox="0 0 20 20"><path d="${starPath}" /></svg>`;
        const emptyStarSVG = `<svg class="${size} text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="${starPath}" /></svg>`;
        
        for (let i = 0; i < fullStars; i++) starsHTML += fullStarSVG;
        if (halfStar) {
            const halfStarGradientId = `half_grad_${Math.random().toString(36).substr(2, 5)}`;
            starsHTML += `<svg class="${size}" viewBox="0 0 20 20" fill="url(#${halfStarGradientId})"><defs><linearGradient id="${halfStarGradientId}"><stop offset="50%" stop-color="var(--liyog-gold)"/><stop offset="50%" stop-color="#e5e7eb"/></linearGradient></defs><path d="${starPath}" /></svg>`;
        }
        for (let i = 0; i < emptyStars; i++) starsHTML += emptyStarSVG;
    }
    
    return starsHTML;
}

// NEW: Renders the reviews dashboard (chart and overall average) for main page or modal
function renderReviewsDashboard(ratingCounts, totalReviews, avgRating, isModal = false) {
    const avgRatingElement = isModal ? DOMElements.fullModalAvgRating : DOMElements.overallAvgRating;
    const starRatingElement = isModal ? DOMElements.fullModalStarRating : DOMElements.overallStarRating;
    const totalReviewsElement = isModal ? DOMElements.fullModalTotalReviews : DOMElements.overallTotalReviewsCount;
    const chartContainer = isModal ? DOMElements.fullModalRatingsChart : DOMElements.ratingsDistributionChart;
    const filterBtns = isModal ? DOMElements.fullModalFilterBtns : DOMElements.filterRatingBtns;

    avgRatingElement.textContent = avgRating.toFixed(1);
    starRatingElement.innerHTML = renderStarRatingHTML(avgRating, 'w-6 h-6');
    animateCount(totalReviewsElement, parseInt(totalReviewsElement.textContent.replace(/,/g, '') || '0'), totalReviews, 700);


    chartContainer.innerHTML = ''; // Clear previous chart

    for (let i = 5; i >= 1; i--) {
        const count = ratingCounts[i] || 0;
        const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
        const isActive = (state.currentRatingFilter === i);

        chartContainer.innerHTML += `
            <div class="flex items-center gap-3 group">
                <button data-rating-filter="${i}" class="text-sm font-semibold w-8 text-right filter-rating-btn ${isActive ? 'text-liyog-gold' : 'text-gray-200'}" aria-pressed="${isActive}">
                    ${i} <span class="hidden sm:inline">Star</span>
                </button>
                <div class="flex-1 h-3 bg-gray-600 rounded-full rating-bar-wrapper relative cursor-pointer ${isActive ? 'active' : ''}" data-rating-filter="${i}" role="progressbar" aria-valuenow="${percentage.toFixed(0)}" aria-valuemin="0" aria-valuemax="100" aria-label="${count} reviews for ${i} stars">
                    <div class="rating-fill bg-liyog-gold h-full rounded-full transition-all duration-300" style="width: ${percentage.toFixed(0)}%;"></div>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs font-bold text-gray-800 mix-blend-screen">${count}</span>
                </div>
                <span class="text-sm font-medium w-10 text-right text-gray-200">${percentage.toFixed(0)}%</span>
            </div>
        `;
    }

    // Attach listeners for filter buttons in the dashboard (for both main page and modal)
    chartContainer.querySelectorAll('.filter-rating-btn, .rating-bar-wrapper').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterValue = parseInt(btn.dataset.ratingFilter, 10);
            if (isModal) {
                state.currentRatingFilter = filterValue;
                updateModalFilterButtons();
                fetchModalReviews(true);
            } else {
                applyReviewFilter(filterValue);
            }
        });
    });

    // Update the state of the separate filter buttons below the dashboard
    filterBtns.forEach(btn => {
        const rating = parseInt(btn.dataset.ratingFilter, 10);
        if (rating === state.currentRatingFilter) {
            btn.classList.add('active', 'bg-liyog-green');
            btn.classList.remove('bg-gray-700');
            btn.setAttribute('aria-pressed', 'true');
        } else {
            btn.classList.remove('active', 'bg-liyog-green');
            btn.classList.add('bg-gray-700');
            btn.setAttribute('aria-pressed', 'false');
        }
    });
}


// NEW: Processes raw review data to calculate counts and averages for the dashboard
function processReviewsData(reviewsToProcess, avgRatingEl, starRatingEl, totalReviewsEl, chartEl, filterBtnGroup) {
    let ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let totalRatingSum = 0;
    
    reviewsToProcess.forEach(review => {
        ratingCounts[review.rating]++;
        totalRatingSum += review.rating;
    });

    const totalCount = reviewsToProcess.length;
    const averageRating = totalCount > 0 ? (totalRatingSum / totalCount) : 0;

    // Update state.reviewsData for main page reference
    state.reviewsData.ratingCounts = ratingCounts;
    state.reviewsData.totalReviews = totalCount;
    state.reviewsData.avgRating = averageRating;

    // Render the specific dashboard UI elements
    renderReviewsDashboard(ratingCounts, totalCount, averageRating, (totalReviewsEl === DOMElements.fullModalTotalReviews));
}

// Renders the review submission form based on user login status
function renderReviewForm() {
    if (state.currentUser) {
        DOMElements.addReviewFormSection.style.display = 'block';
        DOMElements.loginToReviewMessage.style.display = 'none';
        DOMElements.currentUserNameReviewForm.textContent = state.currentUser.name || state.currentUser.email;
        const avatarUrl = state.currentUser.profile_image ? `${state.currentUser.profile_image}?transform=w_80,h_80,f_webp` : null;
        DOMElements.userAvatarReviewForm.innerHTML = avatarUrl 
            ? `<img src="${avatarUrl}" alt="${state.currentUser.name}'s profile" class="w-full h-full object-cover rounded-full" loading="lazy">`
            : generateAvatar(state.currentUser.name, 'w-10 h-10', 'text-lg');

        DOMElements.reviewRatingInput.innerHTML = renderStarRatingHTML(0, 'w-6 h-6', true, 'review-rating');
        document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                DOMElements.selectedRatingInput.value = e.target.value;
                DOMElements.ratingError.style.display = 'none';
                document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(r => {
                    if (r.checked) {
                        r.classList.add('selected');
                    } else {
                        r.classList.remove('selected');
                    }
                });
            });
        });
    } else {
        DOMElements.addReviewFormSection.style.display = 'none';
        DOMElements.loginToReviewMessage.style.display = 'block';
    }
}


function renderInitialReviews() {
    DOMElements.reviewsList.innerHTML = '';
    DOMElements.reviewSkeletonLoader.style.display = 'none';
    
    if (state.initialReviews.length === 0) {
        DOMElements.noReviewsMessage.textContent = 'No reviews yet for this product. Be the first to share your experience!';
        DOMElements.noReviewsMessage.style.display = 'block';
        DOMElements.initialLoadMoreContainer.classList.add('hidden');
        return;
    }
    
    DOMElements.noReviewsMessage.style.display = 'none';
    DOMElements.reviewsList.innerHTML = state.initialReviews.map(createReviewCardHTML).join('');
    
    if (state.product.total_reviews > INITIAL_REVIEWS_COUNT) {
        DOMElements.initialLoadMoreContainer.classList.remove('hidden');
    } else {
        DOMElements.initialLoadMoreContainer.classList.add('hidden');
        DOMElements.reviewsList.insertAdjacentHTML('beforeend', `<p class="text-center text-sm text-gray-500 py-4">This is where the reviews for this product end â€” more are coming!</p>`);
    }
    
    attachReviewActionListeners();
}


function renderModalReviews(newReviews) {
    if (state.modalReviews.length === 0 && newReviews.length === 0) {
        DOMElements.fullReviewsList.innerHTML = ''; // Clear any loading indicators
        DOMElements.fullReviewsNoResultsMessage.style.display = 'block';
        DOMElements.fullReviewsNoMoreMessage.style.display = 'none';
        return;
    }
    DOMElements.fullReviewsNoResultsMessage.style.display = 'none';
    DOMElements.fullReviewsNoMoreMessage.style.display = 'none';
    
    const newReviewsHTML = newReviews.map(createReviewCardHTML).join('');
    DOMElements.fullReviewsList.insertAdjacentHTML('beforeend', newReviewsHTML);
    attachReviewActionListeners();
}

// ===================================================================
// EVENT HANDLERS
// ===================================================================

function applyReviewFilter(filterValue) {
    if (state.currentRatingFilter === filterValue && filterValue !== 0) {
        filterValue = 0; // Toggle filter off if already active
    }
    state.currentRatingFilter = filterValue;
    state.initialReviews = []; // Clear current reviews
    state.modalReviews = []; // Clear for modal too
    state.modalReviewsPage = 1; // Reset modal pagination
    state.hasMoreModalReviews = true; // Assume more reviews for new filter
    
    fetchInitialReviews(); // Re-fetch initial set with new filter
    
    // Update main page filter buttons
    DOMElements.filterRatingBtns.forEach(btn => {
        const rating = parseInt(btn.dataset.ratingFilter, 10);
        btn.classList.toggle('active', rating === state.currentRatingFilter);
        btn.classList.toggle('bg-liyog-green', rating === state.currentRatingFilter);
        btn.classList.toggle('bg-gray-700', rating !== state.currentRatingFilter);
        btn.setAttribute('aria-pressed', rating === state.currentRatingFilter);
    });
}

// Client-side validation for review form
function validateReviewForm(rating, comment, ratingErrorElement, commentErrorElement, commentInput) {
    let isValid = true;
    ratingErrorElement.style.display = 'none';
    commentErrorElement.style.display = 'none';
    commentInput.classList.remove('input-error');

    if (rating === 0) {
        ratingErrorElement.style.display = 'block';
        isValid = false;
    }

    if (comment.length < REVIEW_MIN_LENGTH || comment.length > REVIEW_MAX_LENGTH) {
        commentErrorElement.textContent = `Comment must be between ${REVIEW_MIN_LENGTH} and ${REVIEW_MAX_LENGTH} characters.`;
        commentErrorElement.style.display = 'block';
        commentInput.classList.add('input-error');
        isValid = false;
    }
    return isValid;
}

// Handles review form submission
async function handleReviewFormSubmit(event) {
    event.preventDefault();

    const rating = parseInt(DOMElements.selectedRatingInput.value, 10);
    const comment = DOMElements.reviewCommentInput.value.trim();

    if (!validateReviewForm(rating, comment, DOMElements.ratingError, DOMElements.commentError, DOMElements.reviewCommentInput)) {
        showToast('Please correct the errors in your review.', 'error');
        return;
    }

    DOMElements.submitReviewBtn.disabled = true;
    DOMElements.submitReviewBtn.textContent = 'Submitting...';

    try {
        const { error } = await supabaseClient
            .from('reviews')
            .insert({
                user_id: state.currentUser.id,
                product_id: state.product.id,
                rating: rating,
                comment: comment,
            });

        if (error) {
            console.error('Supabase error:', error);
            throw new Error(error.message || 'An unknown error occurred.');
        }

        showToast('Review submitted successfully!', 'success');
        // Clear form
        DOMElements.reviewForm.reset();
        DOMElements.selectedRatingInput.value = '0';
        document.querySelectorAll('#review-rating-input input[type="radio"]').forEach(radio => {
            radio.checked = false;
            radio.classList.remove('selected');
        });

        await refreshAllProductData(); // Refresh all review data including counts and lists

    } catch (error) {
        console.error('Error submitting review:', error);
        showToast(`Failed to submit review: ${error.message}`, 'error');
    } finally {
        DOMElements.submitReviewBtn.disabled = false;
        DOMElements.submitReviewBtn.textContent = 'Submit Review';
    }
}


// Handles liking/unliking individual reviews (UPDATED)
async function handleToggleReviewLike(event) {
    if (!state.currentUser) {
        showToast("Please log in to like reviews.", 'info');
        return;
    }

    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;
    if (!reviewId) return;

    button.disabled = true; // Disable button to prevent double clicks

    try {
        const isLikedByUser = state.userLikedReviews.has(reviewId);
        const likesSpan = button.querySelector(`span[data-review-likes="${reviewId}"]`);
        let currentLikes = parseInt(likesSpan.textContent, 10);

        if (isLikedByUser) {
            // Unlike: Delete from user_review_likes and decrement review_likes
            const { error: deleteError } = await supabaseClient
                .from('user_review_likes')
                .delete()
                .eq('user_id', state.currentUser.id)
                .eq('review_id', reviewId);
            if (deleteError) throw deleteError;

            const { error: rpcError } = await supabaseClient.rpc('decrement_review_like', { rid: reviewId }); // Assuming decrement RPC exists
            if (rpcError) throw rpcError;

            state.userLikedReviews.delete(reviewId);
            animateCount(likesSpan, currentLikes, currentLikes - 1); // Animate down
            button.classList.remove('text-liyog-green');
            spawnBubble(button, 'dislike'); // Show dislike bubbles
            showToast('Review unliked.', 'success');
        } else {
            // Like: Insert into user_review_likes and increment review_likes
            const { error: insertError } = await supabaseClient
                .from('user_review_likes')
                .insert({ user_id: state.currentUser.id, review_id: reviewId });
            if (insertError) throw insertError;

            const { error: rpcError } = await supabaseClient.rpc('increment_review_like', { rid: reviewId });
            if (rpcError) throw rpcError;

            state.userLikedReviews.add(reviewId);
            animateCount(likesSpan, currentLikes, currentLikes + 1); // Animate up
            button.classList.add('text-liyog-green');
            likesSpan.classList.add('glittering-active'); // Apply glitter effect
            setTimeout(() => likesSpan.classList.remove('glittering-active'), 1000); // Remove after short period
            spawnBubble(button, 'like'); // Show like bubbles
            showToast('Review liked!', 'success');
        }

    } catch (error) {
        console.error('Error toggling review like:', error);
        showToast(`Failed to update like status: ${error.message}`, 'error');
    } finally {
        button.disabled = false;
    }
}

// Handles review editing (UPDATED with Modal)
async function handleEditReview(event) {
    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;
    
    if (!state.currentUser) {
        showToast('You must be logged in to edit reviews.', 'info');
        return;
    }
    const reviewToEdit = [...state.initialReviews, ...state.modalReviews].find(r => r.id === reviewId);
    if (!reviewToEdit || (state.currentUser.id !== reviewToEdit.user.id && state.currentUser.role !== 'admin')) {
        showToast('You do not have permission to edit this review.', 'error');
        return;
    }

    toggleEditReviewModal(true, reviewToEdit); // Open modal with current review data
    DOMElements.editReviewForm.onsubmit = async (e) => {
        e.preventDefault();
        DOMElements.saveEditReviewBtn.disabled = true;
        DOMElements.saveEditReviewBtn.textContent = 'Saving...';

        const newComment = DOMElements.editReviewComment.value.trim();
        const newRating = parseInt(DOMElements.editSelectedRating.value, 10);

        if (!validateReviewForm(newRating, newComment, DOMElements.editRatingError, DOMElements.editCommentError, DOMElements.editReviewComment)) {
            showToast('Please correct the errors in your updated review.', 'error');
            DOMElements.saveEditReviewBtn.disabled = false;
            DOMElements.saveEditReviewBtn.textContent = 'Save Changes';
            return;
        }

        try {
            const { error } = await supabaseClient
                .from('reviews')
                .update({ comment: newComment, rating: newRating, updated_at: new Date().toISOString() })
                .eq('id', reviewId);

            if (error) throw error;

            showToast('Review updated successfully!', 'success');
            toggleEditReviewModal(false); // Close modal

            await refreshAllProductData(); // Refresh all review data

        } catch (error) {
            console.error('Error updating review:', error);
            showToast(`Failed to update review: ${error.message}`, 'error');
        } finally {
            DOMElements.saveEditReviewBtn.disabled = false;
            DOMElements.saveEditReviewBtn.textContent = 'Save Changes';
        }
    };
}


// FIXED: Handles review deletion
async function handleDeleteReview(event) {
    const button = event.currentTarget;
    const reviewId = button.dataset.reviewId;

    if (!state.currentUser) {
        showToast('You must be logged in to delete reviews.', 'info');
        return;
    }

    const reviewToDelete = [...state.initialReviews, ...state.modalReviews].find(r => r.id === reviewId);
    if (!reviewToDelete || (state.currentUser.id !== reviewToDelete.user.id && state.currentUser.role !== 'admin')) {
        showToast('You do not have permission to delete this review.', 'error');
        return;
    }

    if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('reviews')
            .delete()
            .eq('id', reviewId);

        if (error) throw error;

        showToast('Review deleted successfully!', 'success');
        await refreshAllProductData(); // Refresh all review data

    } catch (error) {
        console.error('Error deleting review:', error);
        showToast(`Failed to delete review: ${error.message}`, 'error');
    }
}


function setupEventHandlers() {
    DOMElements.qtyIncrement.addEventListener('click', () => {
        let currentVal = parseInt(DOMElements.quantityInput.value, 10);
        DOMElements.quantityInput.value = currentVal + 1;
    });
    DOMElements.qtyDecrement.addEventListener('click', () => {
        let currentVal = parseInt(DOMElements.quantityInput.value, 10);
        DOMElements.quantityInput.value = Math.max(1, currentVal - 1);
    });

    const handleAddToCart = () => { 
        console.log('Add to cart clicked', {
            productId: state.product.id,
            quantity: DOMElements.quantityInput.value
        }); 
        showToast(`Added ${DOMElements.quantityInput.value} x "${state.product.name}" to cart! (Placeholder)`, 'success');
    };
    DOMElements.addToCartBtn.addEventListener('click', handleAddToCart);
    DOMElements.mobileAddToCartBtn.addEventListener('click', handleAddToCart);
    
    const handleOrderNow = () => { 
        console.log('Order now clicked', {
            productId: state.product.id,
            quantity: DOMElements.quantityInput.value
        }); 
        showToast(`Ordering ${DOMElements.quantityInput.value} x "${state.product.name}" now! (Placeholder)`, 'success');
    };
    DOMElements.orderNowBtn.addEventListener('click', handleOrderNow);
    DOMElements.mobileOrderNowBtn.addEventListener('click', handleOrderNow);

    DOMElements.likeBtn.addEventListener('click', handleToggleLike); 
    DOMElements.shareBtn.addEventListener('click', handleShare);
    DOMElements.copyUrlBtn.addEventListener('click', handleCopyUrl);

    DOMElements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            DOMElements.tabButtons.forEach(btn => {
                btn.classList.remove('tab-btn-active', 'border-liyog-green', 'text-liyog-green-dark');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                btn.setAttribute('aria-selected', 'false');
            });
            button.classList.add('tab-btn-active', 'border-liyog-green', 'text-liyog-green-dark');
            button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            button.setAttribute('aria-selected', 'true');

            DOMElements.tabContents.forEach(content => content.classList.add('hidden'));
            const targetTabContent = document.getElementById(`tab-content-${button.dataset.tab}`);
            targetTabContent.classList.remove('hidden');

            if (button.dataset.tab === 'reviews') {
                renderReviewForm();
                // Focus the relevant element in the reviews tab
                if (state.currentUser) {
                    DOMElements.reviewCommentInput.focus();
                } else {
                    const loginLink = DOMElements.loginToReviewMessage.querySelector('a');
                    if (loginLink) loginLink.focus();
                }
            }
        });
    });

    // Review form event listeners
    DOMElements.reviewForm.addEventListener('submit', handleReviewFormSubmit);
    // Star rating input listeners are attached in `renderReviewForm` because they are dynamic
    DOMElements.reviewCommentInput.addEventListener('input', () => {
        DOMElements.reviewCommentInput.classList.remove('input-error');
        DOMElements.commentError.style.display = 'none';
    });
    
    // Filter buttons for ratings dashboard (main page)
    DOMElements.filterRatingBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const filterValue = parseInt(btn.dataset.ratingFilter, 10);
            applyReviewFilter(filterValue);
        });
    });

    // Media navigation arrows
    DOMElements.mediaPrevBtn.addEventListener('click', () => {
        if (state.currentMediaIndex > 0) {
            state.currentMediaIndex--;
            renderMainMedia(state.currentMediaIndex);
            updateActiveThumbnail();
        }
    });
    DOMElements.mediaNextBtn.addEventListener('click', () => {
        if (state.currentMediaIndex < state.mediaItems.length - 1) {
            state.currentMediaIndex++;
            renderMainMedia(state.currentMediaIndex);
            updateActiveThumbnail();
        }
    });

    // Edit review modal buttons
    DOMElements.cancelEditReviewBtn.addEventListener('click', () => toggleEditReviewModal(false));

    // NEW: View All Reviews button
    DOMElements.viewAllReviewsBtn.addEventListener('click', openFullReviewsModal);

    // NEW: Full Reviews Modal close buttons/swipe
    DOMElements.closeFullReviewsBtn.addEventListener('click', closeFullReviewsModal);
    DOMElements.fullReviewsModal.addEventListener('click', (e) => {
        if (e.target === DOMElements.fullReviewsModal) {
            closeFullReviewsModal();
        }
    });

    // NEW: Modal filter buttons (these were already defined in DOMElements)
    DOMElements.fullModalFilterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const filterValue = parseInt(btn.dataset.ratingFilter, 10);
            if (state.currentRatingFilter === filterValue) {
                state.currentRatingFilter = 0; // Toggle off if already active
            } else {
                state.currentRatingFilter = filterValue;
            }
            updateModalFilterButtons();
            fetchModalReviews(true); // Fetch with new filter
        });
    });

    // NEW: Infinite Scroll for Modal Reviews
    DOMElements.fullReviewsListScrollArea.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = DOMElements.fullReviewsListScrollArea;
        if (scrollHeight - scrollTop - clientHeight < 300) { // Fetch when 300px from bottom
            fetchModalReviews();
        }
    });
    DOMElements.fullReviewsLoadMoreBtn.addEventListener('click', () => fetchModalReviews());
}


// Attaches event listeners for dynamically rendered review cards (like, edit, delete)
function attachReviewActionListeners() {
    document.querySelectorAll('.review-like-btn').forEach(button => {
        button.removeEventListener('click', handleToggleReviewLike); // Prevent duplicates
        button.addEventListener('click', handleToggleReviewLike);
    });

    document.querySelectorAll('.review-edit-btn').forEach(button => {
        button.removeEventListener('click', handleEditReview); // Prevent duplicates
        button.addEventListener('click', handleEditReview);
    });

    document.querySelectorAll('.review-delete-btn').forEach(button => {
        button.removeEventListener('click', handleDeleteReview); // Prevent duplicates
        button.addEventListener('click', handleDeleteReview);
    });
}


// REWRITTEN handleLike function for toggle and DB-only counter update
async function handleToggleLike() {
    DOMElements.likeBtn.disabled = true;

    if (!state.currentUser) {
        showToast("Please log in to like products.", 'info');
        DOMElements.likeBtn.disabled = false;
        return;
    }
    
    const productId = state.product.id;
    const userId = state.currentUser.id;
    
    const existingLikeId = await getExistingLike(productId, userId);
    
    let action = '';

    try {
        if (existingLikeId) {
            const { error } = await supabaseClient
                .from('likes')
                .delete()
                .eq('id', existingLikeId);
            
            if (error) throw error;
            action = 'unliked';

        } else {
            const { error } = await supabaseClient
                .from('likes')
                .insert({ user_id: userId, product_id: productId });
            
            if (error) throw error;
            action = 'liked';
        }
        
        // Re-fetch product data to get updated total_likes
        const { data: updatedProduct, error: fetchError } = await supabaseClient
            .from('products')
            .select('total_likes')
            .eq('id', productId)
            .single();

        if (fetchError) {
             console.error("Failed to re-fetch likes count:", fetchError);
             // Best effort update
             state.product.total_likes += (action === 'liked' ? 1 : -1);
             state.isLiked = (action === 'liked');
        } else {
            state.product.total_likes = updatedProduct.total_likes;
            state.isLiked = (action === 'liked');
        }
        
        renderProductDetails();
        showToast(`Product ${action} successfully!`, 'success');

    } catch (error) {
        console.error(`Failed to ${action} product:`, error);
        showToast(`Could not save your action: ${error.message}`, 'error');
    } finally {
        DOMElements.likeBtn.disabled = false;
    }
}


async function handleShare() {
    let referralCode = '';
    if (state.currentUser && !state.currentUser.referral_code) {
        try {
            const { data, error } = await supabaseClient
                .from('users')
                .select('referral_code')
                .eq('id', state.currentUser.id)
                .single();
            if (data && data.referral_code) {
                state.currentUser.referral_code = data.referral_code;
            } else if (error && error.code !== 'PGRST116') {
                 console.warn("Error fetching referral code:", error.message);
            }
        } catch (error) {
            console.error("Failed to fetch referral code:", error);
        }
    }
    referralCode = state.currentUser?.referral_code || '';
    
    let shareUrl = `${window.location.origin}${window.location.pathname}?slug=${state.product.slug}`;
    if (referralCode) {
        shareUrl += `&ref=${referralCode}`;
    }

    if (navigator.share) {
        navigator.share({
            title: state.product.name,
            text: `Check out this product on Liyog: ${state.product.name}`,
            url: shareUrl,
        }).catch((error) => console.error('Error sharing:', error));
    } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('Product link copied to clipboard!', 'success');
        }).catch((error) => {
            console.error('Failed to copy link:', error);
            showToast('Could not copy link to clipboard. Please copy it manually: ' + shareUrl, 'error');
        });
    }
}

// NEW: Handle Copy URL button
async function handleCopyUrl() {
    let url = `${window.location.origin}${window.location.pathname}?slug=${state.product.slug}`;
     if (state.currentUser?.referral_code) {
        url += `&ref=${state.currentUser.referral_code}`;
    }

    try {
        await navigator.clipboard.writeText(url);
        showToast('Product URL copied to clipboard!', 'success');
    } catch (error) {
        console.error('Failed to copy URL:', error);
        showToast('Could not copy URL to clipboard. Please copy it manually.', 'error');
    }
}


// NEW: Central function to open the full reviews modal
function openFullReviewsModal() {
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
    DOMElements.fullReviewsModal.classList.add('open');
    DOMElements.fullReviewsModal.setAttribute('aria-hidden', 'false');

    // Populate modal dashboard with latest data from product (which is fetched regularly)
    DOMElements.fullModalAvgRating.textContent = (state.product.avg_rating || 0).toFixed(1);
    DOMElements.fullModalStarRating.innerHTML = renderStarRatingHTML(state.product.avg_rating, 'w-6 h-6');
    animateCount(DOMElements.fullModalTotalReviews, 0, state.product.total_reviews, 700);
    
    // Ensure the state.reviewsData is up-to-date for the chart.
    // If not, calculate from `state.initialReviews` or re-fetch stats if necessary.
    // For simplicity, we'll re-process using initial reviews as a base, assuming they're representative.
    processReviewsData(state.initialReviews, DOMElements.fullModalAvgRating, DOMElements.fullModalStarRating, DOMElements.fullModalTotalReviews, DOMElements.fullModalRatingsChart, DOMElements.fullModalFilterBtns);

    state.currentRatingFilter = 0; // Reset filter when opening modal
    updateModalFilterButtons();
    fetchModalReviews(true); // Fetch all reviews for modal
}

// NEW: Central function to close the full reviews modal
function closeFullReviewsModal() {
    document.body.style.overflow = ''; // Restore background scrolling
    DOMElements.fullReviewsModal.classList.remove('open');
    DOMElements.fullReviewsModal.setAttribute('aria-hidden', 'true');
    // Optionally reset scroll position
    DOMElements.fullReviewsListScrollArea.scrollTop = 0; 
}

// NEW: Update filter buttons in the modal
function updateModalFilterButtons() {
    DOMElements.fullModalFilterBtns.forEach(btn => {
        const rating = parseInt(btn.dataset.ratingFilter, 10);
        btn.classList.toggle('active', rating === state.currentRatingFilter);
        btn.classList.toggle('bg-liyog-green', rating === state.currentRatingFilter);
        btn.classList.toggle('bg-gray-700', rating !== state.currentRatingFilter);
        btn.setAttribute('aria-pressed', rating === state.currentRatingFilter);
    });
}

// ===================================================================
// REALTIME & DATA REFRESH
// ===================================================================

async function refreshAllProductData() {
    // This function becomes a central point for updating UI after a major change
    const slug = state.product.slug;
    state.product = await fetchProduct(slug); // Re-fetch product to get latest review counts etc.
    renderProductDetails();
    await fetchInitialReviews(); // Re-fetch initial set of reviews for main page

    // If modal is open, refresh its contents too
    if (DOMElements.fullReviewsModal.classList.contains('open')) {
        await fetchModalReviews(true); // Re-fetch all reviews for the modal
    }
}

function setupSupabaseRealtime() {
    if (!state.product) return;

    supabaseClient
        .channel(`product_reviews:${state.product.id}`)
        .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'reviews', filter: `product_id=eq.${state.product.id}` },
            async (payload) => {
                console.log('Realtime change received:', payload);
                showToast('Reviews have been updated!', 'info');
                await refreshAllProductData(); // Trigger full refresh
            }
        )
        .subscribe();
    console.log(`Subscribed to realtime changes for product reviews: ${state.product.id}`);
}


// ===================================================================
// APPLICATION BOOTSTRAP
// ===================================================================

document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('footer-year').textContent = new Date().getFullYear();
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug');

    if (!slug) {
        DOMElements.loader.classList.add('hidden');
        document.getElementById('main-content').innerHTML = `
            <div class="text-center p-10 bg-white rounded-lg shadow-md max-w-lg mx-auto mt-10">
                <h1 class="text-3xl font-bold text-red-600 mb-4">Product Not Found</h1>
                <p class="text-gray-700 text-lg mb-6">It looks like the product you're looking for doesn't exist or the link is invalid.</p>
                <a href="products.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    Back to Shop
                </a>
            </div>
        `;
        return;
    }

    try {
        await Promise.all([
            fetchCurrentUser(),
            fetchSettings()
        ]);
        
        state.product = await fetchProduct(slug);
        
        if (state.product) {
            const { error: rpcError } = await supabaseClient
                .rpc('increment_product_views', { pid: state.product.id }); 
            if (rpcError) {
                console.error("Failed to increment product views via RPC:", rpcError);
            }
        }

        if (state.currentUser && state.product) {
            const existingLikeId = await getExistingLike(state.product.id, state.currentUser.id);
            if (existingLikeId) {
                state.isLiked = true;
            }
        }

        renderProductDetails();
        renderMediaGallery();
        renderReviewForm();

        // Animate total reviews count on load
        const totalReviewsCount = state.product.total_reviews || 0;
        // Start animation from 0 to current totalReviews, but only if it's not already showing 0
        if (DOMElements.totalReviews.textContent === '0') {
            animateCount(DOMElements.totalReviews, 0, totalReviewsCount, 1000);
        } else {
            DOMElements.totalReviews.textContent = totalReviewsCount.toLocaleString(); // Just set if already a number
        }


        await Promise.all([
            fetchInitialReviews(), // Fetches initial reviews for the main page
            (async () => {
                const related = await fetchRelatedProducts(state.product);
                if (related && related.length > 0) {
                    DOMElements.relatedProductsSection.classList.remove('hidden');
                    DOMElements.relatedProductsCarousel.innerHTML = related.map(createProductCardHTML).join('');
                }
            })(),
            (async () => {
                const youMayLike = await fetchYouMayLikeProducts();
                DOMElements.youMayLikeCarousel.innerHTML = youMayLike.map(createProductCardHTML).join('');
            })()
        ]);

        setupSupabaseRealtime(); // Setup realtime listeners after initial load

        DOMElements.loader.classList.add('hidden');
        DOMElements.content.classList.remove('hidden');

        setupEventHandlers();

    } catch (error) {
        console.error("Initialization Error:", error);
        DOMElements.loader.classList.add('hidden');
        document.getElementById('main-content').innerHTML = `
            <div class="text-center p-10 bg-white rounded-lg shadow-md max-w-lg mx-auto mt-10">
                <h1 class="text-3xl font-bold text-red-600 mb-4">Error Loading Product</h1>
                <p class="text-gray-700 text-lg mb-6">${error.message || 'An unexpected error occurred. Please try again later.'}</p>
                <a href="products.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-liyog-green hover:bg-liyog-green-dark transition-colors">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    Back to Shop
                </a>
            </div>
        `;
        showToast(`Failed to load product: ${error.message}`, 'error');
    }
});
</script>

</body>
</html>


