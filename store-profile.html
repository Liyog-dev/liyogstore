<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // ============================================================
        // CONFIG & INITIALIZATION
        // ============================================================
        const SUPABASE_URL = "https://snwwlewjriuqrodpjhry.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNud3dsZXdqcml1cXJvZHBqaHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDY3MDAsImV4cCI6MjA2ODE4MjcwMH0.WxOmEHxLcEHmMKFjsgrzcb22mPs-sJwW_G3GOuXX2c8";
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================================
        // Helper: fetch user by ID
        // ============================================================
        async function fetchSafeUserById(userId) {
            if (!userId) return null;
            try {
                const { data, error } = await supabaseClient
                    .from('safe_users')
                    .select(`
                        id, username, name, profile_image, cover_image,
                        verified, is_online, last_seen_at, bio, location,
                        referral_code, created_at, role
                    `)
                    .eq('id', userId)
                    .single();
                if (error) {
                    if (error.code !== 'PGRST116') console.error("Error fetching user:", error.message);
                    return null;
                }
                return data;
            } catch (err) {
                console.error("Error in fetchSafeUserById:", err.message);
                return null;
            }
        }

        // ============================================================
        // Helper: Generate fallback avatar
        // ============================================================
        function generateAvatar(name, size='w-16 h-16', textSize='text-lg') {
            const initials = (name || '?').split(' ').map(n => n[0]).join('').toUpperCase();
            return `<div class="flex items-center justify-center bg-gray-300 rounded-full ${size}">
                        <span class="${textSize} font-bold text-gray-800">${initials}</span>
                    </div>`;
        }

        // ============================================================
        // Helper: Render the user profile
        // ============================================================
        function renderUserProfile(user) {
            const container = document.getElementById('profile-container');

            // Cover image
            const cover = document.createElement('div');
            cover.className = 'cover h-40 w-full bg-gray-200 relative overflow-hidden';
            if (user.cover_image) {
                cover.innerHTML = `<img src="${user.cover_image}" alt="Cover" class="w-full h-full object-cover">`;
            }
            container.appendChild(cover);

            // Avatar + name + badges
            const avatarWrapper = document.createElement('div');
            avatarWrapper.className = 'flex items-center mt-[-40px] ml-4';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar w-20 h-20 rounded-full border-4 border-white overflow-hidden';
            if (user.profile_image) {
                avatar.innerHTML = `<img src="${user.profile_image}" alt="${user.name}" class="w-full h-full object-cover">`;
            } else {
                avatar.innerHTML = generateAvatar(user.name, 'w-20 h-20', 'text-2xl');
            }
            avatarWrapper.appendChild(avatar);

            // Name + badges
            const info = document.createElement('div');
            info.className = 'ml-4 flex items-center';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = user.name || 'Admin';
            nameSpan.className = 'font-bold text-xl whitespace-nowrap';
            info.appendChild(nameSpan);

            if (user.verified) {
                const verifiedBadge = document.createElement('span');
                verifiedBadge.textContent = '✔️';
                verifiedBadge.title = user.role === 'admin' ? 'Verified BRAND' : user.role === 'super_admin' ? 'Verified BRAND+' : 'Verified User';
                verifiedBadge.className = 'ml-2 text-yellow-500';
                info.appendChild(verifiedBadge);
            }

            if (user.role) {
                const roleBadge = document.createElement('span');
                roleBadge.textContent = user.role.toUpperCase();
                roleBadge.className = 'ml-2 px-2 py-1 bg-gray-800 text-white rounded text-xs';
                info.appendChild(roleBadge);
            }

            avatarWrapper.appendChild(info);
            container.appendChild(avatarWrapper);

            // Bio & location
            const bioEl = document.createElement('p');
            bioEl.textContent = user.bio || 'No bio available.';
            bioEl.className = 'mt-4 ml-4 text-gray-700';
            container.appendChild(bioEl);

            const locationEl = document.createElement('p');
            locationEl.textContent = user.location ? `Location: ${user.location}` : '';
            locationEl.className = 'ml-4 mt-1 text-gray-500';
            container.appendChild(locationEl);
        }

        // ============================================================
        // Main: Detect user ID from sessionStorage or slug
        // ============================================================
        async function loadProfile() {
            let userId = sessionStorage.getItem('profile_target_id');

            // Optional: fallback to slug in URL (e.g., /p/john-doe)
            if (!userId) {
                const pathParts = window.location.pathname.split('/');
                if (pathParts[1] === 'p' && pathParts[2]) {
                    const slug = pathParts[2];
                    // Search Supabase for user by username or fallback name
                    const { data: users } = await supabaseClient
                        .from('safe_users')
                        .select('*');
                    const matched = users.find(u => {
                        const slugFromUser = (u.username || u.name || 'user')
                            .trim().toLowerCase().replace(/\s+/g, '-');
                        return slugFromUser === slug.toLowerCase();
                    });
                    if (matched) userId = matched.id;
                }
            }

            if (!userId) {
                document.getElementById('profile-container').innerHTML = '<p class="text-red-600 mt-4 ml-4">User not found.</p>';
                return;
            }

            const user = await fetchSafeUserById(userId);
            if (user) renderUserProfile(user);
            else document.getElementById('profile-container').innerHTML = '<p class="text-red-600 mt-4 ml-4">User not found.</p>';
        }

        window.addEventListener('DOMContentLoaded', loadProfile);
    </script>

    <style>
        body { font-family: sans-serif; background: #f9f9f9; margin: 0; }
        .glass-tooltip {
            background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="profile-container" class="max-w-2xl mx-auto mt-4 bg-white rounded shadow-md overflow-hidden p-4">
        <!-- Profile will be rendered here -->
        <p class="text-gray-500">Loading profile...</p>
    </div>
</body>
</html>
