<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BatoLiyog World | Auth</title>
  <style>
    :root{
      --bg: #1C352D;
      --card: #ffffff;
      --accent: #00b140;
      --accent-dark: #009435;
      --muted: #6b6b6b;
      --toast-success: #27ae60;
      --toast-error: #c0392b;
      --glass: rgba(255,255,255,0.7);
      --gold: #d4af37;
      --black: #0a0a0a;
    }
    :root[data-theme="dark"] {
      --bg: #0f1720;
      --card: #0b1220;
      --accent: #00e657;
      --accent-dark: #00c94b;
      --muted: #bfc7c2;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, rgba(0,177,64,0.18), rgba(0,177,64,0.04)) fixed, var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      transition:background .35s ease, color .35s ease;
    }
    .page {
      width:100%;
      max-width:1200px;
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:36px;
      align-items:center;
      padding:20px;
    }
    .hero {
      border-radius:20px;
      padding:40px;
      min-height:460px;
      color:white;
      background: linear-gradient(180deg, var(--black), #1a1a1a);
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:18px;
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset: -10% -20%;
      background: radial-gradient(circle at 20% 20%, rgba(255,215,0,0.05), transparent 20%),
                  radial-gradient(circle at 90% 80%, rgba(255,215,0,0.07), transparent 30%);
      transform: rotate(12deg);
    }
    .hero h1{
      margin:0;
      font-size:34px;
      line-height:1.1;
      font-weight:900;
      color:var(--gold);
      text-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .hero p{
      margin:0;
      color:rgba(255,255,255,0.92);
      font-size:16px;
      line-height:1.6;
    }
    .features{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      background: rgba(255,255,255,0.08);
      padding:8px 14px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      color:#fff;
      border:1px solid rgba(255,255,255,0.06);
    }
    .highlight-box {
      background: var(--gold);
      color: var(--black);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .auth-container{
      background:var(--card);
      border-radius:14px;
      box-shadow: 0 12px 40px rgba(11,12,14,0.1);
      padding:36px;
      width:100%;
      max-width:460px;
      transition: transform .4s ease, box-shadow .4s ease;
    }
    .auth-container:hover{ transform: translateY(-3px); }
    h2 { text-align:center; color:var(--accent); margin:0 0 12px 0; font-size:22px; font-weight:800 }
    form { display:block; }
    .row { display:flex; gap:10px; }
    .col { flex:1; }
    label{ font-size:13px; color:var(--muted); display:block; margin:8px 0 6px 0 }
    input, select, button, .input-wrap {
      width:100%;
      padding:13px 15px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,0.08);
      font-size:15px;
      background:transparent;
      transition: border-color .18s, box-shadow .18s, transform .12s;
    }
    input:focus, select:focus { outline:none; border-color: var(--accent); box-shadow: 0 6px 20px rgba(0,177,64,0.15) }
    .input-wrap { display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06) }
    .input-wrap input { border:none; padding:12px; width:100%; border-radius:8px; background:transparent }
    button.primary { background: linear-gradient(90deg,var(--accent),var(--accent-dark)); color:white; border:0; padding:13px; border-radius:8px; font-weight:700; cursor:pointer; letter-spacing:0.5px }
    .small { font-size:13px; color:var(--muted); text-align:center; margin-top:8px }
    .toggle { text-align:center; margin-top:12px }
    .toggle a{ color:var(--accent); cursor:pointer; font-weight:700 }
    .hidden{ display:none !important }
    .message { text-align:center; font-size:14px; color:var(--toast-error); min-height:20px }
    footer { margin-top:20px; text-align:center; font-size:13px; color:var(--muted) }
    @media(max-width:960px){
      .page{ grid-template-columns: 1fr; padding:16px }
      .hero{ order:2; margin-top:18px }
    }
    @media(max-width:520px){
      .hero h1{ font-size:24px }
      .auth-container{ padding:24px }
    }
    .fade-in { animation: fadeIn .6s ease both }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: translateY(0) } }
    .pw-toggle { background:transparent; border:none; cursor:pointer; padding:6px; color:var(--muted) }
  /* === Toast Notifications === */
#toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  min-width: 260px;
  max-width: 320px;
  padding: 14px 18px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #F2C464;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  opacity: 0;
  pointer-events: none;
  z-index: 9999;
  transform: translateY(20px);
  transition: all 0.35s ease;
  background: #333; /* Default background color */
}
#toast.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}
#toast.success { background: var(--toast-success, #27ae60); }
#toast.error { background: var(--toast-error, #c0392b); }
  
  </style>
</head>
<body>

  <div class="page">
    <section class="hero">
      <h1>LiyX ‚Äî Building the Future Marketplace</h1>
      <p>Step into a world where <strong>innovation meets opportunity</strong>. Earn Liyog Coins, unlock exclusive deals, and become part of a fast-growing network shaping commerce, lifestyle, and wealth creation.</p>
      <div class="features">
        <div class="chip">Liyog Coins</div>
        <div class="chip">Referral Rewards</div>
        <div class="chip">Secure Auth</div>
        <div class="chip">Exclusive Discounts</div>
        <div class="chip">Premium Community</div>
      </div>
      <div class="highlight-box">Join today and start earning from your connections!</div>
      <div style="margin-top:auto; display:flex; justify-content:space-between; align-items:center; gap:12px">
        <div style="color:rgba(255,255,255,0.9)">
          <div style="font-weight:700; font-size:16px">LiyXstore ‚Äî More than Shopping</div>
          <div style="font-size:13px; opacity:0.95">Alternate names: <i>LiyX Marketplace</i>, <i>LiyX Mall</i></div>
        </div>
        <div style="display:flex; gap:8px; text-align:right">
     <button id="mute-voice" title="Toggle voice greeting">üéôÔ∏è</button>
          <button class="theme-toggle" id="theme-toggle">Toggle Theme</button>
        </div>
      </div>
    </section>

    <aside class="auth-container fade-in" aria-labelledby="form-title">
      <h2 id="form-title">Login</h2>

      <!-- Sign Up -->
      <form id="signup-form" class="hidden" autocomplete="on" novalidate>
        <label for="signup-username">Full Name</label>
        <input id="signup-username" type="text" placeholder="Full name" required />
        <label for="signup-email">Email</label>
        <input id="signup-email" type="email" placeholder="name@example.com" required />
        <label for="signup-password">Password</label>
        <div class="input-wrap">
          <input id="signup-password" type="password" placeholder="Create password" required />
          <button type="button" class="pw-toggle" data-target="signup-password">üëÅ</button>
        </div>
        <div class="row">
          <div class="col">
            <label for="signup-phone">Phone</label>
            <input id="signup-phone" type="tel" placeholder="+2348012345678" />
          </div>
          <div class="col">
            <label for="signup-country">Country</label>
            <select id="signup-country"></select>
          </div>
        </div>
        <label for="signup-state">State / Region</label>
        <select id="signup-state"><option value="">Select state</option></select>
        <label for="signup-referral">Referral Code (optional)</label>
        <input id="signup-referral" type="text" placeholder="e.g. liyog3454" />
        <div style="display:flex; gap:8px; margin-top:8px">
          <button type="submit" class="primary" id="signup-submit">Sign Up</button>
        </div>
      </form>

      <!-- Login -->
      <form id="login-form" autocomplete="on" novalidate>
        <label for="login-email">Email</label>
        <input id="login-email" type="email" placeholder="name@example.com" required />
        <label for="login-password">Password</label>
        <div class="input-wrap">
          <input id="login-password" type="password" placeholder="Your password" required />
          <button type="button" class="pw-toggle" data-target="login-password">üëÅ</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button type="submit" class="primary" id="login-submit">Login</button>
        </div>
      </form>

      <!-- Forgot -->
      <form id="forgot-form" class="hidden" novalidate>
        <label for="forgot-email">Email to reset</label>
        <input id="forgot-email" type="email" placeholder="you@example.com" required />
        <button type="submit" class="primary">Send Reset Link</button>
      </form>

      <div class="message" id="auth-message"></div>
      <div class="toggle" id="toggle-links">
        <div><a id="toggle-signup">Don't have an account? Sign Up</a></div>
        <div><a id="toggle-login" class="hidden">Already have an account? Login</a></div>
        <div><a id="toggle-forgot">Forgot Password?</a></div>
      </div>
      <div style="margin-top:18px; padding-top:12px; border-top:1px dashed rgba(0,0,0,0.06)">
        <div style="font-style:italic; color:var(--muted); font-size:13px">‚ÄúWhen something is important enough, you do it even if the odds are not in your favor.‚Äù ‚Äî Elon Musk</div>
      </div>
      <footer>
        <div><strong>LiyX</strong> ‚Ä¢ Building tomorrow's marketplace</div>
        <div style="font-size:12px; color:var(--muted)">¬© 2025 LiyX ¬∑ LiyXstore</div>
      </footer>
    </aside>
  </div>

  <div id="toast"></div>

  
   
  <script type="module">
    /* --------------------------
       Supabase initialization
       --------------------------
       IMPORTANT: Replace keys if rotated. Keep anon key private-ish.
    */
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://snwwlewjriuqrodpjhry.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNud3dsZXdqcml1cXJvZHBqaHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MDY3MDAsImV4cCI6MjA2ODE4MjcwMH0.WxOmEHxLcEHmMKFjsgrzcb22mPs-sJwW_G3GOuXX2c8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    /* --------------------------
       DOM references (keep IDs same)
       -------------------------- */
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const forgotForm = document.getElementById("forgot-form");
    const authMessage = document.getElementById("auth-message");
    const toggleSignup = document.getElementById("toggle-signup");
    const toggleLogin = document.getElementById("toggle-login");
    const toggleForgot = document.getElementById("toggle-forgot");
    const formTitle = document.getElementById("form-title");
    const toastEl = document.getElementById("toast");
   const themeToggle = document.getElementById("theme-toggle");
   const muteVoiceBtn = document.getElementById("mute-voice");

    /* --------------------------
       UI helpers: Toast & loading
       -------------------------- */
    function showToast(message, type = 'info', duration = 4000) {
      toastEl.innerHTML = '';
      const icon = document.createElement('div');
      icon.className = 'icon';
      icon.style.background = (type === 'error') ? 'var(--toast-error)' : 'var(--toast-success)';
      icon.textContent = (type === 'error') ? '!' : '‚úì';
      const txt = document.createElement('div');
      txt.style.flex = '1';
      txt.textContent = message;
      toastEl.appendChild(icon);
      toastEl.appendChild(txt);
      toastEl.classList.add('show');
      // üîä Speak toast text if voice is enabled
      speak(message);
      clearTimeout(showToast._to);
      showToast._to = setTimeout(() => toastEl.classList.remove('show'), duration);
    }
  
  

    function setFormLoading(form, isLoading = true) {
      [...form.elements].forEach(el => el.disabled = isLoading);
      const submit = form.querySelector('button[type="submit"]');
      if (submit) submit.textContent = isLoading ? 'Please wait...' : (submit.dataset.orig || (submit.dataset.orig = submit.textContent));
    }

    /* --------------------------
       Theme toggle
       -------------------------- */
    function getTheme(){
      return document.documentElement.getAttribute('data-theme') || localStorage.getItem('theme') || 'light';
    }
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
      localStorage.setItem('theme', t);
    }
    // initialize theme
    applyTheme(getTheme());
    themeToggle.addEventListener('click', () => applyTheme(getTheme() === 'dark' ? 'light' : 'dark'));

    /* --------------------------
       Toggle between forms (keeps your logic)
       -------------------------- */
    toggleSignup.addEventListener("click", () => {
      loginForm.classList.add("hidden");
      forgotForm.classList.add("hidden");
      signupForm.classList.remove("hidden");
      formTitle.innerText = "Sign Up";
      toggleSignup.classList.add("hidden");
      toggleLogin.classList.remove("hidden");
      authMessage.textContent = '';
    });

    toggleLogin.addEventListener("click", () => {
      signupForm.classList.add("hidden");
      forgotForm.classList.add("hidden");
      loginForm.classList.remove("hidden");
      formTitle.innerText = "Login";
      toggleSignup.classList.remove("hidden");
      toggleLogin.classList.add("hidden");
      authMessage.textContent = '';
    });

    toggleForgot.addEventListener("click", () => {
      signupForm.classList.add("hidden");
      loginForm.classList.add("hidden");
      forgotForm.classList.remove("hidden");
      formTitle.innerText = "Reset Password";
      toggleSignup.classList.remove("hidden");
      toggleLogin.classList.remove("hidden");
      authMessage.textContent = '';
    });

    /* --------------------------
       Password visibility toggles
       (uses same IDs so your functions are unchanged)
       -------------------------- */
    document.querySelectorAll('.pw-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.target;
        const input = document.getElementById(id);
        if (!input) return;
        if (input.type === 'password') {
          input.type = 'text';
          btn.textContent = 'üôà';
        } else {
          input.type = 'password';
          btn.textContent = 'üëÅ';
        }
      });
    });

    /* --------------------------
       Voice greeting (Web Speech API)
       -------------------------- */
    let voiceEnabled = true;
    muteVoiceBtn.addEventListener('click', () => {
      voiceEnabled = !voiceEnabled;
      muteVoiceBtn.textContent = voiceEnabled ? 'üéôÔ∏è' : 'üîï';
    });
    function speak(text) {
      if (!voiceEnabled || !("speechSynthesis" in window)) return;
      const msg = new SpeechSynthesisUtterance(text);
      msg.rate = 0.95;
      msg.pitch = 1;
      msg.lang = 'en-US';
      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    /* --------------------------
       Country & state selection
       - For full production you should load a fuller dataset from a server or CDN.
       - For demo we include a compact list for immediate UX; you can replace or extend it.
       -------------------------- */
    const countries = [
      { code: 'NG', name: 'Nigeria', states: ['Lagos', 'Abuja FCT', 'Rivers', 'Oyo', 'Kano'] },
      { code: 'US', name: 'United States', states: ['California','New York','Texas','Florida','Illinois'] },
      { code: 'GB', name: 'United Kingdom', states: ['England','Scotland','Wales','Northern Ireland'] },
      { code: 'CA', name: 'Canada', states: ['Ontario','Quebec','British Columbia','Alberta'] },
      { code: 'IN', name: 'India', states: ['Maharashtra','Delhi','Karnataka','Tamil Nadu'] }
      // Add more or fetch full list from a secure endpoint or CDN.
    ];
    const countryEl = document.getElementById('signup-country');
    const stateEl = document.getElementById('signup-state');
    function populateCountries(){
      countryEl.innerHTML = '<option value="">Select country</option>';
      countries.forEach(c => {
        const op = document.createElement('option');
        op.value = c.code;
        op.textContent = c.name;
        countryEl.appendChild(op);
      });
    }
    function populateStates(code){
      stateEl.innerHTML = '<option value="">Select state</option>';
      const country = countries.find(c => c.code === code);
      if (!country) return;
      country.states.forEach(s => {
        const op = document.createElement('option');
        op.value = s;
        op.textContent = s;
        stateEl.appendChild(op);
      });
    }
    populateCountries();
    countryEl.addEventListener('change', (e)=> populateStates(e.target.value));

    /* --------------------------
       Referral code generation & validation logic (server-checked)
       Core rules implemented here:
       1) Create a friendly code using name prefix + secure random suffix
       2) Ensure uniqueness by checking the users.referral_code column (loop until unique)
       3) If user supplied a referral, look up referring user's UUID and set referred_by
       4) Insert custom user record in 'users' table (id = auth.user.id)
       5) Default total_liyog_coins = 0, wallet_balance = 0
       NOTE: The robust place for final enforcement is server-side (DB constraint + RPC).
       -------------------------- */

    async function generateUniqueReferralCode(namePrefix) {
      // create a base prefix: letters only, short
      const prefix = (namePrefix || 'liyog').replace(/[^a-zA-Z]/g,'').substring(0,5).toLowerCase() || 'liyx';
      let attempt=0;
      while(attempt < 10) {
        attempt++;
        // random 6-character alphanumeric
        const suffix = Math.random().toString(36).slice(2, 8);
        const candidate = (prefix + suffix).toLowerCase();
        // check DB for uniqueness
        const { data, error } = await supabase
          .from('users')
          .select('id')
          .eq('referral_code', candidate)
          .maybeSingle(); // maybeSingle returns null if not found
        if (error) {
          // if there's an error reading DB, still continue attempts but log
          console.warn('Referral lookup error (attempt):', error);
        }
        if (!data) {
          // not found -> unique
          return candidate;
        }
        // else loop
      }
      // fallback: uuid fragment
      return prefix + crypto.randomUUID().split('-')[0];
    }

    async function resolveReferral(referredCode) {
      if (!referredCode) return null;
      const { data, error } = await supabase
        .from('users')
        .select('id')
        .eq('referral_code', referredCode)
        .maybeSingle();
      if (error) {
        console.warn('Referral resolve error:', error);
        return null;
      }
      return data ? data.id : null;
    }

    /* --------------------------
       Session handling & caching
       - We use Supabase client auth state + localStorage lightweight caching
       - For production, always fetch fresh profile server-side after login
       -------------------------- */
    function cacheProfile(profile) {
      try { localStorage.setItem('liyx_profile', JSON.stringify(profile)); } catch(e){/*ignore*/}
    }
    function getCachedProfile() {
      try { return JSON.parse(localStorage.getItem('liyx_profile') || 'null'); } catch(e){ return null }
    }

    supabase.auth.onAuthStateChange((event, session) => {
      // Listen for login/logout; update cache
      if (session && session.user) {
        const cached = getCachedProfile() || {};
        cached.id = session.user.id;
        cached.email = session.user.email;
        cacheProfile(cached);
      } else {
        localStorage.removeItem('liyx_profile');
      }
    });

    /* --------------------------
       Signup flow: keep your form ids & behavior intact
       -------------------------- */
    signupForm?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      authMessage.textContent = 'Creating account...';
      setFormLoading(signupForm, true);

      const name = document.getElementById('signup-username').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const phone = document.getElementById('signup-phone').value.trim();
      const countryCode = document.getElementById('signup-country').value;
      const state = document.getElementById('signup-state').value;
      const referralInput = document.getElementById('signup-referral').value.trim();

      // Basic front-end validation
      if (!name || !email || !password) {
        showToast('Please complete required fields', 'error');
        setFormLoading(signupForm, false);
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Please enter a valid email', 'error');
        setFormLoading(signupForm, false);
        return;
      }
      if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        setFormLoading(signupForm, false);
        return;
      }
      if (!countryCode) {
        showToast('Please select a country', 'error');
        setFormLoading(signupForm, false);
        return;
      }
      const location = countryCode + (state ? `, ${state}` : '');

      // Resolve referral if provided (silently)
      let referred_by = null;
      if (referralInput) {
        const refId = await resolveReferral(referralInput);
        if (!refId) {
          showToast('Invalid referral code', 'error');
          setFormLoading(signupForm, false);
          return;
        }
        referred_by = refId;
      }

      // 1) create user in Supabase Auth
      const { data: authData, error: signUpError } = await supabase.auth.signUp({ email, password });
      if (signUpError || !authData?.user) {
        showToast('Signup error: ' + (signUpError?.message || 'Unknown'), 'error');
        setFormLoading(signupForm, false);
        return;
      }

      const userId = authData.user.id;

      // 2) generate unique referral code
      const referral_code = await generateUniqueReferralCode(name);

      // 3) insert into custom users table
      const { error: insertError } = await supabase
        .from('users')
        .insert([{
          id: userId,
          name,
          email,
          phone: phone || null,
          profile_image: null,
          wallet_balance: 0,
          total_liyog_coins: 0,
          referred_by,
          role: 'user',
          location,
          is_active: true,
          referral_code
        }]);

      if (insertError) {
        // handle potential conflict on referral_code or other DB errors
        console.error('Insert error:', insertError);
        showToast('User insert error: ' + insertError.message, 'error');
        setFormLoading(signupForm, false);
        return;
      }

      // Success
      showToast('Signup successful! Check your email for verification.');
      authMessage.textContent = '';
      signupForm.reset();
      setFormLoading(signupForm, false);
      speak('Welcome to LiyX! Thanks for joining the revolution.');

      // Optionally redirect or pre-populate profile ‚Äî for now we stay on page
    });

    /* --------------------------
       Login flow (keeps IDs)
       -------------------------- */
    loginForm?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      authMessage.textContent = 'Logging in...';
      setFormLoading(loginForm, true);

      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showToast('Please enter email and password', 'error');
        setFormLoading(loginForm, false);
        return;
      }

      const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email, password });
      if (loginError || !loginData?.user) {
        showToast('Login error: ' + (loginError?.message || 'Invalid credentials'), 'error');
        setFormLoading(loginForm, false);
        return;
      }

      const userId = loginData.user.id;
      // fetch user role and name from custom table
      const { data: userDetails, error: fetchError } = await supabase
        .from('users')
        .select('role, name, is_active')
        .eq('id', userId)
        .single();

      if (fetchError || !userDetails) {
        showToast('Error fetching user data', 'error');
        setFormLoading(loginForm, false);
        return;
      }

      if (userDetails.is_active === false) {
        showToast('Account deactivated. Contact support.', 'error');
        setFormLoading(loginForm, false);
        return;
      }

      // cache profile
      cacheProfile({ id: userId, email: loginData.user.email, name: userDetails.name, role: userDetails.role });
      showToast(`Welcome back, ${userDetails.name || ''}!`);
      speak(`Welcome back ${userDetails.name || 'friend'}`);

      // Update last_login (best done server-side via RPC; client will attempt a lightweight update)
      try {
        await supabase.from('users').update({ last_login: new Date() }).eq('id', userId);
      } catch (e) { console.warn('Failed to update last_login', e); }

      // Redirect based on role (client-side redirect; ensure server-side protections)
      setTimeout(() => {
        if (userDetails.role === 'admin') {
          window.location.href = '/admin/dashboard.html';
        } else {
          window.location.href = `/user/profile.html?id=${userId}`;
        }
      }, 900);
    });

    /* --------------------------
       Forgot password flow
       -------------------------- */
    forgotForm?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      setFormLoading(forgotForm, true);
      const email = document.getElementById('forgot-email').value.trim();
      if (!email) {
        showToast('Please enter your email', 'error');
        setFormLoading(forgotForm, false);
        return;
      }
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if (error) showToast(error.message, 'error');
      else showToast('Reset link sent to your email');
      setFormLoading(forgotForm, false);
    });

    /* --------------------------
       Phone verify placeholder
       - For phone verification via Supabase you can use otp (signInWithOtp).
       - Many flows require a separate phone-first sign-up; mixing both (email+password and phone otp)
         needs server-side decisions. Below we provide a helper to start phone OTP flow.
       -------------------------- */

    document.getElementById('signup-verify-phone').addEventListener('click', async () => {
      const phone = document.getElementById('signup-phone').value.trim();
      if (!phone) {
        showToast('Enter phone first to verify', 'error');
        return;
      }
      // Start OTP sign-in flow. Note: This expects phone auth enabled in Supabase.
      const { data, error } = await supabase.auth.signInWithOtp({ phone });
      if (error) {
        showToast('Phone OTP error: ' + error.message, 'error');
      } else {
        showToast('OTP sent to ' + phone + '. Complete verification on your device.');
      }
    });

    /* --------------------------
       On-load: attempt to prefill forms from cache
       -------------------------- */
    (function initFromCache(){
      const profile = getCachedProfile();
      if (profile?.email) document.getElementById('login-email').value = profile.email;
    })();

    /* --------------------------
       Final UX tweak: if page loaded with ?ref=..., prefill referral field
       -------------------------- */
    (function handleRefParam(){
      const params = new URLSearchParams(window.location.search);
      const r = params.get('ref');
      if (r) {
        const el = document.getElementById('signup-referral');
        if (el) el.value = r;
      }
    })();

  </script>


</body>
</html>
